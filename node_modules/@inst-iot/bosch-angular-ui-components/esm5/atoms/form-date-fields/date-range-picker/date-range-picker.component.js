import * as tslib_1 from "tslib";
import { Component, ElementRef, forwardRef, Inject, Input, Optional, Renderer2, ViewChild } from '@angular/core';
import flatpickr, * as flatpickrImport from 'flatpickr';
import { emptyFunction } from '../../form-fields/forms-util';
import { FLATPICKR_DEFAULT_OPTIONS } from '../form-date-input/form-date-input.component';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { isAbsolute, isRelative } from './date-range-picker.model';
var flatpickrFunc = flatpickrImport; // workaround for rollup and tests
var overridableOptions = {
    time_24hr: true,
};
var enforcedOptions = {
    inline: true,
    mode: 'single'
};
var DateRangePickerComponent = /** @class */ (function () {
    function DateRangePickerComponent(renderer, elementRef, defaultOptions) {
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.defaultOptions = defaultOptions;
        this.allowRelative = false;
        this.presets = [];
        this.startLabel = 'Start';
        this.endLabel = 'End';
        this.absoluteLabel = 'Absolute';
        this.relativeLabel = 'Relative';
        this.presetsLabel = 'Presets';
        this.tab = 'absolute';
        this.mode = 'absolute';
        /**
         * Options for Flatpickr
         * @see https://flatpickr.js.org/options/
         */
        this.options = {};
        this.onChange = emptyFunction;
        this.onTouched = emptyFunction;
        this.absoluteValue = null;
        this.initialTabChange = true;
        this.relativeValue = null;
        this.lastModified = null;
    }
    DateRangePickerComponent_1 = DateRangePickerComponent;
    DateRangePickerComponent.prototype.ngOnInit = function () {
        if (this.defaultOptions) {
            this.options = tslib_1.__assign({}, overridableOptions, this.defaultOptions, this.options, enforcedOptions);
        }
        else {
            this.options = tslib_1.__assign({}, overridableOptions, this.options, enforcedOptions);
        }
    };
    DateRangePickerComponent.prototype.ngOnDestroy = function () {
        if (this.pickerStart) {
            this.pickerStart.destroy();
        }
        if (this.pickerEnd) {
            this.pickerEnd.destroy();
        }
    };
    Object.defineProperty(DateRangePickerComponent.prototype, "initStartDateElement", {
        set: function (el) {
            var _this = this;
            if (!el || el.nativeElement._flatpickr) {
                return;
            }
            var startOptions = tslib_1.__assign({}, this.options, { onValueUpdate: function (selectedDates) {
                    var start = toISOString(selectedDates[0]);
                    _this.pickerEnd.set('minDate', selectedDates[0]);
                    var end = toISOString(_this.pickerEnd.selectedDates[0]);
                    _this.updateAbsoluteValueFromPicker([start, end]);
                } });
            this.pickerStart = flatpickrFunc(el.nativeElement, startOptions);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DateRangePickerComponent.prototype, "initEndDateElement", {
        set: function (el) {
            var _this = this;
            if (!el || el.nativeElement._flatpickr) {
                return;
            }
            var endOptions = tslib_1.__assign({}, this.options, { onValueUpdate: function (selectedDates) {
                    var start = toISOString(_this.pickerStart.selectedDates[0]);
                    var end = toISOString(selectedDates[0]);
                    _this.updateAbsoluteValueFromPicker([start, end]);
                } });
            this.pickerEnd = flatpickrFunc(el.nativeElement, endOptions);
            this.updatePicker();
        },
        enumerable: true,
        configurable: true
    });
    DateRangePickerComponent.prototype.tabChanged = function (tabId) {
        if (this.initialTabChange || this.tab === tabId) {
            this.initialTabChange = false;
            return;
        }
        this.tab = tabId;
        if (tabId === 'absolute') {
            this.mode = 'absolute';
            this.notifyChange(this.absoluteValue);
        }
        if (tabId === 'relative') {
            this.mode = 'relative';
            this.notifyChange(this.relativeValue);
        }
        if (tabId === 'preset') {
        }
    };
    DateRangePickerComponent.prototype.updateAbsoluteValueFromPicker = function (value) {
        if (this.tab !== 'absolute'
            || this.absoluteValue && this.absoluteValue[0] === value[0] && this.absoluteValue[1] === value[1]) {
            return;
        }
        this.absoluteValue = value;
        this.relativeValue = this.getRelativeFromAbsolute(value);
        this.notifyChange(value);
    };
    DateRangePickerComponent.prototype.updateRelativeValue = function (value, index) {
        if (index === 0) {
            this.relativeValue = [value, this.relativeValue[1]];
        }
        if (index === 1) {
            this.relativeValue = [this.relativeValue[0], value];
        }
        this.absoluteValue = getAbsoluteFromRelative(this.relativeValue);
        this.updatePicker();
        this.notifyChange(this.relativeValue);
    };
    DateRangePickerComponent.prototype.notifyChange = function (value) {
        if (value === this.lastModified || isEqual(value, this.lastModified)) {
            return;
        }
        this.lastModified = value;
        this.onChange(value);
    };
    DateRangePickerComponent.prototype.writeValue = function (value) {
        if (this.allowRelative && isRelative(value)) {
            this.mode = 'relative';
            this.tab = 'relative';
            this.relativeValue = value;
            this.absoluteValue = getAbsoluteFromRelative(this.relativeValue);
            if (this.findPreset(this.relativeValue)) {
                this.tab = 'preset';
            }
        }
        else if (isAbsolute(value)) {
            this.mode = 'absolute';
            this.tab = 'absolute';
            this.relativeValue = this.getRelativeFromAbsolute(value);
            this.absoluteValue = value;
            if (this.findPreset(this.absoluteValue)) {
                this.tab = 'preset';
            }
        }
        this.lastModified = value;
        this.updatePicker();
    };
    DateRangePickerComponent.prototype.updatePicker = function () {
        var value = this.absoluteValue;
        if (!value) {
            return;
        }
        if (this.pickerStart && this.pickerStart.config) {
            this.pickerStart.setDate(value[0]);
        }
        if (this.pickerEnd && this.pickerEnd.config) {
            this.pickerEnd.setDate(value[1]);
            this.pickerEnd.set('minDate', value[0]);
        }
    };
    DateRangePickerComponent.prototype.registerOnChange = function (fn) {
        this.onChange = fn;
    };
    DateRangePickerComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    DateRangePickerComponent.prototype.setDisabledState = function (isDisabled) {
        // this.renderer.setProperty(this.input.nativeElement, 'disabled', isDisabled);
    };
    DateRangePickerComponent.prototype.findPreset = function (value) {
        if (!this.presets) {
            return null;
        }
        if (isAbsolute(value)) {
            return this.presets.filter(function (p) { return p.absoluteRange; }).find(function (p) { return isEqual(p.absoluteRange, value); });
        }
        else if (isRelative(value)) {
            return this.presets.filter(function (p) { return p.relativeRange; }).find(function (p) { return isEqual(p.relativeRange, value); });
        }
    };
    DateRangePickerComponent.prototype.isPreset = function (p) {
        return p.absoluteRange && this.absoluteValue && isEqual(this.absoluteValue, p.absoluteRange)
            || p.relativeRange && this.relativeValue && isEqual(this.relativeValue, p.relativeRange);
    };
    DateRangePickerComponent.prototype.setPreset = function (preset) {
        if (preset.relativeRange) {
            this.relativeValue = preset.relativeRange;
            this.absoluteValue = getAbsoluteFromRelative(this.relativeValue);
            // this.tab = 'relative';
            this.updatePicker();
            this.notifyChange(this.relativeValue);
        }
        if (preset.absoluteRange) {
            this.absoluteValue = preset.absoluteRange;
            this.relativeValue = this.getRelativeFromAbsolute(this.absoluteValue);
            // this.tab = 'absolute';
            this.updatePicker();
            this.notifyChange(this.absoluteValue);
        }
    };
    DateRangePickerComponent.prototype.getRelativeFromAbsolute = function (value, byDay) {
        if (byDay === void 0) { byDay = false; }
        var hf = this.options.enableTime && !byDay ? 60 * 60 * 1000 : 24 * 60 * 60 * 1000;
        var now = Math.floor(new Date().getTime() / hf) * hf;
        var start = Math.floor(new Date(value[0]).getTime() / hf) * hf;
        var end = Math.floor(new Date(value[1]).getTime() / hf) * hf;
        if (!byDay && Math.abs((start - now) / hf) > 48) {
            return this.getRelativeFromAbsolute(value, true);
        }
        return [start - now, end - now];
    };
    var DateRangePickerComponent_1;
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "name", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "readonly", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "allowRelative", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Array)
    ], DateRangePickerComponent.prototype, "presets", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "startLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "endLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "absoluteLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "relativeLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "presetsLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], DateRangePickerComponent.prototype, "options", void 0);
    tslib_1.__decorate([
        ViewChild('startDate', { static: false }),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], DateRangePickerComponent.prototype, "initStartDateElement", null);
    tslib_1.__decorate([
        ViewChild('endDate', { static: false }),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], DateRangePickerComponent.prototype, "initEndDateElement", null);
    DateRangePickerComponent = DateRangePickerComponent_1 = tslib_1.__decorate([
        Component({
            selector: 'rb-date-range-picker',
            template: "<rb-tab-panel [renderHiddenTabs]=\"true\" (tabChanged)=\"tabChanged($event)\" [tab]=\"tab\">\r\n  <div *rbTabPanelItem=\"absoluteLabel; id: 'absolute'\" class=\"picker-calendars\">\r\n    <div class=\"startDate\" #startDate></div>\r\n    <div class=\"endDate\" #endDate></div>\r\n  </div>\r\n  <ng-container *ngIf=\"allowRelative\">\r\n    <div *rbTabPanelItem=\"relativeLabel; id: 'relative'\" class=\"picker-relative\">\r\n      <ng-container *ngIf=\"relativeValue\">\r\n        <rb-form-relative-time-input [label]=\"startLabel\" [ngModel]=\"relativeValue[0]\"\r\n                                     (ngModelChange)=\"updateRelativeValue($event, 0)\"></rb-form-relative-time-input>\r\n        <rb-form-relative-time-input [label]=\"endLabel\" [ngModel]=\"relativeValue[1]\"\r\n                                     (ngModelChange)=\"updateRelativeValue($event, 1)\"></rb-form-relative-time-input>\r\n      </ng-container>\r\n\r\n    </div>\r\n  </ng-container>\r\n  <ng-container *ngIf=\"presets?.length\">\r\n    <div *rbTabPanelItem=\"presetsLabel; id: 'preset'\">\r\n      <div *ngFor=\"let p of presets\">\r\n        <ng-container *ngIf=\"allowRelative && p.relativeRange || p.absoluteRange\">\r\n          <a href=\"javascript:\" class=\"rb-dropdown-item\" [class.active]=\"isPreset(p)\" (click)=\"setPreset(p)\">{{p.label}}</a>\r\n        </ng-container>\r\n      </div>\r\n    </div>\r\n  </ng-container>\r\n</rb-tab-panel>\r\n",
            providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(function () { return DateRangePickerComponent_1; }), multi: true }]
        }),
        tslib_1.__param(2, Optional()), tslib_1.__param(2, Inject(FLATPICKR_DEFAULT_OPTIONS)),
        tslib_1.__metadata("design:paramtypes", [Renderer2,
            ElementRef, Object])
    ], DateRangePickerComponent);
    return DateRangePickerComponent;
}());
export { DateRangePickerComponent };
function toISOString(data) {
    if (typeof data === 'string' || typeof data === 'number') {
        return new Date(data).toISOString();
    }
    else if (data instanceof Date) {
        return data.toISOString();
    }
    return '';
}
function getAbsoluteFromRelative(value) {
    var now = new Date().getTime();
    var start = toISOString(now + value[0]);
    var end = toISOString(now + value[1]);
    return [start, end];
}
function isEqual(value1, value2) {
    return value1 === value2 || value1[0] === value2[0] && value1[1] === value2[1];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1yYW5nZS1waWNrZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGluc3QtaW90L2Jvc2NoLWFuZ3VsYXItdWktY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImF0b21zL2Zvcm0tZGF0ZS1maWVsZHMvZGF0ZS1yYW5nZS1waWNrZXIvZGF0ZS1yYW5nZS1waWNrZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFVBQVUsRUFDVixVQUFVLEVBQ1YsTUFBTSxFQUNOLEtBQUssRUFHTCxRQUFRLEVBQ1IsU0FBUyxFQUVULFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLFNBQVMsRUFBRSxLQUFLLGVBQWUsTUFBTSxXQUFXLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzdELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQ3pGLE9BQU8sRUFBd0IsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBR0wsVUFBVSxFQUNWLFVBQVUsRUFJWCxNQUFNLDJCQUEyQixDQUFDO0FBRW5DLElBQU0sYUFBYSxHQUFHLGVBQWtDLENBQUMsQ0FBQyxrQ0FBa0M7QUFHNUYsSUFBTSxrQkFBa0IsR0FBOEI7SUFDcEQsU0FBUyxFQUFFLElBQUk7Q0FDaEIsQ0FBQztBQUVGLElBQU0sZUFBZSxHQUE4QjtJQUNqRCxNQUFNLEVBQUUsSUFBSTtJQUNaLElBQUksRUFBRSxRQUFRO0NBQ2YsQ0FBQztBQU9GO0lBdUNFLGtDQUFvQixRQUFtQixFQUNuQixVQUFzQixFQUN5QixjQUFtQjtRQUZsRSxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDeUIsbUJBQWMsR0FBZCxjQUFjLENBQUs7UUFuQzdFLGtCQUFhLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLFlB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QUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2pDLElBQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEdBQUksS0FBSyxDQUFDLENBQUMsQ0FBWSxDQUFDLENBQUM7SUFDdEQsSUFBTSxHQUFHLEdBQUcsV0FBVyxDQUFDLEdBQUcsR0FBSSxLQUFLLENBQUMsQ0FBQyxDQUFZLENBQUMsQ0FBQztJQUNwRCxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLENBQUM7QUFHRCxTQUFTLE9BQU8sQ0FBQyxNQUFtQixFQUFFLE1BQW1CO0lBQ3ZELE9BQU8sTUFBTSxLQUFLLE1BQU0sSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDakYsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQ29tcG9uZW50LFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgZm9yd2FyZFJlZixcclxuICBJbmplY3QsXHJcbiAgSW5wdXQsXHJcbiAgT25EZXN0cm95LFxyXG4gIE9uSW5pdCxcclxuICBPcHRpb25hbCxcclxuICBSZW5kZXJlcjIsXHJcbiAgVGVtcGxhdGVSZWYsXHJcbiAgVmlld0NoaWxkXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCBmbGF0cGlja3IsICogYXMgZmxhdHBpY2tySW1wb3J0IGZyb20gJ2ZsYXRwaWNrcic7XHJcbmltcG9ydCB7IGVtcHR5RnVuY3Rpb24gfSBmcm9tICcuLi8uLi9mb3JtLWZpZWxkcy9mb3Jtcy11dGlsJztcclxuaW1wb3J0IHsgRkxBVFBJQ0tSX0RFRkFVTFRfT1BUSU9OUyB9IGZyb20gJy4uL2Zvcm0tZGF0ZS1pbnB1dC9mb3JtLWRhdGUtaW5wdXQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQge1xyXG4gIEFic29sdXRlUGlja2VyVmFsdWUsXHJcbiAgRGF0ZVJhbmdlUGlja2VyUHJlc2V0LFxyXG4gIGlzQWJzb2x1dGUsXHJcbiAgaXNSZWxhdGl2ZSxcclxuICBQaWNrZXJNb2RlLFxyXG4gIFBpY2tlclZhbHVlLFxyXG4gIFJlbGF0aXZlUGlja2VyVmFsdWVcclxufSBmcm9tICcuL2RhdGUtcmFuZ2UtcGlja2VyLm1vZGVsJztcclxuXHJcbmNvbnN0IGZsYXRwaWNrckZ1bmMgPSBmbGF0cGlja3JJbXBvcnQgYXMgYW55IGFzIEZ1bmN0aW9uOyAvLyB3b3JrYXJvdW5kIGZvciByb2xsdXAgYW5kIHRlc3RzXHJcblxyXG5cclxuY29uc3Qgb3ZlcnJpZGFibGVPcHRpb25zOiBmbGF0cGlja3IuT3B0aW9ucy5PcHRpb25zID0ge1xyXG4gIHRpbWVfMjRocjogdHJ1ZSxcclxufTtcclxuXHJcbmNvbnN0IGVuZm9yY2VkT3B0aW9uczogZmxhdHBpY2tyLk9wdGlvbnMuT3B0aW9ucyA9IHtcclxuICBpbmxpbmU6IHRydWUsXHJcbiAgbW9kZTogJ3NpbmdsZSdcclxufTtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncmItZGF0ZS1yYW5nZS1waWNrZXInLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9kYXRlLXJhbmdlLXBpY2tlci5jb21wb25lbnQuaHRtbCcsXHJcbiAgcHJvdmlkZXJzOiBbe3Byb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLCB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBEYXRlUmFuZ2VQaWNrZXJDb21wb25lbnQpLCBtdWx0aTogdHJ1ZX1dLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRGF0ZVJhbmdlUGlja2VyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIENvbnRyb2xWYWx1ZUFjY2Vzc29yIHtcclxuXHJcbiAgQElucHV0KCkgbmFtZTtcclxuXHJcbiAgQElucHV0KCkgcmVhZG9ubHk7XHJcblxyXG4gIEBJbnB1dCgpIGFsbG93UmVsYXRpdmUgPSBmYWxzZTtcclxuICBASW5wdXQoKSBwcmVzZXRzOiBEYXRlUmFuZ2VQaWNrZXJQcmVzZXRbXSA9IFtdO1xyXG5cclxuICBASW5wdXQoKSBzdGFydExhYmVsOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+ID0gJ1N0YXJ0JztcclxuICBASW5wdXQoKSBlbmRMYWJlbDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9ICdFbmQnO1xyXG4gIEBJbnB1dCgpIGFic29sdXRlTGFiZWw6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gPSAnQWJzb2x1dGUnO1xyXG4gIEBJbnB1dCgpIHJlbGF0aXZlTGFiZWw6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gPSAnUmVsYXRpdmUnO1xyXG4gIEBJbnB1dCgpIHByZXNldHNMYWJlbDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9ICdQcmVzZXRzJztcclxuXHJcbiAgdGFiID0gJ2Fic29sdXRlJztcclxuXHJcbiAgbW9kZTogUGlja2VyTW9kZSA9ICdhYnNvbHV0ZSc7XHJcblxyXG4gIHByaXZhdGUgcGlja2VyU3RhcnQ6IGZsYXRwaWNrci5JbnN0YW5jZTtcclxuICBwcml2YXRlIHBpY2tlckVuZDogZmxhdHBpY2tyLkluc3RhbmNlO1xyXG5cclxuICAvKipcclxuICAgKiBPcHRpb25zIGZvciBGbGF0cGlja3JcclxuICAgKiBAc2VlIGh0dHBzOi8vZmxhdHBpY2tyLmpzLm9yZy9vcHRpb25zL1xyXG4gICAqL1xyXG4gIEBJbnB1dCgpIG9wdGlvbnM6IGZsYXRwaWNrci5PcHRpb25zLk9wdGlvbnMgPSB7fTtcclxuXHJcbiAgcHJpdmF0ZSBvbkNoYW5nZSA9IGVtcHR5RnVuY3Rpb247XHJcbiAgcHJpdmF0ZSBvblRvdWNoZWQgPSBlbXB0eUZ1bmN0aW9uO1xyXG5cclxuICBwcml2YXRlIGFic29sdXRlVmFsdWU6IEFic29sdXRlUGlja2VyVmFsdWUgPSBudWxsO1xyXG5cclxuICBwcml2YXRlIGluaXRpYWxUYWJDaGFuZ2UgPSB0cnVlO1xyXG5cclxuICByZWxhdGl2ZVZhbHVlOiBSZWxhdGl2ZVBpY2tlclZhbHVlID0gbnVsbDtcclxuXHJcbiAgcHJpdmF0ZSBsYXN0TW9kaWZpZWQgPSBudWxsO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoRkxBVFBJQ0tSX0RFRkFVTFRfT1BUSU9OUykgcHJpdmF0ZSBkZWZhdWx0T3B0aW9uczogYW55KSB7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmRlZmF1bHRPcHRpb25zKSB7XHJcbiAgICAgIHRoaXMub3B0aW9ucyA9IHtcclxuICAgICAgICAuLi5vdmVycmlkYWJsZU9wdGlvbnMsXHJcbiAgICAgICAgLi4udGhpcy5kZWZhdWx0T3B0aW9ucyxcclxuICAgICAgICAuLi50aGlzLm9wdGlvbnMsXHJcbiAgICAgICAgLi4uZW5mb3JjZWRPcHRpb25zXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLm9wdGlvbnMgPSB7XHJcbiAgICAgICAgLi4ub3ZlcnJpZGFibGVPcHRpb25zLFxyXG4gICAgICAgIC4uLnRoaXMub3B0aW9ucyxcclxuICAgICAgICAuLi5lbmZvcmNlZE9wdGlvbnNcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMucGlja2VyU3RhcnQpIHtcclxuICAgICAgdGhpcy5waWNrZXJTdGFydC5kZXN0cm95KCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5waWNrZXJFbmQpIHtcclxuICAgICAgdGhpcy5waWNrZXJFbmQuZGVzdHJveSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgQFZpZXdDaGlsZCgnc3RhcnREYXRlJywge3N0YXRpYzogZmFsc2V9KSBzZXQgaW5pdFN0YXJ0RGF0ZUVsZW1lbnQoZWwpIHtcclxuICAgIGlmICghZWwgfHwgZWwubmF0aXZlRWxlbWVudC5fZmxhdHBpY2tyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHN0YXJ0T3B0aW9ucyA9IHtcclxuICAgICAgLi4udGhpcy5vcHRpb25zLFxyXG4gICAgICBvblZhbHVlVXBkYXRlOiAoc2VsZWN0ZWREYXRlczogRGF0ZVtdKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc3RhcnQgPSB0b0lTT1N0cmluZyhzZWxlY3RlZERhdGVzWzBdKTtcclxuICAgICAgICB0aGlzLnBpY2tlckVuZC5zZXQoJ21pbkRhdGUnLCBzZWxlY3RlZERhdGVzWzBdKTtcclxuICAgICAgICBjb25zdCBlbmQgPSB0b0lTT1N0cmluZyh0aGlzLnBpY2tlckVuZC5zZWxlY3RlZERhdGVzWzBdKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZUFic29sdXRlVmFsdWVGcm9tUGlja2VyKFtzdGFydCwgZW5kXSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB0aGlzLnBpY2tlclN0YXJ0ID0gZmxhdHBpY2tyRnVuYyhlbC5uYXRpdmVFbGVtZW50LCBzdGFydE9wdGlvbnMpIGFzIGZsYXRwaWNrci5JbnN0YW5jZTtcclxuICB9XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ2VuZERhdGUnLCB7c3RhdGljOiBmYWxzZX0pIHNldCBpbml0RW5kRGF0ZUVsZW1lbnQoZWwpIHtcclxuICAgIGlmICghZWwgfHwgZWwubmF0aXZlRWxlbWVudC5fZmxhdHBpY2tyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGVuZE9wdGlvbnMgPSB7XHJcbiAgICAgIC4uLnRoaXMub3B0aW9ucyxcclxuICAgICAgb25WYWx1ZVVwZGF0ZTogKHNlbGVjdGVkRGF0ZXM6IERhdGVbXSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gdG9JU09TdHJpbmcodGhpcy5waWNrZXJTdGFydC5zZWxlY3RlZERhdGVzWzBdKTtcclxuICAgICAgICBjb25zdCBlbmQgPSB0b0lTT1N0cmluZyhzZWxlY3RlZERhdGVzWzBdKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZUFic29sdXRlVmFsdWVGcm9tUGlja2VyKFtzdGFydCwgZW5kXSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB0aGlzLnBpY2tlckVuZCA9IGZsYXRwaWNrckZ1bmMoZWwubmF0aXZlRWxlbWVudCwgZW5kT3B0aW9ucykgYXMgZmxhdHBpY2tyLkluc3RhbmNlO1xyXG4gICAgdGhpcy51cGRhdGVQaWNrZXIoKTtcclxuICB9XHJcblxyXG4gIHRhYkNoYW5nZWQodGFiSWQ6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMuaW5pdGlhbFRhYkNoYW5nZSB8fCB0aGlzLnRhYiA9PT0gdGFiSWQpIHtcclxuICAgICAgdGhpcy5pbml0aWFsVGFiQ2hhbmdlID0gZmFsc2U7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMudGFiID0gdGFiSWQ7XHJcbiAgICBpZiAodGFiSWQgPT09ICdhYnNvbHV0ZScpIHtcclxuICAgICAgdGhpcy5tb2RlID0gJ2Fic29sdXRlJztcclxuICAgICAgdGhpcy5ub3RpZnlDaGFuZ2UodGhpcy5hYnNvbHV0ZVZhbHVlKTtcclxuICAgIH1cclxuICAgIGlmICh0YWJJZCA9PT0gJ3JlbGF0aXZlJykge1xyXG4gICAgICB0aGlzLm1vZGUgPSAncmVsYXRpdmUnO1xyXG4gICAgICB0aGlzLm5vdGlmeUNoYW5nZSh0aGlzLnJlbGF0aXZlVmFsdWUpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRhYklkID09PSAncHJlc2V0Jykge1xyXG5cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVwZGF0ZUFic29sdXRlVmFsdWVGcm9tUGlja2VyKHZhbHVlOiBBYnNvbHV0ZVBpY2tlclZhbHVlKSB7XHJcbiAgICBpZiAodGhpcy50YWIgIT09ICdhYnNvbHV0ZSdcclxuICAgICAgfHwgdGhpcy5hYnNvbHV0ZVZhbHVlICYmIHRoaXMuYWJzb2x1dGVWYWx1ZVswXSA9PT0gdmFsdWVbMF0gJiYgdGhpcy5hYnNvbHV0ZVZhbHVlWzFdID09PSB2YWx1ZVsxXSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmFic29sdXRlVmFsdWUgPSB2YWx1ZTtcclxuICAgIHRoaXMucmVsYXRpdmVWYWx1ZSA9IHRoaXMuZ2V0UmVsYXRpdmVGcm9tQWJzb2x1dGUodmFsdWUpO1xyXG4gICAgdGhpcy5ub3RpZnlDaGFuZ2UodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlUmVsYXRpdmVWYWx1ZSh2YWx1ZSwgaW5kZXgpIHtcclxuICAgIGlmIChpbmRleCA9PT0gMCkge1xyXG4gICAgICB0aGlzLnJlbGF0aXZlVmFsdWUgPSBbdmFsdWUsIHRoaXMucmVsYXRpdmVWYWx1ZVsxXV07XHJcbiAgICB9XHJcbiAgICBpZiAoaW5kZXggPT09IDEpIHtcclxuICAgICAgdGhpcy5yZWxhdGl2ZVZhbHVlID0gW3RoaXMucmVsYXRpdmVWYWx1ZVswXSwgdmFsdWVdO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYWJzb2x1dGVWYWx1ZSA9IGdldEFic29sdXRlRnJvbVJlbGF0aXZlKHRoaXMucmVsYXRpdmVWYWx1ZSk7XHJcbiAgICB0aGlzLnVwZGF0ZVBpY2tlcigpO1xyXG4gICAgdGhpcy5ub3RpZnlDaGFuZ2UodGhpcy5yZWxhdGl2ZVZhbHVlKTtcclxuICB9XHJcblxyXG4gIG5vdGlmeUNoYW5nZSh2YWx1ZSkge1xyXG4gICAgaWYgKHZhbHVlID09PSB0aGlzLmxhc3RNb2RpZmllZCB8fCBpc0VxdWFsKHZhbHVlLCB0aGlzLmxhc3RNb2RpZmllZCkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5sYXN0TW9kaWZpZWQgPSB2YWx1ZTtcclxuICAgIHRoaXMub25DaGFuZ2UodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgd3JpdGVWYWx1ZSh2YWx1ZTogUGlja2VyVmFsdWUpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmFsbG93UmVsYXRpdmUgJiYgaXNSZWxhdGl2ZSh2YWx1ZSkpIHtcclxuICAgICAgdGhpcy5tb2RlID0gJ3JlbGF0aXZlJztcclxuICAgICAgdGhpcy50YWIgPSAncmVsYXRpdmUnO1xyXG4gICAgICB0aGlzLnJlbGF0aXZlVmFsdWUgPSB2YWx1ZSBhcyBSZWxhdGl2ZVBpY2tlclZhbHVlO1xyXG4gICAgICB0aGlzLmFic29sdXRlVmFsdWUgPSBnZXRBYnNvbHV0ZUZyb21SZWxhdGl2ZSh0aGlzLnJlbGF0aXZlVmFsdWUpO1xyXG4gICAgICBpZiAodGhpcy5maW5kUHJlc2V0KHRoaXMucmVsYXRpdmVWYWx1ZSkpIHtcclxuICAgICAgICB0aGlzLnRhYiA9ICdwcmVzZXQnO1xyXG4gICAgICB9XHJcblxyXG4gICAgfSBlbHNlIGlmIChpc0Fic29sdXRlKHZhbHVlKSkge1xyXG4gICAgICB0aGlzLm1vZGUgPSAnYWJzb2x1dGUnO1xyXG4gICAgICB0aGlzLnRhYiA9ICdhYnNvbHV0ZSc7XHJcbiAgICAgIHRoaXMucmVsYXRpdmVWYWx1ZSA9IHRoaXMuZ2V0UmVsYXRpdmVGcm9tQWJzb2x1dGUodmFsdWUgYXMgQWJzb2x1dGVQaWNrZXJWYWx1ZSk7XHJcbiAgICAgIHRoaXMuYWJzb2x1dGVWYWx1ZSA9IHZhbHVlIGFzIEFic29sdXRlUGlja2VyVmFsdWU7XHJcbiAgICAgIGlmICh0aGlzLmZpbmRQcmVzZXQodGhpcy5hYnNvbHV0ZVZhbHVlKSkge1xyXG4gICAgICAgIHRoaXMudGFiID0gJ3ByZXNldCc7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMubGFzdE1vZGlmaWVkID0gdmFsdWU7XHJcbiAgICB0aGlzLnVwZGF0ZVBpY2tlcigpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVQaWNrZXIoKSB7XHJcbiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuYWJzb2x1dGVWYWx1ZTtcclxuICAgIGlmICghdmFsdWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMucGlja2VyU3RhcnQgJiYgdGhpcy5waWNrZXJTdGFydC5jb25maWcpIHtcclxuICAgICAgdGhpcy5waWNrZXJTdGFydC5zZXREYXRlKHZhbHVlWzBdKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnBpY2tlckVuZCAmJiB0aGlzLnBpY2tlckVuZC5jb25maWcpIHtcclxuICAgICAgdGhpcy5waWNrZXJFbmQuc2V0RGF0ZSh2YWx1ZVsxXSk7XHJcbiAgICAgIHRoaXMucGlja2VyRW5kLnNldCgnbWluRGF0ZScsIHZhbHVlWzBdKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46IChfOiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB0aGlzLm9uVG91Y2hlZCA9IGZuO1xyXG4gIH1cclxuXHJcbiAgc2V0RGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICAvLyB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuaW5wdXQubmF0aXZlRWxlbWVudCwgJ2Rpc2FibGVkJywgaXNEaXNhYmxlZCk7XHJcbiAgfVxyXG5cclxuICBmaW5kUHJlc2V0KHZhbHVlOiBQaWNrZXJWYWx1ZSk6IERhdGVSYW5nZVBpY2tlclByZXNldCB7XHJcbiAgICBpZiAoIXRoaXMucHJlc2V0cykge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGlmIChpc0Fic29sdXRlKHZhbHVlKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5wcmVzZXRzLmZpbHRlcihwID0+IHAuYWJzb2x1dGVSYW5nZSkuZmluZChwID0+IGlzRXF1YWwocC5hYnNvbHV0ZVJhbmdlLCB2YWx1ZSkpO1xyXG4gICAgfSBlbHNlIGlmIChpc1JlbGF0aXZlKHZhbHVlKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5wcmVzZXRzLmZpbHRlcihwID0+IHAucmVsYXRpdmVSYW5nZSkuZmluZChwID0+IGlzRXF1YWwocC5yZWxhdGl2ZVJhbmdlLCB2YWx1ZSkpO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIGlzUHJlc2V0KHA6IERhdGVSYW5nZVBpY2tlclByZXNldCkge1xyXG4gICAgcmV0dXJuIHAuYWJzb2x1dGVSYW5nZSAmJiB0aGlzLmFic29sdXRlVmFsdWUgJiYgaXNFcXVhbCh0aGlzLmFic29sdXRlVmFsdWUsIHAuYWJzb2x1dGVSYW5nZSlcclxuICAgICAgfHwgcC5yZWxhdGl2ZVJhbmdlICYmIHRoaXMucmVsYXRpdmVWYWx1ZSAmJiBpc0VxdWFsKHRoaXMucmVsYXRpdmVWYWx1ZSwgcC5yZWxhdGl2ZVJhbmdlKTtcclxuICB9XHJcblxyXG4gIHNldFByZXNldChwcmVzZXQ6IERhdGVSYW5nZVBpY2tlclByZXNldCkge1xyXG4gICAgaWYgKHByZXNldC5yZWxhdGl2ZVJhbmdlKSB7XHJcbiAgICAgIHRoaXMucmVsYXRpdmVWYWx1ZSA9IHByZXNldC5yZWxhdGl2ZVJhbmdlO1xyXG4gICAgICB0aGlzLmFic29sdXRlVmFsdWUgPSBnZXRBYnNvbHV0ZUZyb21SZWxhdGl2ZSh0aGlzLnJlbGF0aXZlVmFsdWUpO1xyXG4gICAgICAvLyB0aGlzLnRhYiA9ICdyZWxhdGl2ZSc7XHJcbiAgICAgIHRoaXMudXBkYXRlUGlja2VyKCk7XHJcbiAgICAgIHRoaXMubm90aWZ5Q2hhbmdlKHRoaXMucmVsYXRpdmVWYWx1ZSk7XHJcbiAgICB9XHJcbiAgICBpZiAocHJlc2V0LmFic29sdXRlUmFuZ2UpIHtcclxuICAgICAgdGhpcy5hYnNvbHV0ZVZhbHVlID0gcHJlc2V0LmFic29sdXRlUmFuZ2U7XHJcbiAgICAgIHRoaXMucmVsYXRpdmVWYWx1ZSA9IHRoaXMuZ2V0UmVsYXRpdmVGcm9tQWJzb2x1dGUodGhpcy5hYnNvbHV0ZVZhbHVlKTtcclxuICAgICAgLy8gdGhpcy50YWIgPSAnYWJzb2x1dGUnO1xyXG4gICAgICB0aGlzLnVwZGF0ZVBpY2tlcigpO1xyXG4gICAgICB0aGlzLm5vdGlmeUNoYW5nZSh0aGlzLmFic29sdXRlVmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0UmVsYXRpdmVGcm9tQWJzb2x1dGUodmFsdWU6IEFic29sdXRlUGlja2VyVmFsdWUsIGJ5RGF5ID0gZmFsc2UpOiBSZWxhdGl2ZVBpY2tlclZhbHVlIHtcclxuICAgIGNvbnN0IGhmID0gdGhpcy5vcHRpb25zLmVuYWJsZVRpbWUgJiYgIWJ5RGF5ID8gNjAgKiA2MCAqIDEwMDAgOiAyNCAqIDYwICogNjAgKiAxMDAwO1xyXG4gICAgY29uc3Qgbm93ID0gTWF0aC5mbG9vcihuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIGhmKSAqIGhmO1xyXG4gICAgY29uc3Qgc3RhcnQgPSBNYXRoLmZsb29yKG5ldyBEYXRlKHZhbHVlWzBdKS5nZXRUaW1lKCkgLyBoZikgKiBoZjtcclxuICAgIGNvbnN0IGVuZCA9IE1hdGguZmxvb3IobmV3IERhdGUodmFsdWVbMV0pLmdldFRpbWUoKSAvIGhmKSAqIGhmO1xyXG4gICAgaWYgKCFieURheSAmJiBNYXRoLmFicygoc3RhcnQgLSBub3cpIC8gaGYpID4gNDgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVsYXRpdmVGcm9tQWJzb2x1dGUodmFsdWUsIHRydWUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIFtzdGFydCAtIG5vdywgZW5kIC0gbm93XTtcclxuICB9XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiB0b0lTT1N0cmluZyhkYXRhOiBzdHJpbmcgfCBudW1iZXIgfCBEYXRlKSB7XHJcbiAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgZGF0YSA9PT0gJ251bWJlcicpIHtcclxuICAgIHJldHVybiBuZXcgRGF0ZShkYXRhKS50b0lTT1N0cmluZygpO1xyXG4gIH0gZWxzZSBpZiAoZGF0YSBpbnN0YW5jZW9mIERhdGUpIHtcclxuICAgIHJldHVybiBkYXRhLnRvSVNPU3RyaW5nKCk7XHJcbiAgfVxyXG4gIHJldHVybiAnJztcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0QWJzb2x1dGVGcm9tUmVsYXRpdmUodmFsdWU6IFJlbGF0aXZlUGlja2VyVmFsdWUpOiBBYnNvbHV0ZVBpY2tlclZhbHVlIHtcclxuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcclxuICBjb25zdCBzdGFydCA9IHRvSVNPU3RyaW5nKG5vdyArICh2YWx1ZVswXSBhcyBudW1iZXIpKTtcclxuICBjb25zdCBlbmQgPSB0b0lTT1N0cmluZyhub3cgKyAodmFsdWVbMV0gYXMgbnVtYmVyKSk7XHJcbiAgcmV0dXJuIFtzdGFydCwgZW5kXTtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGlzRXF1YWwodmFsdWUxOiBQaWNrZXJWYWx1ZSwgdmFsdWUyOiBQaWNrZXJWYWx1ZSkge1xyXG4gIHJldHVybiB2YWx1ZTEgPT09IHZhbHVlMiB8fCB2YWx1ZTFbMF0gPT09IHZhbHVlMlswXSAmJiB2YWx1ZTFbMV0gPT09IHZhbHVlMlsxXTtcclxufVxyXG4iXX0=