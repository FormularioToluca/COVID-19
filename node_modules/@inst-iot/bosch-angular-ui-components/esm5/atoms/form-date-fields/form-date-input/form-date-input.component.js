import * as tslib_1 from "tslib";
import { Component, ContentChildren, ElementRef, forwardRef, Inject, InjectionToken, Input, Optional, QueryList, Renderer2, TemplateRef, ViewChild } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { FormValidationMessageDirective } from '../../form-fields/form-validation-message.directive';
import { emptyFunction } from '../../form-fields/forms-util';
import * as flatpickrImport from 'flatpickr';
var flatpickrFunc = flatpickrImport; // workaround for rollup and tests
export var FLATPICKR_DEFAULT_OPTIONS = new InjectionToken('flatpickrDefaultOptions');
var overridableOptions = {
    time_24hr: true
};
/**
 * Displays a input for flatpickr
 * The value, is a ISO Date String or an array of ISO Date Strings.
 */
var FormDateInputComponent = /** @class */ (function () {
    function FormDateInputComponent(renderer, elementRef, defaultOptions) {
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.defaultOptions = defaultOptions;
        this.label = null;
        this.type = 'text';
        this.id = 'input.' + Math.random();
        /**
         * Options for Flatpickr
         * @see https://flatpickr.js.org/options/
         */
        this.options = {};
        /**
         * Given, when this is the start date.
         * Start input is responsible for options
         */
        this.rangeEnd = null;
        this.onChange = emptyFunction;
        this.onTouched = emptyFunction;
    }
    FormDateInputComponent_1 = FormDateInputComponent;
    FormDateInputComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        if (this.defaultOptions) {
            this.options = tslib_1.__assign({}, overridableOptions, this.defaultOptions, this.options);
        }
        else {
            this.options = tslib_1.__assign({}, overridableOptions, this.options);
        }
        this.options.onValueUpdate = function (selectedDates, dateString) {
            _this.updateValue(selectedDates);
        };
        if (this.rangeEnd) {
            this.rangeEnd.options = tslib_1.__assign({}, this.options);
        }
        this.picker = flatpickrFunc(this.input.nativeElement, this.options);
    };
    FormDateInputComponent.prototype.ngOnChanges = function (changes) {
        var _this = this;
        if (changes.options && this.picker && changes.options.currentValue) {
            Object.keys(changes.options.currentValue).forEach(function (opt) {
                _this.picker.set(opt, changes.options.currentValue[opt]);
            });
        }
    };
    FormDateInputComponent.prototype.ngOnDestroy = function () {
        if (this.picker) {
            this.picker.destroy();
        }
    };
    FormDateInputComponent.prototype.isReadonly = function () {
        return this.readonly !== undefined;
    };
    FormDateInputComponent.prototype.updateValue = function (value) {
        if (this.picker.config.mode === 'single' && value && value.length) {
            value = value[0].toISOString();
        }
        if (['range', 'multiple'].indexOf(this.picker.config.mode) !== -1 && value && value.length) {
            value = value.map(function (v) { return v.toISOString(); });
        }
        this.checkValue(value);
        this.onChange(value);
        this.updateEndRange();
    };
    FormDateInputComponent.prototype.updateEndRange = function () {
        if (this.rangeEnd && this.picker.selectedDates[0]) {
            var start = this.picker.selectedDates[0];
            var end = this.rangeEnd.picker.selectedDates[0];
            this.rangeEnd.picker.set('minDate', this.picker.selectedDates[0]);
            if (start && end && end.getTime() < start.getTime()) {
                this.rangeEnd.writeValue(start.toISOString());
            }
        }
    };
    FormDateInputComponent.prototype.checkValue = function (value) {
        if (typeof (value) === 'string' && value.length > 0 || value && value.length) {
            this.renderer.addClass(this.elementRef.nativeElement, 'not-empty');
        }
        else {
            this.renderer.removeClass(this.elementRef.nativeElement, 'not-empty');
        }
    };
    FormDateInputComponent.prototype.isLabelTemplate = function () {
        return this.label instanceof TemplateRef;
    };
    FormDateInputComponent.prototype.writeValue = function (value) {
        if (value === null || value === undefined) {
            value = '';
        }
        this.checkValue(value);
        if (this.picker && this.picker.config) {
            this.picker.setDate(value);
        }
        this.updateEndRange();
        // this.renderer.setProperty(this.input.nativeElement, 'value', value);
    };
    FormDateInputComponent.prototype.registerOnChange = function (fn) {
        this.onChange = fn;
    };
    FormDateInputComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    FormDateInputComponent.prototype.setDisabledState = function (isDisabled) {
        this.renderer.setProperty(this.input.nativeElement, 'disabled', isDisabled);
    };
    FormDateInputComponent.prototype.toggle = function () {
        this.picker.toggle();
    };
    FormDateInputComponent.prototype.close = function () {
        this.picker.close();
    };
    var FormDateInputComponent_1;
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateInputComponent.prototype, "label", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], FormDateInputComponent.prototype, "name", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateInputComponent.prototype, "type", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateInputComponent.prototype, "readonly", void 0);
    tslib_1.__decorate([
        ContentChildren(FormValidationMessageDirective),
        tslib_1.__metadata("design:type", QueryList)
    ], FormDateInputComponent.prototype, "messages", void 0);
    tslib_1.__decorate([
        ViewChild('input', { static: true }),
        tslib_1.__metadata("design:type", ElementRef)
    ], FormDateInputComponent.prototype, "input", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateInputComponent.prototype, "options", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", FormDateInputComponent)
    ], FormDateInputComponent.prototype, "rangeEnd", void 0);
    FormDateInputComponent = FormDateInputComponent_1 = tslib_1.__decorate([
        Component({
            selector: 'rb-form-date-input',
            template: "<div class=\"input-wrapper\" [class.no-label]=\"!label\">\r\n\r\n  <input [type]=\"type\" [id]=\"id + 'input'\"\r\n         class=\"input with-icon\"\r\n         (blur)=\"onTouched()\"\r\n         [readonly]=\"isReadonly()\"\r\n         #input>\r\n  <span class=\"input-icon rb-ic rb-ic-calendar\" (click)=\"toggle()\"></span>\r\n  <label class=\"label\" [for]=\"id + 'input'\">\r\n    {{!isLabelTemplate()?label:''}}\r\n    <ng-container *ngIf=\"isLabelTemplate()\">\r\n      <ng-container *ngTemplateOutlet=\"label\"></ng-container>\r\n    </ng-container>\r\n  </label>\r\n  <span class=\"input-background\"></span>\r\n</div>\r\n\r\n<rb-form-errors [messages]=\"messages\"></rb-form-errors>\r\n",
            providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(function () { return FormDateInputComponent_1; }), multi: true }],
            exportAs: 'dateInput'
        }),
        tslib_1.__param(2, Optional()), tslib_1.__param(2, Inject(FLATPICKR_DEFAULT_OPTIONS)),
        tslib_1.__metadata("design:paramtypes", [Renderer2,
            ElementRef, Object])
    ], FormDateInputComponent);
    return FormDateInputComponent;
}());
export { FormDateInputComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1kYXRlLWlucHV0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BpbnN0LWlvdC9ib3NjaC1hbmd1bGFyLXVpLWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJhdG9tcy9mb3JtLWRhdGUtZmllbGRzL2Zvcm0tZGF0ZS1pbnB1dC9mb3JtLWRhdGUtaW5wdXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBRUwsU0FBUyxFQUNULGVBQWUsRUFDZixVQUFVLEVBQ1YsVUFBVSxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQ2xDLEtBQUssRUFDTSxRQUFRLEVBQ25CLFNBQVMsRUFDVCxTQUFTLEVBQ1QsV0FBVyxFQUNYLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQXdCLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0scURBQXFELENBQUM7QUFDckcsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRTdELE9BQU8sS0FBSyxlQUFlLE1BQU0sV0FBVyxDQUFDO0FBRTdDLElBQU0sYUFBYSxHQUFHLGVBQWtDLENBQUMsQ0FBQyxrQ0FBa0M7QUFHNUYsTUFBTSxDQUFDLElBQU0seUJBQXlCLEdBQUcsSUFBSSxjQUFjLENBQU0seUJBQXlCLENBQUMsQ0FBQztBQUU1RixJQUFNLGtCQUFrQixHQUFHO0lBQ3pCLFNBQVMsRUFBRSxJQUFJO0NBQ2hCLENBQUM7QUFFRjs7O0dBR0c7QUFPSDtJQTRCRSxnQ0FBb0IsUUFBbUIsRUFDbkIsVUFBc0IsRUFDeUIsY0FBbUI7UUFGbEUsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUNuQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3lCLG1CQUFjLEdBQWQsY0FBYyxDQUFLO1FBNUI3RSxVQUFLLEdBQThCLElBQUksQ0FBQztRQUV4QyxTQUFJLEdBQUcsTUFBTSxDQUFDO1FBQ3ZC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LENBQUMsT0FBTyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDOzBDQUFRLFVBQVU7eURBQUM7SUFRL0M7UUFBUixLQUFLLEVBQUU7OzJEQUFtQjtJQU1sQjtRQUFSLEtBQUssRUFBRTswQ0FBVyxzQkFBc0I7NERBQVE7SUF2QnRDLHNCQUFzQjtRQU5sQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsb0JBQW9CO1lBQzlCLG9zQkFBK0M7WUFDL0MsU0FBUyxFQUFFLENBQUMsRUFBQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxjQUFNLE9BQUEsd0JBQXNCLEVBQXRCLENBQXNCLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFDLENBQUM7WUFDN0csUUFBUSxFQUFFLFdBQVc7U0FDdEIsQ0FBQztRQStCYSxtQkFBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLG1CQUFBLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO2lEQUY1QixTQUFTO1lBQ1AsVUFBVTtPQTdCL0Isc0JBQXNCLENBa0psQztJQUFELDZCQUFDO0NBQUEsQUFsSkQsSUFrSkM7U0FsSlksc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBBZnRlclZpZXdJbml0LFxyXG4gIENvbXBvbmVudCxcclxuICBDb250ZW50Q2hpbGRyZW4sXHJcbiAgRWxlbWVudFJlZixcclxuICBmb3J3YXJkUmVmLCBJbmplY3QsIEluamVjdGlvblRva2VuLFxyXG4gIElucHV0LCBPbkNoYW5nZXMsXHJcbiAgT25EZXN0cm95LCBPcHRpb25hbCxcclxuICBRdWVyeUxpc3QsXHJcbiAgUmVuZGVyZXIyLCBTaW1wbGVDaGFuZ2VzLFxyXG4gIFRlbXBsYXRlUmVmLFxyXG4gIFZpZXdDaGlsZFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb250cm9sVmFsdWVBY2Nlc3NvciwgTkdfVkFMVUVfQUNDRVNTT1IgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCB7IEZvcm1WYWxpZGF0aW9uTWVzc2FnZURpcmVjdGl2ZSB9IGZyb20gJy4uLy4uL2Zvcm0tZmllbGRzL2Zvcm0tdmFsaWRhdGlvbi1tZXNzYWdlLmRpcmVjdGl2ZSc7XHJcbmltcG9ydCB7IGVtcHR5RnVuY3Rpb24gfSBmcm9tICcuLi8uLi9mb3JtLWZpZWxkcy9mb3Jtcy11dGlsJztcclxuaW1wb3J0IGZsYXRwaWNrciBmcm9tICdmbGF0cGlja3InO1xyXG5pbXBvcnQgKiBhcyBmbGF0cGlja3JJbXBvcnQgZnJvbSAnZmxhdHBpY2tyJztcclxuXHJcbmNvbnN0IGZsYXRwaWNrckZ1bmMgPSBmbGF0cGlja3JJbXBvcnQgYXMgYW55IGFzIEZ1bmN0aW9uOyAvLyB3b3JrYXJvdW5kIGZvciByb2xsdXAgYW5kIHRlc3RzXHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IEZMQVRQSUNLUl9ERUZBVUxUX09QVElPTlMgPSBuZXcgSW5qZWN0aW9uVG9rZW48YW55PignZmxhdHBpY2tyRGVmYXVsdE9wdGlvbnMnKTtcclxuXHJcbmNvbnN0IG92ZXJyaWRhYmxlT3B0aW9ucyA9IHtcclxuICB0aW1lXzI0aHI6IHRydWVcclxufTtcclxuXHJcbi8qKlxyXG4gKiBEaXNwbGF5cyBhIGlucHV0IGZvciBmbGF0cGlja3JcclxuICogVGhlIHZhbHVlLCBpcyBhIElTTyBEYXRlIFN0cmluZyBvciBhbiBhcnJheSBvZiBJU08gRGF0ZSBTdHJpbmdzLlxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdyYi1mb3JtLWRhdGUtaW5wdXQnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9mb3JtLWRhdGUtaW5wdXQuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHByb3ZpZGVyczogW3twcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUiwgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gRm9ybURhdGVJbnB1dENvbXBvbmVudCksIG11bHRpOiB0cnVlfV0sXHJcbiAgZXhwb3J0QXM6ICdkYXRlSW5wdXQnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGb3JtRGF0ZUlucHV0Q29tcG9uZW50IGltcGxlbWVudHMgQ29udHJvbFZhbHVlQWNjZXNzb3IsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcclxuXHJcbiAgQElucHV0KCkgbGFiZWw6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gPSBudWxsO1xyXG4gIEBJbnB1dCgpIG5hbWU6IHN0cmluZztcclxuICBASW5wdXQoKSB0eXBlID0gJ3RleHQnO1xyXG4gIGlkID0gJ2lucHV0LicgKyBNYXRoLnJhbmRvbSgpO1xyXG4gIEBJbnB1dCgpIHJlYWRvbmx5O1xyXG5cclxuICBAQ29udGVudENoaWxkcmVuKEZvcm1WYWxpZGF0aW9uTWVzc2FnZURpcmVjdGl2ZSkgbWVzc2FnZXM6IFF1ZXJ5TGlzdDxGb3JtVmFsaWRhdGlvbk1lc3NhZ2VEaXJlY3RpdmU+O1xyXG4gIEBWaWV3Q2hpbGQoJ2lucHV0JywgeyBzdGF0aWM6IHRydWUgfSkgaW5wdXQ6IEVsZW1lbnRSZWY7XHJcblxyXG4gIHByaXZhdGUgcGlja2VyOiBmbGF0cGlja3IuSW5zdGFuY2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIE9wdGlvbnMgZm9yIEZsYXRwaWNrclxyXG4gICAqIEBzZWUgaHR0cHM6Ly9mbGF0cGlja3IuanMub3JnL29wdGlvbnMvXHJcbiAgICovXHJcbiAgQElucHV0KCkgb3B0aW9uczogYW55ID0ge307XHJcblxyXG4gIC8qKlxyXG4gICAqIEdpdmVuLCB3aGVuIHRoaXMgaXMgdGhlIHN0YXJ0IGRhdGUuXHJcbiAgICogU3RhcnQgaW5wdXQgaXMgcmVzcG9uc2libGUgZm9yIG9wdGlvbnNcclxuICAgKi9cclxuICBASW5wdXQoKSByYW5nZUVuZDogRm9ybURhdGVJbnB1dENvbXBvbmVudCA9IG51bGw7XHJcblxyXG4gIG9uQ2hhbmdlID0gZW1wdHlGdW5jdGlvbjtcclxuICBvblRvdWNoZWQgPSBlbXB0eUZ1bmN0aW9uO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoRkxBVFBJQ0tSX0RFRkFVTFRfT1BUSU9OUykgcHJpdmF0ZSBkZWZhdWx0T3B0aW9uczogYW55KSB7XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5kZWZhdWx0T3B0aW9ucykge1xyXG4gICAgICB0aGlzLm9wdGlvbnMgPSB7XHJcbiAgICAgICAgLi4ub3ZlcnJpZGFibGVPcHRpb25zLFxyXG4gICAgICAgIC4uLnRoaXMuZGVmYXVsdE9wdGlvbnMsXHJcbiAgICAgICAgLi4udGhpcy5vcHRpb25zXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLm9wdGlvbnMgPSB7XHJcbiAgICAgICAgLi4ub3ZlcnJpZGFibGVPcHRpb25zLFxyXG4gICAgICAgIC4uLnRoaXMub3B0aW9uc1xyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMub3B0aW9ucy5vblZhbHVlVXBkYXRlID0gKHNlbGVjdGVkRGF0ZXM6IERhdGVbXSwgZGF0ZVN0cmluZzogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHRoaXMudXBkYXRlVmFsdWUoc2VsZWN0ZWREYXRlcyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGlmICh0aGlzLnJhbmdlRW5kKSB7XHJcbiAgICAgIHRoaXMucmFuZ2VFbmQub3B0aW9ucyA9IHsuLi50aGlzLm9wdGlvbnN9O1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucGlja2VyID0gZmxhdHBpY2tyRnVuYyh0aGlzLmlucHV0Lm5hdGl2ZUVsZW1lbnQsIHRoaXMub3B0aW9ucykgYXMgZmxhdHBpY2tyLkluc3RhbmNlO1xyXG5cclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuICAgIGlmIChjaGFuZ2VzLm9wdGlvbnMgJiYgdGhpcy5waWNrZXIgJiYgY2hhbmdlcy5vcHRpb25zLmN1cnJlbnRWYWx1ZSkge1xyXG4gICAgICBPYmplY3Qua2V5cyhjaGFuZ2VzLm9wdGlvbnMuY3VycmVudFZhbHVlKS5mb3JFYWNoKG9wdCA9PiB7XHJcbiAgICAgICAgdGhpcy5waWNrZXIuc2V0KG9wdCBhcyBhbnksIGNoYW5nZXMub3B0aW9ucy5jdXJyZW50VmFsdWVbb3B0XSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5waWNrZXIpIHtcclxuICAgICAgdGhpcy5waWNrZXIuZGVzdHJveSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXNSZWFkb25seSgpIHtcclxuICAgIHJldHVybiB0aGlzLnJlYWRvbmx5ICE9PSB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVWYWx1ZSh2YWx1ZSkge1xyXG4gICAgaWYgKHRoaXMucGlja2VyLmNvbmZpZy5tb2RlID09PSAnc2luZ2xlJyAmJiB2YWx1ZSAmJiB2YWx1ZS5sZW5ndGgpIHtcclxuICAgICAgdmFsdWUgPSB2YWx1ZVswXS50b0lTT1N0cmluZygpO1xyXG4gICAgfVxyXG4gICAgaWYgKFsncmFuZ2UnLCAnbXVsdGlwbGUnXS5pbmRleE9mKHRoaXMucGlja2VyLmNvbmZpZy5tb2RlKSAhPT0gLTEgJiYgdmFsdWUgJiYgdmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgIHZhbHVlID0gdmFsdWUubWFwKHYgPT4gdi50b0lTT1N0cmluZygpKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmNoZWNrVmFsdWUodmFsdWUpO1xyXG4gICAgdGhpcy5vbkNoYW5nZSh2YWx1ZSk7XHJcbiAgICB0aGlzLnVwZGF0ZUVuZFJhbmdlKCk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVFbmRSYW5nZSgpIHtcclxuICAgIGlmICh0aGlzLnJhbmdlRW5kICYmIHRoaXMucGlja2VyLnNlbGVjdGVkRGF0ZXNbMF0pIHtcclxuICAgICAgY29uc3Qgc3RhcnQgPSB0aGlzLnBpY2tlci5zZWxlY3RlZERhdGVzWzBdO1xyXG4gICAgICBjb25zdCBlbmQgPSB0aGlzLnJhbmdlRW5kLnBpY2tlci5zZWxlY3RlZERhdGVzWzBdO1xyXG4gICAgICB0aGlzLnJhbmdlRW5kLnBpY2tlci5zZXQoJ21pbkRhdGUnLCB0aGlzLnBpY2tlci5zZWxlY3RlZERhdGVzWzBdKTtcclxuICAgICAgaWYgKHN0YXJ0ICYmIGVuZCAmJiBlbmQuZ2V0VGltZSgpIDwgc3RhcnQuZ2V0VGltZSgpKSB7XHJcbiAgICAgICAgdGhpcy5yYW5nZUVuZC53cml0ZVZhbHVlKHN0YXJ0LnRvSVNPU3RyaW5nKCkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjaGVja1ZhbHVlKHZhbHVlKSB7XHJcbiAgICBpZiAodHlwZW9mKHZhbHVlKSA9PT0gJ3N0cmluZycgJiYgdmFsdWUubGVuZ3RoID4gMCB8fCB2YWx1ZSAmJiB2YWx1ZS5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ25vdC1lbXB0eScpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ25vdC1lbXB0eScpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXNMYWJlbFRlbXBsYXRlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubGFiZWwgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZjtcclxuICB9XHJcblxyXG5cclxuICB3cml0ZVZhbHVlKHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHZhbHVlID0gJyc7XHJcbiAgICB9XHJcbiAgICB0aGlzLmNoZWNrVmFsdWUodmFsdWUpO1xyXG4gICAgaWYgKHRoaXMucGlja2VyICYmIHRoaXMucGlja2VyLmNvbmZpZykge1xyXG4gICAgICB0aGlzLnBpY2tlci5zZXREYXRlKHZhbHVlKTtcclxuICAgIH1cclxuICAgIHRoaXMudXBkYXRlRW5kUmFuZ2UoKTtcclxuICAgIC8vIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5pbnB1dC5uYXRpdmVFbGVtZW50LCAndmFsdWUnLCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiAoXzogYW55KSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB0aGlzLm9uQ2hhbmdlID0gZm47XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogKCkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdGhpcy5vblRvdWNoZWQgPSBmbjtcclxuICB9XHJcblxyXG4gIHNldERpc2FibGVkU3RhdGUoaXNEaXNhYmxlZDogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmlucHV0Lm5hdGl2ZUVsZW1lbnQsICdkaXNhYmxlZCcsIGlzRGlzYWJsZWQpO1xyXG4gIH1cclxuXHJcbiAgdG9nZ2xlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5waWNrZXIudG9nZ2xlKCk7XHJcbiAgfVxyXG5cclxuICBjbG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMucGlja2VyLmNsb3NlKCk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=