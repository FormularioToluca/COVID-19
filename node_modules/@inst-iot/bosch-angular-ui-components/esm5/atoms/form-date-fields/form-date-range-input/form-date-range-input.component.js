import * as tslib_1 from "tslib";
import { Component, ContentChildren, ElementRef, forwardRef, Inject, Input, Optional, QueryList, Renderer2, TemplateRef, ViewChild } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import * as flatpickrImport from 'flatpickr';
import { FormValidationMessageDirective } from '../../form-fields/form-validation-message.directive';
import { emptyFunction } from '../../form-fields/forms-util';
import { FLATPICKR_DEFAULT_OPTIONS } from '../form-date-input/form-date-input.component';
import { defaultTimeInputOptions, getRelativeInfo, isAbsolute, isRelative } from '../date-range-picker/date-range-picker.model';
import { TIME_INPUT_OPTIONS } from '../form-relative-time-input/relative-time-input.component';
var flatpickrFunc = flatpickrImport; // workaround for rollup and tests
var overridableOptions = {
    time_24hr: true
};
var FormDateRangeInputComponent = /** @class */ (function () {
    function FormDateRangeInputComponent(renderer, elementRef, defaultOptions, timeInputOptions) {
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.defaultOptions = defaultOptions;
        this.timeInputOptions = timeInputOptions;
        this.label = null;
        this.id = 'input.' + Math.random();
        this.allowRelative = false;
        this.presets = [];
        this.startLabel = 'Start';
        this.endLabel = 'End';
        this.absoluteLabel = 'Absolute';
        this.relativeLabel = 'Relative';
        this.presetsLabel = 'Presets';
        this.displayValue = '';
        /**
         * Options for Flatpickr
         * @see https://flatpickr.js.org/options/
         */
        this.options = {};
        this.onChange = emptyFunction;
        this.onTouched = emptyFunction;
        this.viewInit = false;
        if (!timeInputOptions) {
            this.timeInputOptions = defaultTimeInputOptions;
        }
    }
    FormDateRangeInputComponent_1 = FormDateRangeInputComponent;
    FormDateRangeInputComponent.prototype.ngAfterViewInit = function () {
        this.viewInit = true;
        if (isAbsolute(this.value)) {
            this.initPicker();
        }
    };
    FormDateRangeInputComponent.prototype.ngOnChanges = function (changes) {
        var _this = this;
        if (changes.options && this.picker && changes.options.currentValue) {
            Object.keys(changes.options.currentValue).forEach(function (opt) {
                _this.picker.set(opt, changes.options.currentValue[opt]);
            });
        }
    };
    FormDateRangeInputComponent.prototype.ngOnDestroy = function () {
        if (this.picker) {
            this.picker.destroy();
        }
    };
    FormDateRangeInputComponent.prototype.initPicker = function () {
        if (this.defaultOptions) {
            this.options = tslib_1.__assign({}, overridableOptions, this.defaultOptions, this.options, { mode: 'range', clickOpens: false });
        }
        else {
            this.options = tslib_1.__assign({}, overridableOptions, this.options, { mode: 'range', clickOpens: false });
        }
        this.picker = flatpickrFunc(this.input.nativeElement, this.options);
        if (this.value) {
            this.picker.setDate(this.value);
        }
    };
    FormDateRangeInputComponent.prototype.isReadonly = function () {
        return this.readonly !== undefined;
    };
    FormDateRangeInputComponent.prototype.updateValue = function (value) {
        this.value = value;
        this.updateTimeDisplay(value);
        this.checkValue(value);
        this.onChange(value);
    };
    FormDateRangeInputComponent.prototype.checkValue = function (value) {
        if (value && value.length) {
            this.renderer.addClass(this.elementRef.nativeElement, 'not-empty');
        }
        else {
            this.renderer.removeClass(this.elementRef.nativeElement, 'not-empty');
        }
    };
    FormDateRangeInputComponent.prototype.isLabelTemplate = function () {
        return this.label instanceof TemplateRef;
    };
    FormDateRangeInputComponent.prototype.writeValue = function (value) {
        this.value = value;
        this.updateTimeDisplay(value);
    };
    FormDateRangeInputComponent.prototype.updateTimeDisplay = function (value) {
        if (isAbsolute(value)) {
            this.renderer.setProperty(this.input.nativeElement, 'value', '');
            if (this.viewInit && !this.picker) {
                this.initPicker();
            }
            else if (this.picker) {
                this.picker.setDate(value);
            }
        }
        if (isRelative(value)) {
            var info1 = getRelativeInfo(value[0], this.timeInputOptions.units);
            var info2 = getRelativeInfo(value[1], this.timeInputOptions.units);
            this.displayValue = info1.displayText + (info2.count ? ' - ' + info2.displayText : '');
            this.renderer.setProperty(this.input.nativeElement, 'value', this.displayValue);
        }
    };
    FormDateRangeInputComponent.prototype.registerOnChange = function (fn) {
        this.onChange = fn;
    };
    FormDateRangeInputComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    FormDateRangeInputComponent.prototype.setDisabledState = function (isDisabled) {
        this.renderer.setProperty(this.input.nativeElement, 'disabled', isDisabled);
    };
    var FormDateRangeInputComponent_1;
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "label", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], FormDateRangeInputComponent.prototype, "name", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "readonly", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "allowRelative", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Array)
    ], FormDateRangeInputComponent.prototype, "presets", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "startLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "endLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "absoluteLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "relativeLabel", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "presetsLabel", void 0);
    tslib_1.__decorate([
        ContentChildren(FormValidationMessageDirective),
        tslib_1.__metadata("design:type", QueryList)
    ], FormDateRangeInputComponent.prototype, "messages", void 0);
    tslib_1.__decorate([
        ViewChild('input', { static: true }),
        tslib_1.__metadata("design:type", ElementRef)
    ], FormDateRangeInputComponent.prototype, "input", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormDateRangeInputComponent.prototype, "options", void 0);
    FormDateRangeInputComponent = FormDateRangeInputComponent_1 = tslib_1.__decorate([
        Component({
            selector: 'rb-form-date-range-input',
            template: "<div class=\"input-wrapper\" [class.no-label]=\"!label\">\r\n\r\n  <input [id]=\"id + 'input'\"\r\n         class=\"input with-icon\"\r\n         (blur)=\"onTouched()\"\r\n         [rbDropdown]=\"dropdown\"\r\n         [autoClose]=\"false\"\r\n         [hugContent]=\"true\"\r\n         [readonly]=\"isReadonly()\"\r\n         [value]=\"displayValue\"\r\n         #input>\r\n  <span class=\"input-icon rb-ic rb-ic-calendar\"></span>\r\n  <label class=\"label\" [for]=\"id + 'input'\">\r\n    {{!isLabelTemplate()?label:''}}\r\n    <ng-container *ngIf=\"isLabelTemplate()\">\r\n      <ng-container *ngTemplateOutlet=\"label\"></ng-container>\r\n    </ng-container>\r\n  </label>\r\n  <span class=\"input-background\"></span>\r\n</div>\r\n<rb-form-errors [messages]=\"messages\"></rb-form-errors>\r\n\r\n<ng-template #dropdown>\r\n  <rb-date-range-picker [options]=\"options\"\r\n                        [name]=\"name\"\r\n                        [ngModel]=\"value\"\r\n                        (ngModelChange)=\"updateValue($event)\"\r\n                        [allowRelative]=\"allowRelative\"\r\n                        [startLabel]=\"startLabel\"\r\n                        [endLabel]=\"endLabel\"\r\n                        [absoluteLabel]=\"absoluteLabel\"\r\n                        [relativeLabel]=\"relativeLabel\"\r\n                        [presetsLabel]=\"presetsLabel\"\r\n                        [presets]=\"presets\"\r\n  ></rb-date-range-picker>\r\n</ng-template>\r\n",
            providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(function () { return FormDateRangeInputComponent_1; }), multi: true }]
        }),
        tslib_1.__param(2, Optional()), tslib_1.__param(2, Inject(FLATPICKR_DEFAULT_OPTIONS)),
        tslib_1.__param(3, Optional()), tslib_1.__param(3, Inject(TIME_INPUT_OPTIONS)),
        tslib_1.__metadata("design:paramtypes", [Renderer2,
            ElementRef, Object, Object])
    ], FormDateRangeInputComponent);
    return FormDateRangeInputComponent;
}());
export { FormDateRangeInputComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1kYXRlLXJhbmdlLWlucHV0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BpbnN0LWlvdC9ib3NjaC1hbmd1bGFyLXVpLWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJhdG9tcy9mb3JtLWRhdGUtZmllbGRzL2Zvcm0tZGF0ZS1yYW5nZS1pbnB1dC9mb3JtLWRhdGUtcmFuZ2UtaW5wdXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBRUwsU0FBUyxFQUNULGVBQWUsRUFDZixVQUFVLEVBQ1YsVUFBVSxFQUNWLE1BQU0sRUFDTixLQUFLLEVBR0wsUUFBUSxFQUNSLFNBQVMsRUFDVCxTQUFTLEVBRVQsV0FBVyxFQUNYLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQXdCLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekUsT0FBa0IsS0FBSyxlQUFlLE1BQU0sV0FBVyxDQUFDO0FBQ3hELE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHFEQUFxRCxDQUFDO0FBQ3JHLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQUN6RixPQUFPLEVBRUwsdUJBQXVCLEVBQUUsZUFBZSxFQUN4QyxVQUFVLEVBQ1YsVUFBVSxFQUdYLE1BQU0sOENBQThDLENBQUM7QUFDdEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkRBQTJELENBQUM7QUFFL0YsSUFBTSxhQUFhLEdBQUcsZUFBa0MsQ0FBQyxDQUFDLGtDQUFrQztBQUc1RixJQUFNLGtCQUFrQixHQUFHO0lBQ3pCLFNBQVMsRUFBRSxJQUFJO0NBQ2hCLENBQUM7QUFPRjtJQW9DRSxxQ0FBb0IsUUFBbUIsRUFDbkIsVUFBc0IsRUFDeUIsY0FBbUIsRUFDMUIsZ0JBQWtDO1FBSDFFLGFBQVEsR0FBUixRQUFRLENBQVc7UUFD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QUFFOztnRUFBdUM7SUFFdEM7UUFBUixLQUFLLEVBQUU7O21FQUFpRDtJQUNoRDtRQUFSLEtBQUssRUFBRTs7aUVBQTZDO0lBQzVDO1FBQVIsS0FBSyxFQUFFOztzRUFBdUQ7SUFDdEQ7UUFBUixLQUFLLEVBQUU7O3NFQUF1RDtJQUN0RDtRQUFSLEtBQUssRUFBRTs7cUVBQXFEO0lBRVo7UUFBaEQsZUFBZSxDQUFDLDhCQUE4QixDQUFDOzBDQUFXLFNBQVM7aUVBQWlDO0lBQ2pFO1FBQW5DLFNBQVMsQ0FBQyxPQUFPLEVBQUUsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFDLENBQUM7MENBQVEsVUFBVTs4REFBQztJQVk3QztRQUFSLEtBQUssRUFBRTs7Z0VBQW1CO0lBN0JoQiwyQkFBMkI7UUFMdkMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDBCQUEwQjtZQUNwQyxvOUNBQXFEO1lBQ3JELFNBQVMsRUFBRSxDQUFDLEVBQUMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsY0FBTSxPQUFBLDZCQUEyQixFQUEzQixDQUEyQixDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBQyxDQUFDO1NBQ25ILENBQUM7UUF1Q2EsbUJBQUEsUUFBUSxFQUFFLENBQUEsRUFBRSxtQkFBQSxNQUFNLENBQUMseUJBQXlCLENBQUMsQ0FBQTtRQUM3QyxtQkFBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLG1CQUFBLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO2lEQUhyQixTQUFTO1lBQ1AsVUFBVTtPQXJDL0IsMkJBQTJCLENBc0p2QztJQUFELGtDQUFDO0NBQUEsQUF0SkQsSUFzSkM7U0F0SlksMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBBZnRlclZpZXdJbml0LCBDaGFuZ2VEZXRlY3RvclJlZixcclxuICBDb21wb25lbnQsXHJcbiAgQ29udGVudENoaWxkcmVuLFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgZm9yd2FyZFJlZixcclxuICBJbmplY3QsXHJcbiAgSW5wdXQsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIE9uRGVzdHJveSxcclxuICBPcHRpb25hbCxcclxuICBRdWVyeUxpc3QsXHJcbiAgUmVuZGVyZXIyLFxyXG4gIFNpbXBsZUNoYW5nZXMsXHJcbiAgVGVtcGxhdGVSZWYsXHJcbiAgVmlld0NoaWxkXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IGZsYXRwaWNrciwgKiBhcyBmbGF0cGlja3JJbXBvcnQgZnJvbSAnZmxhdHBpY2tyJztcclxuaW1wb3J0IHsgRm9ybVZhbGlkYXRpb25NZXNzYWdlRGlyZWN0aXZlIH0gZnJvbSAnLi4vLi4vZm9ybS1maWVsZHMvZm9ybS12YWxpZGF0aW9uLW1lc3NhZ2UuZGlyZWN0aXZlJztcclxuaW1wb3J0IHsgZW1wdHlGdW5jdGlvbiB9IGZyb20gJy4uLy4uL2Zvcm0tZmllbGRzL2Zvcm1zLXV0aWwnO1xyXG5pbXBvcnQgeyBGTEFUUElDS1JfREVGQVVMVF9PUFRJT05TIH0gZnJvbSAnLi4vZm9ybS1kYXRlLWlucHV0L2Zvcm0tZGF0ZS1pbnB1dC5jb21wb25lbnQnO1xyXG5pbXBvcnQge1xyXG4gIERhdGVSYW5nZVBpY2tlclByZXNldCxcclxuICBkZWZhdWx0VGltZUlucHV0T3B0aW9ucywgZ2V0UmVsYXRpdmVJbmZvLFxyXG4gIGlzQWJzb2x1dGUsXHJcbiAgaXNSZWxhdGl2ZSxcclxuICBQaWNrZXJWYWx1ZSxcclxuICBUaW1lSW5wdXRPcHRpb25zXHJcbn0gZnJvbSAnLi4vZGF0ZS1yYW5nZS1waWNrZXIvZGF0ZS1yYW5nZS1waWNrZXIubW9kZWwnO1xyXG5pbXBvcnQgeyBUSU1FX0lOUFVUX09QVElPTlMgfSBmcm9tICcuLi9mb3JtLXJlbGF0aXZlLXRpbWUtaW5wdXQvcmVsYXRpdmUtdGltZS1pbnB1dC5jb21wb25lbnQnO1xyXG5cclxuY29uc3QgZmxhdHBpY2tyRnVuYyA9IGZsYXRwaWNrckltcG9ydCBhcyBhbnkgYXMgRnVuY3Rpb247IC8vIHdvcmthcm91bmQgZm9yIHJvbGx1cCBhbmQgdGVzdHNcclxuXHJcblxyXG5jb25zdCBvdmVycmlkYWJsZU9wdGlvbnMgPSB7XHJcbiAgdGltZV8yNGhyOiB0cnVlXHJcbn07XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3JiLWZvcm0tZGF0ZS1yYW5nZS1pbnB1dCcsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL2Zvcm0tZGF0ZS1yYW5nZS1pbnB1dC5jb21wb25lbnQuaHRtbCcsXHJcbiAgcHJvdmlkZXJzOiBbe3Byb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLCB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBGb3JtRGF0ZVJhbmdlSW5wdXRDb21wb25lbnQpLCBtdWx0aTogdHJ1ZX1dLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRm9ybURhdGVSYW5nZUlucHV0Q29tcG9uZW50IGltcGxlbWVudHMgQ29udHJvbFZhbHVlQWNjZXNzb3IsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcclxuXHJcbiAgQElucHV0KCkgbGFiZWw6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gPSBudWxsO1xyXG4gIEBJbnB1dCgpIG5hbWU6IHN0cmluZztcclxuICBpZCA9ICdpbnB1dC4nICsgTWF0aC5yYW5kb20oKTtcclxuICBASW5wdXQoKSByZWFkb25seTtcclxuXHJcbiAgQElucHV0KCkgYWxsb3dSZWxhdGl2ZSA9IGZhbHNlO1xyXG4gIEBJbnB1dCgpIHByZXNldHM6IERhdGVSYW5nZVBpY2tlclByZXNldFtdID0gW107XHJcblxyXG4gIEBJbnB1dCgpIHN0YXJ0TGFiZWw6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gPSAnU3RhcnQnO1xyXG4gIEBJbnB1dCgpIGVuZExhYmVsOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+ID0gJ0VuZCc7XHJcbiAgQElucHV0KCkgYWJzb2x1dGVMYWJlbDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9ICdBYnNvbHV0ZSc7XHJcbiAgQElucHV0KCkgcmVsYXRpdmVMYWJlbDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9ICdSZWxhdGl2ZSc7XHJcbiAgQElucHV0KCkgcHJlc2V0c0xhYmVsOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+ID0gJ1ByZXNldHMnO1xyXG5cclxuICBAQ29udGVudENoaWxkcmVuKEZvcm1WYWxpZGF0aW9uTWVzc2FnZURpcmVjdGl2ZSkgbWVzc2FnZXM6IFF1ZXJ5TGlzdDxGb3JtVmFsaWRhdGlvbk1lc3NhZ2VEaXJlY3RpdmU+O1xyXG4gIEBWaWV3Q2hpbGQoJ2lucHV0Jywge3N0YXRpYzogdHJ1ZX0pIGlucHV0OiBFbGVtZW50UmVmO1xyXG5cclxuICBwcml2YXRlIHBpY2tlcjogZmxhdHBpY2tyLkluc3RhbmNlO1xyXG5cclxuICB2YWx1ZTogUGlja2VyVmFsdWU7XHJcblxyXG4gIGRpc3BsYXlWYWx1ZSA9ICcnO1xyXG5cclxuICAvKipcclxuICAgKiBPcHRpb25zIGZvciBGbGF0cGlja3JcclxuICAgKiBAc2VlIGh0dHBzOi8vZmxhdHBpY2tyLmpzLm9yZy9vcHRpb25zL1xyXG4gICAqL1xyXG4gIEBJbnB1dCgpIG9wdGlvbnM6IGFueSA9IHt9O1xyXG5cclxuICBvbkNoYW5nZSA9IGVtcHR5RnVuY3Rpb247XHJcbiAgb25Ub3VjaGVkID0gZW1wdHlGdW5jdGlvbjtcclxuXHJcbiAgcHJpdmF0ZSB2aWV3SW5pdCA9IGZhbHNlO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoRkxBVFBJQ0tSX0RFRkFVTFRfT1BUSU9OUykgcHJpdmF0ZSBkZWZhdWx0T3B0aW9uczogYW55LFxyXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoVElNRV9JTlBVVF9PUFRJT05TKSBwcml2YXRlIHRpbWVJbnB1dE9wdGlvbnM6IFRpbWVJbnB1dE9wdGlvbnMpIHtcclxuICAgIGlmICghdGltZUlucHV0T3B0aW9ucykge1xyXG4gICAgICB0aGlzLnRpbWVJbnB1dE9wdGlvbnMgPSBkZWZhdWx0VGltZUlucHV0T3B0aW9ucztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMudmlld0luaXQgPSB0cnVlO1xyXG4gICAgaWYgKGlzQWJzb2x1dGUodGhpcy52YWx1ZSkpIHtcclxuICAgICAgdGhpcy5pbml0UGlja2VyKCk7XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgaWYgKGNoYW5nZXMub3B0aW9ucyAmJiB0aGlzLnBpY2tlciAmJiBjaGFuZ2VzLm9wdGlvbnMuY3VycmVudFZhbHVlKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKGNoYW5nZXMub3B0aW9ucy5jdXJyZW50VmFsdWUpLmZvckVhY2gob3B0ID0+IHtcclxuICAgICAgICB0aGlzLnBpY2tlci5zZXQob3B0IGFzIGFueSwgY2hhbmdlcy5vcHRpb25zLmN1cnJlbnRWYWx1ZVtvcHRdKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLnBpY2tlcikge1xyXG4gICAgICB0aGlzLnBpY2tlci5kZXN0cm95KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpbml0UGlja2VyKCkge1xyXG4gICAgaWYgKHRoaXMuZGVmYXVsdE9wdGlvbnMpIHtcclxuICAgICAgdGhpcy5vcHRpb25zID0ge1xyXG4gICAgICAgIC4uLm92ZXJyaWRhYmxlT3B0aW9ucyxcclxuICAgICAgICAuLi50aGlzLmRlZmF1bHRPcHRpb25zLFxyXG4gICAgICAgIC4uLnRoaXMub3B0aW9ucyxcclxuICAgICAgICBtb2RlOiAncmFuZ2UnLFxyXG4gICAgICAgIGNsaWNrT3BlbnM6IGZhbHNlXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLm9wdGlvbnMgPSB7XHJcbiAgICAgICAgLi4ub3ZlcnJpZGFibGVPcHRpb25zLFxyXG4gICAgICAgIC4uLnRoaXMub3B0aW9ucyxcclxuICAgICAgICBtb2RlOiAncmFuZ2UnLFxyXG4gICAgICAgIGNsaWNrT3BlbnM6IGZhbHNlXHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5waWNrZXIgPSBmbGF0cGlja3JGdW5jKHRoaXMuaW5wdXQubmF0aXZlRWxlbWVudCwgdGhpcy5vcHRpb25zKSBhcyBmbGF0cGlja3IuSW5zdGFuY2U7XHJcbiAgICBpZiAodGhpcy52YWx1ZSkge1xyXG4gICAgICB0aGlzLnBpY2tlci5zZXREYXRlKHRoaXMudmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXNSZWFkb25seSgpIHtcclxuICAgIHJldHVybiB0aGlzLnJlYWRvbmx5ICE9PSB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVWYWx1ZSh2YWx1ZSkge1xyXG4gICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xyXG4gICAgdGhpcy51cGRhdGVUaW1lRGlzcGxheSh2YWx1ZSk7XHJcblxyXG4gICAgdGhpcy5jaGVja1ZhbHVlKHZhbHVlKTtcclxuICAgIHRoaXMub25DaGFuZ2UodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgY2hlY2tWYWx1ZSh2YWx1ZSkge1xyXG4gICAgaWYgKHZhbHVlICYmIHZhbHVlLmxlbmd0aCkge1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnbm90LWVtcHR5Jyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnbm90LWVtcHR5Jyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpc0xhYmVsVGVtcGxhdGUoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5sYWJlbCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmO1xyXG4gIH1cclxuXHJcblxyXG4gIHdyaXRlVmFsdWUodmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xyXG4gICAgdGhpcy51cGRhdGVUaW1lRGlzcGxheSh2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVUaW1lRGlzcGxheSh2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAoaXNBYnNvbHV0ZSh2YWx1ZSkpIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmlucHV0Lm5hdGl2ZUVsZW1lbnQsICd2YWx1ZScsICcnKTtcclxuICAgICAgaWYgKHRoaXMudmlld0luaXQgJiYgIXRoaXMucGlja2VyKSB7XHJcbiAgICAgICAgdGhpcy5pbml0UGlja2VyKCk7XHJcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5waWNrZXIpIHtcclxuICAgICAgICB0aGlzLnBpY2tlci5zZXREYXRlKHZhbHVlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKGlzUmVsYXRpdmUodmFsdWUpKSB7XHJcbiAgICAgIGNvbnN0IGluZm8xID0gZ2V0UmVsYXRpdmVJbmZvKHZhbHVlWzBdLCB0aGlzLnRpbWVJbnB1dE9wdGlvbnMudW5pdHMpO1xyXG4gICAgICBjb25zdCBpbmZvMiA9IGdldFJlbGF0aXZlSW5mbyh2YWx1ZVsxXSwgdGhpcy50aW1lSW5wdXRPcHRpb25zLnVuaXRzKTtcclxuICAgICAgdGhpcy5kaXNwbGF5VmFsdWUgPSBpbmZvMS5kaXNwbGF5VGV4dCArIChpbmZvMi5jb3VudCA/ICcgLSAnICsgaW5mbzIuZGlzcGxheVRleHQgOiAnJyk7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5pbnB1dC5uYXRpdmVFbGVtZW50LCAndmFsdWUnLCB0aGlzLmRpc3BsYXlWYWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiAoXzogYW55KSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB0aGlzLm9uQ2hhbmdlID0gZm47XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogKCkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdGhpcy5vblRvdWNoZWQgPSBmbjtcclxuICB9XHJcblxyXG4gIHNldERpc2FibGVkU3RhdGUoaXNEaXNhYmxlZDogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmlucHV0Lm5hdGl2ZUVsZW1lbnQsICdkaXNhYmxlZCcsIGlzRGlzYWJsZWQpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19