import * as tslib_1 from "tslib";
import { ApplicationRef, ComponentFactoryResolver, ComponentRef, Injectable, Injector, TemplateRef } from '@angular/core';
import { ModalComponent } from './modal.component';
var ModalService = /** @class */ (function () {
    function ModalService(factoryResolver, injector, appRef) {
        var _this = this;
        this.factoryResolver = factoryResolver;
        this.injector = injector;
        this.appRef = appRef;
        this.openComponents = [];
        var el = document.querySelector('.rb-modal-backdrop');
        if (el) {
            this.backdrop = el;
        }
        else {
            this.backdrop = document.body.appendChild(document.createElement('div'));
            this.backdrop.className = 'rb-modal-backdrop';
            var isDown_1 = false;
            this.backdrop.addEventListener('mousedown', function (e) {
                if (e.target === _this.backdrop) {
                    isDown_1 = true;
                }
            });
            this.backdrop.addEventListener('mouseup', function (e) {
                if (isDown_1 && e.target === _this.backdrop) {
                    _this.nonButtonClose();
                }
                isDown_1 = false;
            });
        }
        this.componentFactory = this.factoryResolver.resolveComponentFactory(ModalComponent);
    }
    Object.defineProperty(ModalService.prototype, "appRoot", {
        get: function () {
            return this.appRef.components[0].location.nativeElement;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Opens a component in a modal. Creates the component instance.
     * Provide an injector in case the ModalService is not instantiated with the Injector that knows the Component.
     */
    ModalService.prototype.openComponent = function (component, options, injector) {
        var factoryResolver = (injector || this.injector).get(ComponentFactoryResolver);
        var factory = factoryResolver.resolveComponentFactory(component);
        var componentRef = factory.create(injector || this.injector);
        var result = this.open(componentRef, options);
        return {
            result: result,
            instance: componentRef.instance
        };
    };
    ModalService.prototype.open = function (content, options) {
        var _this = this;
        return new Promise(function (resolve) {
            if (_this.openComponents.length && options && options.stacked) {
                _this.lastOpenModalElement().classList.add('hidden');
            }
            else {
                _this.close();
            }
            if (!_this.openComponents.length) {
                document.body.classList.add('rb-modal-open');
                if (_this.appRef.components.length) {
                    _this.appRoot.classList.add('rb-modal-frost');
                }
                _this.ensureListeners();
            }
            _this.backdrop.classList.remove('large-fix');
            var componentRef = _this.componentFactory.create(_this.injector);
            if (content instanceof TemplateRef) {
                componentRef.instance.contentTpl = content;
            }
            else if (typeof (content) === 'string') {
                componentRef.instance.contentText = content;
            }
            else if (content instanceof ComponentRef) {
                componentRef.instance.contentComponentRef = content;
            }
            else if (typeof (content) === 'function') {
                componentRef.instance.contentComponent = content;
            }
            componentRef.instance.close = _this.close.bind(_this);
            if (options) {
                Object.assign(componentRef.instance.options, options);
            }
            _this.appRef.attachView(componentRef.hostView);
            _this.backdrop.appendChild(componentRef.location.nativeElement);
            componentRef.location.nativeElement.focus();
            // Fix for IE
            setTimeout(function () {
                if (componentRef.location.nativeElement.offsetTop < 0) {
                    _this.backdrop.classList.add('large-fix');
                }
            }, 10);
            _this.openComponents.push({
                componentRef: componentRef,
                onClose: resolve
            });
        });
    };
    ModalService.prototype.close = function (reason) {
        var openModal = this.openComponents.pop();
        if (!openModal) {
            return;
        }
        this.appRef.detachView(openModal.componentRef.hostView);
        openModal.componentRef.destroy();
        if (!this.openComponents.length) {
            document.body.classList.remove('rb-modal-open');
            if (this.appRef.components.length) {
                this.appRoot.classList.remove('rb-modal-frost');
            }
            this.removeListeners();
        }
        else {
            this.lastOpenModalElement().classList.remove('hidden');
        }
        if (openModal.onClose) {
            openModal.onClose(reason);
        }
    };
    ModalService.prototype.nonButtonClose = function () {
        var instance = this.lastOpenModalInstance();
        if (instance && instance.options.backdropClose || !instance) {
            this.close();
        }
    };
    ModalService.prototype.ensureListeners = function () {
        var _this = this;
        if (!this.keyListener) {
            this.keyListener = function (e) {
                // ESC pressed
                if (e.key === 'Escape') {
                    _this.nonButtonClose();
                }
            };
        }
        document.addEventListener('keyup', this.keyListener, true);
        if (!this.focusListener) {
            this.focusListener = function (e) {
                // Focus changes
                if (_this.appRoot.contains(document.activeElement)) {
                    var firstFocusable = _this.backdrop.querySelector('a,button');
                    firstFocusable.focus();
                }
            };
        }
        document.addEventListener('focus', this.focusListener, true);
    };
    ModalService.prototype.removeListeners = function () {
        if (this.keyListener) {
            document.removeEventListener('keyup', this.keyListener, true);
        }
        if (this.focusListener) {
            document.removeEventListener('focus', this.focusListener, true);
        }
    };
    ModalService.prototype.lastOpenModal = function () {
        return this.openComponents[this.openComponents.length - 1];
    };
    ModalService.prototype.lastOpenModalElement = function () {
        var modal = this.lastOpenModal();
        if (modal) {
            return modal.componentRef.location.nativeElement;
        }
    };
    ModalService.prototype.lastOpenModalInstance = function () {
        var modal = this.lastOpenModal();
        if (modal) {
            return modal.componentRef.instance;
        }
    };
    ModalService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [ComponentFactoryResolver,
            Injector,
            ApplicationRef])
    ], ModalService);
    return ModalService;
}());
export { ModalService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BpbnN0LWlvdC9ib3NjaC1hbmd1bGFyLXVpLWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJhdG9tcy9tb2RhbC9tb2RhbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsY0FBYyxFQUVkLHdCQUF3QixFQUN4QixZQUFZLEVBQ1osVUFBVSxFQUNWLFFBQVEsRUFDUixXQUFXLEVBRVosTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGNBQWMsRUFBZ0IsTUFBTSxtQkFBbUIsQ0FBQztBQWFqRTtJQVlFLHNCQUFvQixlQUF5QyxFQUN6QyxRQUFrQixFQUNsQixNQUFzQjtRQUYxQyxpQkF1QkM7UUF2Qm1CLG9CQUFlLEdBQWYsZUFBZSxDQUEwQjtRQUN6QyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBUGxDLG1CQUFjLEdBQWdCLEVBQUUsQ0FBQztRQVF2QyxJQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDeEQsSUFBSSxFQUFFLEVBQUU7WUFDTixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztTQUNwQjthQUFNO1lBQ0wsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDekUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsbUJBQW1CLENBQUM7WUFDOUMsSUFBSSxRQUFNLEdBQUcsS0FBSyxDQUFDO1lBQ25CLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLFVBQUEsQ0FBQztnQkFDM0MsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLEtBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQzlCLFFBQU0sR0FBRyxJ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bkMsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLEtBQUssQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQztTQUNsRDtJQUNILENBQUM7SUFFTyw0Q0FBcUIsR0FBN0I7UUFDRSxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDbkMsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLEtBQUssQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQztJQTdMVSxZQUFZO1FBRHhCLFVBQVUsRUFBRTtpREFhMEIsd0JBQXdCO1lBQy9CLFFBQVE7WUFDVixjQUFjO09BZC9CLFlBQVksQ0FnTXhCO0lBQUQsbUJBQUM7Q0FBQSxBQWhNRCxJQWdNQztTQWhNWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBBcHBsaWNhdGlvblJlZixcclxuICBDb21wb25lbnRGYWN0b3J5LFxyXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICBDb21wb25lbnRSZWYsXHJcbiAgSW5qZWN0YWJsZSxcclxuICBJbmplY3RvcixcclxuICBUZW1wbGF0ZVJlZixcclxuICBUeXBlXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1vZGFsQ29tcG9uZW50LCBNb2RhbE9wdGlvbnMgfSBmcm9tICcuL21vZGFsLmNvbXBvbmVudCc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE9wZW5Nb2RhbCB7XHJcbiAgY29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8TW9kYWxDb21wb25lbnQ+O1xyXG4gIG9uQ2xvc2U6IChyZWFzb24/OiBhbnkpID0+IHZvaWQ7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ29tcG9uZW50TW9kYWw8VD4ge1xyXG4gIGluc3RhbmNlOiBUO1xyXG4gIHJlc3VsdDogUHJvbWlzZTxhbnk+O1xyXG59XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBNb2RhbFNlcnZpY2Uge1xyXG5cclxuICBiYWNrZHJvcDogRWxlbWVudDtcclxuICBjb250YWluZXI6IEVsZW1lbnQ7XHJcblxyXG4gIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeTogQ29tcG9uZW50RmFjdG9yeTxNb2RhbENvbXBvbmVudD47XHJcblxyXG4gIHByaXZhdGUgb3BlbkNvbXBvbmVudHM6IE9wZW5Nb2RhbFtdID0gW107XHJcblxyXG4gIHByaXZhdGUga2V5TGlzdGVuZXI7XHJcbiAgcHJpdmF0ZSBmb2N1c0xpc3RlbmVyO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgYXBwUmVmOiBBcHBsaWNhdGlvblJlZikge1xyXG4gICAgY29uc3QgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcucmItbW9kYWwtYmFja2Ryb3AnKTtcclxuICAgIGlmIChlbCkge1xyXG4gICAgICB0aGlzLmJhY2tkcm9wID0gZWw7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmJhY2tkcm9wID0gZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7XHJcbiAgICAgIHRoaXMuYmFja2Ryb3AuY2xhc3NOYW1lID0gJ3JiLW1vZGFsLWJhY2tkcm9wJztcclxuICAgICAgbGV0IGlzRG93biA9IGZhbHNlO1xyXG4gICAgICB0aGlzLmJhY2tkcm9wLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGUgPT4ge1xyXG4gICAgICAgIGlmIChlLnRhcmdldCA9PT0gdGhpcy5iYWNrZHJvcCkge1xyXG4gICAgICAgICAgaXNEb3duID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLmJhY2tkcm9wLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlID0+IHtcclxuICAgICAgICBpZiAoaXNEb3duICYmIGUudGFyZ2V0ID09PSB0aGlzLmJhY2tkcm9wKSB7XHJcbiAgICAgICAgICB0aGlzLm5vbkJ1dHRvbkNsb3NlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlzRG93biA9IGZhbHNlO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHRoaXMuY29tcG9uZW50RmFjdG9yeSA9IHRoaXMuZmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KE1vZGFsQ29tcG9uZW50KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0IGFwcFJvb3QoKTogRWxlbWVudCB7XHJcbiAgICByZXR1cm4gdGhpcy5hcHBSZWYuY29tcG9uZW50c1swXS5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogT3BlbnMgYSBjb21wb25lbnQgaW4gYSBtb2RhbC4gQ3JlYXRlcyB0aGUgY29tcG9uZW50IGluc3RhbmNlLlxyXG4gICAqIFByb3ZpZGUgYW4gaW5qZWN0b3IgaW4gY2FzZSB0aGUgTW9kYWxTZXJ2aWNlIGlzIG5vdCBpbnN0YW50aWF0ZWQgd2l0aCB0aGUgSW5qZWN0b3IgdGhhdCBrbm93cyB0aGUgQ29tcG9uZW50LlxyXG4gICAqL1xyXG4gIG9wZW5Db21wb25lbnQ8VD4oY29tcG9uZW50OiBUeXBlPFQ+LCBvcHRpb25zPzogTW9kYWxPcHRpb25zLCBpbmplY3Rvcj86IEluamVjdG9yKTogQ29tcG9uZW50TW9kYWw8VD4ge1xyXG4gICAgY29uc3QgZmFjdG9yeVJlc29sdmVyID0gKGluamVjdG9yIHx8IHRoaXMuaW5qZWN0b3IpLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpO1xyXG4gICAgY29uc3QgZmFjdG9yeSA9IGZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShjb21wb25lbnQpO1xyXG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gZmFjdG9yeS5jcmVhdGUoaW5qZWN0b3IgfHwgdGhpcy5pbmplY3Rvcik7XHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLm9wZW4oY29tcG9uZW50UmVmLCBvcHRpb25zKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHJlc3VsdDogcmVzdWx0LFxyXG4gICAgICBpbnN0YW5jZTogY29tcG9uZW50UmVmLmluc3RhbmNlXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgb3Blbihjb250ZW50OiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+IHwgVHlwZTxhbnk+IHwgQ29tcG9uZW50UmVmPGFueT4sIG9wdGlvbnM/OiBNb2RhbE9wdGlvbnMpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4ocmVzb2x2ZSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLm9wZW5Db21wb25lbnRzLmxlbmd0aCAmJiBvcHRpb25zICYmIG9wdGlvbnMuc3RhY2tlZCkge1xyXG4gICAgICAgIHRoaXMubGFzdE9wZW5Nb2RhbEVsZW1lbnQoKS5jbGFzc0xpc3QuYWRkKCdoaWRkZW4nKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmNsb3NlKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICghdGhpcy5vcGVuQ29tcG9uZW50cy5sZW5ndGgpIHtcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ3JiLW1vZGFsLW9wZW4nKTtcclxuICAgICAgICBpZiAodGhpcy5hcHBSZWYuY29tcG9uZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgIHRoaXMuYXBwUm9vdC5jbGFzc0xpc3QuYWRkKCdyYi1tb2RhbC1mcm9zdCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmVuc3VyZUxpc3RlbmVycygpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmJhY2tkcm9wLmNsYXNzTGlzdC5yZW1vdmUoJ2xhcmdlLWZpeCcpO1xyXG5cclxuICAgICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy5jb21wb25lbnRGYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgICAgaWYgKGNvbnRlbnQgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZikge1xyXG4gICAgICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZS5jb250ZW50VHBsID0gY29udGVudDtcclxuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgKGNvbnRlbnQpID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZS5jb250ZW50VGV4dCA9IGNvbnRlbnQ7XHJcbiAgICAgIH0gZWxzZSBpZiAoY29udGVudCBpbnN0YW5jZW9mIENvbXBvbmVudFJlZikge1xyXG4gICAgICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZS5jb250ZW50Q29tcG9uZW50UmVmID0gY29udGVudDtcclxuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgKGNvbnRlbnQpID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLmNvbnRlbnRDb21wb25lbnQgPSBjb250ZW50O1xyXG4gICAgICB9XHJcbiAgICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZS5jbG9zZSA9IHRoaXMuY2xvc2UuYmluZCh0aGlzKTtcclxuICAgICAgaWYgKG9wdGlvbnMpIHtcclxuICAgICAgICBPYmplY3QuYXNzaWduKGNvbXBvbmVudFJlZi5pbnN0YW5jZS5vcHRpb25zLCBvcHRpb25zKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5hcHBSZWYuYXR0YWNoVmlldyhjb21wb25lbnRSZWYuaG9zdFZpZXcpO1xyXG5cclxuICAgICAgdGhpcy5iYWNrZHJvcC5hcHBlbmRDaGlsZChjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCk7XHJcblxyXG4gICAgICBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5mb2N1cygpO1xyXG5cclxuICAgICAgLy8gRml4IGZvciBJRVxyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICBpZiAoY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQub2Zmc2V0VG9wIDwgMCkge1xyXG4gICAgICAgICAgdGhpcy5iYWNrZHJvcC5jbGFzc0xpc3QuYWRkKCdsYXJnZS1maXgnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sIDEwKTtcclxuXHJcblxyXG4gICAgICB0aGlzLm9wZW5Db21wb25lbnRzLnB1c2goe1xyXG4gICAgICAgIGNvbXBvbmVudFJlZjogY29tcG9uZW50UmVmLFxyXG4gICAgICAgIG9uQ2xvc2U6IHJlc29sdmVcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGNsb3NlKHJlYXNvbj86IGFueSkge1xyXG4gICAgY29uc3Qgb3Blbk1vZGFsID0gdGhpcy5vcGVuQ29tcG9uZW50cy5wb3AoKTtcclxuICAgIGlmICghb3Blbk1vZGFsKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmFwcFJlZi5kZXRhY2hWaWV3KG9wZW5Nb2RhbC5jb21wb25lbnRSZWYuaG9zdFZpZXcpO1xyXG4gICAgb3Blbk1vZGFsLmNvbXBvbmVudFJlZi5kZXN0cm95KCk7XHJcbiAgICBpZiAoIXRoaXMub3BlbkNvbXBvbmVudHMubGVuZ3RoKSB7XHJcbiAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgncmItbW9kYWwtb3BlbicpO1xyXG4gICAgICBpZiAodGhpcy5hcHBSZWYuY29tcG9uZW50cy5sZW5ndGgpIHtcclxuICAgICAgICB0aGlzLmFwcFJvb3QuY2xhc3NMaXN0LnJlbW92ZSgncmItbW9kYWwtZnJvc3QnKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnJlbW92ZUxpc3RlbmVycygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5sYXN0T3Blbk1vZGFsRWxlbWVudCgpLmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGRlbicpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChvcGVuTW9kYWwub25DbG9zZSkge1xyXG4gICAgICBvcGVuTW9kYWwub25DbG9zZShyZWFzb24pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBub25CdXR0b25DbG9zZSgpIHtcclxuICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5sYXN0T3Blbk1vZGFsSW5zdGFuY2UoKTtcclxuICAgIGlmIChpbnN0YW5jZSAmJiBpbnN0YW5jZS5vcHRpb25zLmJhY2tkcm9wQ2xvc2UgfHwgIWluc3RhbmNlKSB7XHJcbiAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW5zdXJlTGlzdGVuZXJzKCkge1xyXG4gICAgaWYgKCF0aGlzLmtleUxpc3RlbmVyKSB7XHJcbiAgICAgIHRoaXMua2V5TGlzdGVuZXIgPSBlID0+IHtcclxuICAgICAgICAvLyBFU0MgcHJlc3NlZFxyXG4gICAgICAgIGlmIChlLmtleSA9PT0gJ0VzY2FwZScpIHtcclxuICAgICAgICAgIHRoaXMubm9uQnV0dG9uQ2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIHRoaXMua2V5TGlzdGVuZXIsIHRydWUpO1xyXG5cclxuICAgIGlmICghdGhpcy5mb2N1c0xpc3RlbmVyKSB7XHJcbiAgICAgIHRoaXMuZm9jdXNMaXN0ZW5lciA9IGUgPT4ge1xyXG4gICAgICAgIC8vIEZvY3VzIGNoYW5nZXNcclxuICAgICAgICBpZiAodGhpcy5hcHBSb290LmNvbnRhaW5zKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpKSB7XHJcbiAgICAgICAgICBjb25zdCBmaXJzdEZvY3VzYWJsZSA9IHRoaXMuYmFja2Ryb3AucXVlcnlTZWxlY3RvcignYSxidXR0b24nKTtcclxuICAgICAgICAgIChmaXJzdEZvY3VzYWJsZSBhcyBIVE1MRWxlbWVudCkuZm9jdXMoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdmb2N1cycsIHRoaXMuZm9jdXNMaXN0ZW5lciwgdHJ1ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlbW92ZUxpc3RlbmVycygpIHtcclxuICAgIGlmICh0aGlzLmtleUxpc3RlbmVyKSB7XHJcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXVwJywgdGhpcy5rZXlMaXN0ZW5lciwgdHJ1ZSk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5mb2N1c0xpc3RlbmVyKSB7XHJcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgdGhpcy5mb2N1c0xpc3RlbmVyLCB0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxhc3RPcGVuTW9kYWwoKTogT3Blbk1vZGFsIHtcclxuICAgIHJldHVybiB0aGlzLm9wZW5Db21wb25lbnRzW3RoaXMub3BlbkNvbXBvbmVudHMubGVuZ3RoIC0gMV07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxhc3RPcGVuTW9kYWxFbGVtZW50KCk6IEVsZW1lbnQge1xyXG4gICAgY29uc3QgbW9kYWwgPSB0aGlzLmxhc3RPcGVuTW9kYWwoKTtcclxuICAgIGlmIChtb2RhbCkge1xyXG4gICAgICByZXR1cm4gbW9kYWwuY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxhc3RPcGVuTW9kYWxJbnN0YW5jZSgpOiBNb2RhbENvbXBvbmVudCB7XHJcbiAgICBjb25zdCBtb2RhbCA9IHRoaXMubGFzdE9wZW5Nb2RhbCgpO1xyXG4gICAgaWYgKG1vZGFsKSB7XHJcbiAgICAgIHJldHVybiBtb2RhbC5jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbn1cclxuIl19