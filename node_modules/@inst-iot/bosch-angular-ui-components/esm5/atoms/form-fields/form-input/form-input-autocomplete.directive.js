import * as tslib_1 from "tslib";
import { ComponentFactoryResolver, Directive, HostListener, Inject, Injector, Input, Optional, Self, TemplateRef, ViewContainerRef } from '@angular/core';
import { NEVER, of, Subject } from 'rxjs';
import { DropdownDirective } from '../../dropdown/dropdown.directive';
import { NG_VALUE_ACCESSOR, NgControl } from '@angular/forms';
import { catchError, debounceTime, skip, switchMap, takeUntil, tap } from 'rxjs/operators';
import { FormInputAutocompleteListComponent } from './form-input-autocomplete-list/form-input-autocomplete-list.component';
var FormInputAutocompleteDirective = /** @class */ (function (_super) {
    tslib_1.__extends(FormInputAutocompleteDirective, _super);
    function FormInputAutocompleteDirective(_factoryResolver, injector, viewContainerRef, control, inputs) {
        var _this = _super.call(this, _factoryResolver, viewContainerRef) || this;
        _this._factoryResolver = _factoryResolver;
        _this.injector = injector;
        _this.control = control;
        /**
         * Should the dropdown open on initial click without any value change
         */
        _this.rbInitialOpen = false;
        _this.rbDebounceTime = 500;
        _this.destroy = new Subject();
        _this.loading = false;
        _this.error = null;
        _this.lastResult = null;
        _this.focus = null;
        _this.input = null;
        _this.noSearchFor = null;
        if (inputs) {
            _this.input = inputs[0];
        }
        _this.openOnClick = false;
        return _this;
    }
    FormInputAutocompleteDirective.prototype.ngOnInit = function () {
        var _this = this;
        _super.prototype.ngOnInit.call(this);
        if (this.rbInitialOpen) {
            this.openOnClick = true;
        }
        if (!this.rbAutocompleteList) {
            var factory = this._factoryResolver.resolveComponentFactory(FormInputAutocompleteListComponent);
            var component = factory.create(this.injector);
            this.instance = component.instance;
            this.rbAutocompleteList = component.instance.template;
        }
        this.template = this.rbAutocompleteList;
        this.updateLoading(false, null);
        var changes = 0;
        var resolvedValue = null;
        this.control.valueChanges.pipe(debounceTime(this.rbDebounceTime), switchMap(function (value) {
            changes++;
            if (changes === 1 && !_this.rbInitialOpen || resolvedValue === value || _this.noSearchFor === value) {
                return NEVER;
            }
            resolvedValue = value;
            _this.updateLoading(true, null);
            var result = _this.rbFormInputAutocomplete(value);
            if (result) {
                return result.pipe(tap(function () { return _this.updateLoading(false, null); }, function (err) { return _this.updateLoading(false, err); }, function () { return _this.updateLoading(false, null); }), catchError(function (err) { return of(null); }), takeUntil(_this.control.valueChanges.pipe(skip(1))));
            }
            else {
                _this.updateLoading(false, null);
                return of(null);
            }
        }), takeUntil(this.destroy)).subscribe(function (results) {
            _this.openOnClick = true;
            _this.lastResult = results;
            if (results !== null && !results.includes(resolvedValue)) {
                _this.focus = null;
            }
            _this.updateContext(_this.control.value);
            if (results !== null && (!_this.componentRef || !_this.componentRef.instance.shown) && changes > 1) {
                _this.openDropdown();
            }
            if (results === null) {
                _this.closeDropdown();
            }
        });
    };
    FormInputAutocompleteDirective.prototype.ngAfterViewInit = function () {
        if (this.input && this.input.input) {
            this.input.input.nativeElement.autocomplete = 'off';
        }
    };
    FormInputAutocompleteDirective.prototype.updateLoading = function (loading, error) {
        this.loading = loading;
        this.error = error;
        if (this.error) {
            var errors = this.control.errors || {};
            errors['autocomplete'] = this.error;
            this.control.control.setErrors(errors);
        }
        if (this.input && this.loading) {
            this.input.updateIcon('rb-ic rb-ic-spin rb-ic-refresh');
        }
        if (this.input && !this.loading) {
            this.input.updateIcon(this.rbInitialOpen ? 'select-icon rb-ic rb-ic-down' : null);
        }
        if (this.input && this.error) {
            this.input.updateIcon('rb-ic rb-ic-alert-warning u-TextColor--red');
        }
    };
    FormInputAutocompleteDirective.prototype.select = function (value) {
        this.noSearchFor = value;
        this.control.control.setValue(value);
        this.focus = value;
        this.closeDropdown();
        this.updateContext(value);
    };
    FormInputAutocompleteDirective.prototype.onKeyUp = function (e) {
        if (e.key === 'ArrowDown' || e.key === 'Down') {
            e.preventDefault();
            this.moveFocus(1);
        }
        if (e.key === 'ArrowUp' || e.key === 'Up') {
            e.preventDefault();
            this.moveFocus(-1);
        }
        if (e.key === 'Enter' && this.componentRef && this.componentRef.instance.shown) {
            e.preventDefault();
            this.select(this.focus);
        }
    };
    FormInputAutocompleteDirective.prototype.moveFocus = function (by) {
        var list = this.lastResult || [];
        if (!list.length) {
            this.focus = null;
            this.updateContext(this.control.value);
            return;
        }
        var focusIndex = list.indexOf(this.focus);
        if (focusIndex === -1) {
            focusIndex = 0;
        }
        else {
            focusIndex += by;
            if (focusIndex === -1) {
                focusIndex = list.length - 1;
            }
            if (focusIndex === list.length) {
                focusIndex = 0;
            }
        }
        this.focus = list[focusIndex];
        this.updateContext(this.control.value);
    };
    FormInputAutocompleteDirective.prototype.updateContext = function (value) {
        this.context = {
            list: this.lastResult,
            active: value,
            focus: this.focus,
            select: this.select.bind(this)
        };
    };
    FormInputAutocompleteDirective.prototype.ngOnDestroy = function () {
        _super.prototype.ngOnDestroy.call(this);
        this.destroy.complete();
        this.input = null;
    };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Function)
    ], FormInputAutocompleteDirective.prototype, "rbFormInputAutocomplete", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", TemplateRef)
    ], FormInputAutocompleteDirective.prototype, "rbAutocompleteList", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormInputAutocompleteDirective.prototype, "rbInitialOpen", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormInputAutocompleteDirective.prototype, "rbDebounceTime", void 0);
    tslib_1.__decorate([
        HostListener('keyup', ['$event']),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [KeyboardEvent]),
        tslib_1.__metadata("design:returntype", void 0)
    ], FormInputAutocompleteDirective.prototype, "onKeyUp", null);
    FormInputAutocompleteDirective = tslib_1.__decorate([
        Directive({
            selector: '[rbFormInputAutocomplete]',
        }),
        tslib_1.__param(3, Self()),
        tslib_1.__param(4, Self()), tslib_1.__param(4, Optional()), tslib_1.__param(4, Inject(NG_VALUE_ACCESSOR)),
        tslib_1.__metadata("design:paramtypes", [ComponentFactoryResolver,
            Injector,
            ViewContainerRef,
            NgControl, Array])
    ], FormInputAutocompleteDirective);
    return FormInputAutocompleteDirective;
}(DropdownDirective));
export { FormInputAutocompleteDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1pbnB1dC1hdXRvY29tcGxldGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGluc3QtaW90L2Jvc2NoLWFuZ3VsYXItdWktY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImF0b21zL2Zvcm0tZmllbGRzL2Zvcm0taW5wdXQvZm9ybS1pbnB1dC1hdXRvY29tcGxldGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBRUwsd0JBQXdCLEVBQ3hCLFNBQVMsRUFDVCxZQUFZLEVBQ1osTUFBTSxFQUNOLFFBQVEsRUFDUixLQUFLLEVBR0wsUUFBUSxFQUNSLElBQUksRUFDSixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0YsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0sdUVBQXVFLENBQUM7QUFNM0g7SUFBb0QsMERBQWlCO0lBd0NuRSx3Q0FBb0IsZ0JBQTBDLEVBQzFDLFFBQWtCLEVBQzFCLGdCQUFrQyxFQUNsQixPQUFrQixFQUNhLE1BQTRCO1FBSnZGLFlBTUUsa0JBQU0sZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsU0FLMUM7UUFYbUIsc0JBQWdCLEdBQWhCLGdCQUFnQixDQUEwQjtRQUMxQyxjQUFRLEdBQVIsUUFBUSxDQUFVO1FBRVYsYUFBTyxHQUFQLE9BQU8sQ0FBVztRQTFCOUM7O1dBRUc7UUFDTSxtQkFBYSxHQUFHLEtBQUssQ0FBQztRQUV0QixvQkFBYyxHQUFHLEdBQUcsQ0FBQztRQUV0QixhQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUVoQyxhQUFPLEdBQUcsS0FBSyxDQUFDO1FBRWhCLFdBQUssR0FBRyxJQUFJLENBQUM7UUFJTCxnQkFBVSxHQUFHLElBQUksQ0FBQztRQUVsQixXQUFLLEdBQUcsSUFBSSxDQUFDO1FBRWIsV0FBSyxHQUF1QixJQUFJLENBQUM7UUFFakMsaUJBQVcsR0FBRyxJQUFJLENBQUM7UUFTekIsSUFBSSxNQUFNLEVBQUU7WUFDVixLQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4QjtRQUNELEtBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDOztJQUMzQixDQUFDO0lBR0QsaURBQVEsR0FBUjtRQUFBLGlCQTREQztRQTNEQyxpQkFBTSxRQUFRLFdBQUUsQ0FBQztRQUVqQixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7U0FDekI7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFO1lBQzVCLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyx1QkFBdUIsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1lBQ2xHLElBQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUNuQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7U0FDdkQ7UUFFRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztRQUV4QyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVoQyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUM7UUFDaEIsSUFBSSxhQUFhLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FDNUIsWUFBWSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsRUFDakMsU0FBUyxDQUFDLFVBQUEsS0FBSztZQUNiLE9BQU8sRUFBRSxDQUFDO1lBQ1YsSUFBSSxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLGFBQWEsSUFBSSxhQUFhLEtBQUssS0FBSyxJQUFJLEtBQUksQ0FBQyxXQUFXLEtBQUssS0FBSyxFQUFFO2dCQUNqRyxPQUFPLEtBQUssQ0FBQzthQUNkO1lBQ0QsYUFBYSxHQUFHLEtBQUssQ0FBQztZQUN0QixLQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMvQixJQUFNLE1BQU0sR0FBRyxLQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkQsSUFBSSxNQUFNLEVBQUU7Z0JBQ1YsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUNoQixHQUFHLENBQ0QsY0FBTSxPQUFBLEtBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUEvQixDQUErQixFQUNyQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEtBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxFQUE5QixDQUE4QixFQUNyQyxjQUFNLE9BQUEsS0FBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQS9CLENBQStCLENBQUMsRUFDeEMsVUFBVSxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFSLENBQVEsQ0FBQyxFQUMzQixTQUFTLENBQUMsS0FBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQ25ELENBQUM7YUFDSDtpQkFBTTtnQkFDTCxLQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDaEMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakI7UUFDSCxDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUN4QixDQUFDLFNBQVMsQ0FBQyxVQUFBLE9BQU87WUFDakIsS0FBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7WUFDeEIsS0FBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUM7WUFDMUIsSUFBSSxPQUFPLEtBQUssSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsRUFBRTtnQkFDeEQsS0FBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7YUFDbkI7WUFDRCxLQUFJLENBQUMsYUFBYSxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdkMsSUFBSSxPQUFPLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxLQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsS0FBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksT0FBTyxHQUFHLENBQUMsRUFBRTtnQkFDaEcsS0FBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQ3JCO1lBQ0QsSUFBSSxPQUFPLEtBQUssSUFBSSxFQUFFO2dCQUNwQixLQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDdEI7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUVMLENBQUM7SUFFRCx3REFBZSxHQUFmO1FBQ0UsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFO1lBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1NBQ3JEO0lBQ0gsQ0FBQztJQUVELHNEQUFhLEdBQWIsVUFBYyxPQUFnQixFQUFFLEtBQVU7UUFDeEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2QsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO1lBQ3pDLE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN4QztRQUNELElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7U0FDekQ7UUFDRCxJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLDhCQUE4QixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNuRjtRQUNELElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQzVCLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLDRDQUE0QyxDQUFDLENBQUM7U0FDckU7SUFDSCxDQUFDO0lBRUQsK0NBQU0sR0FBTixVQUFPLEtBQWE7UUFDbEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFDekIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFHRCxnREFBTyxHQUFQLFVBQVEsQ0FBZ0I7UUFDdEIsSUFBSSxDQUFDLENBQUMsR0FBRyxLQUFLLFdBQVcsSUFBSSxDQUFDLENBQUMsR0FBRyxLQUFLLE1BQU0sRUFBRTtZQUM3QyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDbkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNuQjtRQUNELElBQUksQ0FBQyxDQUFDLEdBQUcsS0FBSyxTQUFTLElBQUksQ0FBQyxDQUFDLEdBQUcsS0FBSyxJQUFJLEVBQUU7WUFDekMsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ25CLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNwQjtRQUNELElBQUksQ0FBQyxDQUFDLEdBQUcsS0FBSyxPQUFPLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUU7WUFDOUUsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ25CLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3pCO0lBQ0gsQ0FBQztJQUVPLGtEQUFTLEdBQWpCLFVBQWtCLEVBQVU7UUFDMUIsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDaEIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7WUFDbEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZDLE9BQU87U0FDUjtRQUNELElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFDLElBQUksVUFBVSxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ3JCLFVBQVUsR0FBRyxDQUFDLENBQUM7U0FDaEI7YUFBTTtZQUNMLFVBQVUsSUFBSSxFQUFFLENBQUM7WUFDakIsSUFBSSxVQUFVLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ3JCLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQzthQUM5QjtZQUNELElBQUksVUFBVSxLQUFLLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQzlCLFVBQVUsR0FBRyxDQUFDLENBQUM7YUFDaEI7U0FDRjtRQUVELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sc0RBQWEsR0FBckIsVUFBc0IsS0FBSztRQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ2IsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQ3JCLE1BQU0sRUFBRSxLQUFLO1lBQ2IsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDL0IsQ0FBQztJQUNKLENBQUM7SUFFRCxvREFBVyxHQUFYO1FBQ0UsaUJBQU0sV0FBVyxXQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztJQUNwQixDQUFDO0lBcE1RO1FBQVIsS0FBSyxFQUFFOzttRkFBeUU7SUFTeEU7UUFBUixLQUFLLEVBQUU7MENBQXFCLFdBQVc7OEVBQU07SUFLckM7UUFBUixLQUFLLEVBQUU7O3lFQUF1QjtJQUV0QjtRQUFSLEtBQUssRUFBRTs7MEVBQXNCO0lBZ0k5QjtRQURDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7aURBQ3ZCLGFBQWE7O2lFQWF2QjtJQW5LVSw4QkFBOEI7UUFIMUMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDJCQUEyQjtTQUN0QyxDQUFDO1FBNENhLG1CQUFBLElBQUksRUFBRSxDQUFBO1FBQ04sbUJBQUEsSUFBSSxFQUFFLENBQUEsRUFBRSxtQkFBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLG1CQUFBLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO2lEQUpwQix3QkFBd0I7WUFDaEMsUUFBUTtZQUNSLGdCQUFnQjtZQUNULFNBQVM7T0EzQ25DLDhCQUE4QixDQTJNMUM7SUFBRCxxQ0FBQztDQUFBLEFBM01ELENBQW9ELGlCQUFpQixHQTJNcEU7U0EzTVksOEJBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBBZnRlclZpZXdJbml0LFxyXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICBEaXJlY3RpdmUsXHJcbiAgSG9zdExpc3RlbmVyLFxyXG4gIEluamVjdCxcclxuICBJbmplY3RvcixcclxuICBJbnB1dCxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT25Jbml0LFxyXG4gIE9wdGlvbmFsLFxyXG4gIFNlbGYsXHJcbiAgVGVtcGxhdGVSZWYsXHJcbiAgVmlld0NvbnRhaW5lclJlZlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBORVZFUiwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgRHJvcGRvd25EaXJlY3RpdmUgfSBmcm9tICcuLi8uLi9kcm9wZG93bi9kcm9wZG93bi5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBOR19WQUxVRV9BQ0NFU1NPUiwgTmdDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBjYXRjaEVycm9yLCBkZWJvdW5jZVRpbWUsIHNraXAsIHN3aXRjaE1hcCwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZvcm1JbnB1dEF1dG9jb21wbGV0ZUxpc3RDb21wb25lbnQgfSBmcm9tICcuL2Zvcm0taW5wdXQtYXV0b2NvbXBsZXRlLWxpc3QvZm9ybS1pbnB1dC1hdXRvY29tcGxldGUtbGlzdC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBGb3JtSW5wdXRDb21wb25lbnQgfSBmcm9tICcuL2Zvcm0taW5wdXQuY29tcG9uZW50JztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW3JiRm9ybUlucHV0QXV0b2NvbXBsZXRlXScsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGb3JtSW5wdXRBdXRvY29tcGxldGVEaXJlY3RpdmUgZXh0ZW5kcyBEcm9wZG93bkRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgLyoqXHJcbiAgICogRnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgZWFjaCB0aW1lIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZC5cclxuICAgKiBJdCByZXR1cm5zIGFuIG9ic2VydmFibGUsIHdoaWNoIHJlc3VsdCBpcyBwcm92aWRlZCB0byB0aGUgZHJvcGRvd24gbGlzdCB0ZW1wbGF0ZVxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHJiRm9ybUlucHV0QXV0b2NvbXBsZXRlOiAodmFsdWU6IHN0cmluZykgPT4gT2JzZXJ2YWJsZTxzdHJpbmdbXT4gfCBudWxsO1xyXG5cclxuICAvKipcclxuICAgKiBBIHRlbXBsYXRlIHdoaWNoIHJlY2VpdmVzIGEgY29udGV4dCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczpcclxuICAgKiAtIGxpc3Q6IExpc3Qgb2YgcmVzdWx0c1xyXG4gICAqIC0gYWN0aXZlOiBUaGUgY3VycmVudGx5IGFjdGl2ZSB2YWx1ZVxyXG4gICAqIC0gZm9jdXM6IFRoZSBjdXJyZW50bHkgZm9jdXNlZCB2YWx1ZVxyXG4gICAqIC0gc2VsZWN0OiBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aXRoIHRoZSBzZWxlY3RlZCB2YWx1ZVxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHJiQXV0b2NvbXBsZXRlTGlzdDogVGVtcGxhdGVSZWY8YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICogU2hvdWxkIHRoZSBkcm9wZG93biBvcGVuIG9uIGluaXRpYWwgY2xpY2sgd2l0aG91dCBhbnkgdmFsdWUgY2hhbmdlXHJcbiAgICovXHJcbiAgQElucHV0KCkgcmJJbml0aWFsT3BlbiA9IGZhbHNlO1xyXG5cclxuICBASW5wdXQoKSByYkRlYm91bmNlVGltZSA9IDUwMDtcclxuXHJcbiAgcHJpdmF0ZSBkZXN0cm95ID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgbG9hZGluZyA9IGZhbHNlO1xyXG5cclxuICBlcnJvciA9IG51bGw7XHJcblxyXG4gIHByaXZhdGUgaW5zdGFuY2U6IEZvcm1JbnB1dEF1dG9jb21wbGV0ZUxpc3RDb21wb25lbnQ7XHJcblxyXG4gIHByaXZhdGUgbGFzdFJlc3VsdCA9IG51bGw7XHJcblxyXG4gIHByaXZhdGUgZm9jdXMgPSBudWxsO1xyXG5cclxuICBwcml2YXRlIGlucHV0OiBGb3JtSW5wdXRDb21wb25lbnQgPSBudWxsO1xyXG5cclxuICBwcml2YXRlIG5vU2VhcmNoRm9yID0gbnVsbDtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgICAgICAgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZixcclxuICAgICAgICAgICAgICBAU2VsZigpIHByaXZhdGUgY29udHJvbDogTmdDb250cm9sLFxyXG4gICAgICAgICAgICAgIEBTZWxmKCkgQE9wdGlvbmFsKCkgQEluamVjdChOR19WQUxVRV9BQ0NFU1NPUikgaW5wdXRzOiBGb3JtSW5wdXRDb21wb25lbnRbXVxyXG4gICkge1xyXG4gICAgc3VwZXIoX2ZhY3RvcnlSZXNvbHZlciwgdmlld0NvbnRhaW5lclJlZik7XHJcbiAgICBpZiAoaW5wdXRzKSB7XHJcbiAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dHNbMF07XHJcbiAgICB9XHJcbiAgICB0aGlzLm9wZW5PbkNsaWNrID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG5cclxuICAgIGlmICh0aGlzLnJiSW5pdGlhbE9wZW4pIHtcclxuICAgICAgdGhpcy5vcGVuT25DbGljayA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0aGlzLnJiQXV0b2NvbXBsZXRlTGlzdCkge1xyXG4gICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5fZmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KEZvcm1JbnB1dEF1dG9jb21wbGV0ZUxpc3RDb21wb25lbnQpO1xyXG4gICAgICBjb25zdCBjb21wb25lbnQgPSBmYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgICAgdGhpcy5pbnN0YW5jZSA9IGNvbXBvbmVudC5pbnN0YW5jZTtcclxuICAgICAgdGhpcy5yYkF1dG9jb21wbGV0ZUxpc3QgPSBjb21wb25lbnQuaW5zdGFuY2UudGVtcGxhdGU7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy50ZW1wbGF0ZSA9IHRoaXMucmJBdXRvY29tcGxldGVMaXN0O1xyXG5cclxuICAgIHRoaXMudXBkYXRlTG9hZGluZyhmYWxzZSwgbnVsbCk7XHJcblxyXG4gICAgbGV0IGNoYW5nZXMgPSAwO1xyXG4gICAgbGV0IHJlc29sdmVkVmFsdWUgPSBudWxsO1xyXG4gICAgdGhpcy5jb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKFxyXG4gICAgICBkZWJvdW5jZVRpbWUodGhpcy5yYkRlYm91bmNlVGltZSksXHJcbiAgICAgIHN3aXRjaE1hcCh2YWx1ZSA9PiB7XHJcbiAgICAgICAgY2hhbmdlcysrO1xyXG4gICAgICAgIGlmIChjaGFuZ2VzID09PSAxICYmICF0aGlzLnJiSW5pdGlhbE9wZW4gfHwgcmVzb2x2ZWRWYWx1ZSA9PT0gdmFsdWUgfHwgdGhpcy5ub1NlYXJjaEZvciA9PT0gdmFsdWUpIHtcclxuICAgICAgICAgIHJldHVybiBORVZFUjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVzb2x2ZWRWYWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgIHRoaXMudXBkYXRlTG9hZGluZyh0cnVlLCBudWxsKTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJiRm9ybUlucHV0QXV0b2NvbXBsZXRlKHZhbHVlKTtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVzdWx0LnBpcGUoXHJcbiAgICAgICAgICAgIHRhcChcclxuICAgICAgICAgICAgICAoKSA9PiB0aGlzLnVwZGF0ZUxvYWRpbmcoZmFsc2UsIG51bGwpLFxyXG4gICAgICAgICAgICAgIGVyciA9PiB0aGlzLnVwZGF0ZUxvYWRpbmcoZmFsc2UsIGVyciksXHJcbiAgICAgICAgICAgICAgKCkgPT4gdGhpcy51cGRhdGVMb2FkaW5nKGZhbHNlLCBudWxsKSksXHJcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IG9mKG51bGwpKSxcclxuICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMuY29udHJvbC52YWx1ZUNoYW5nZXMucGlwZShza2lwKDEpKSlcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMudXBkYXRlTG9hZGluZyhmYWxzZSwgbnVsbCk7XHJcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSlcclxuICAgICkuc3Vic2NyaWJlKHJlc3VsdHMgPT4ge1xyXG4gICAgICB0aGlzLm9wZW5PbkNsaWNrID0gdHJ1ZTtcclxuICAgICAgdGhpcy5sYXN0UmVzdWx0ID0gcmVzdWx0cztcclxuICAgICAgaWYgKHJlc3VsdHMgIT09IG51bGwgJiYgIXJlc3VsdHMuaW5jbHVkZXMocmVzb2x2ZWRWYWx1ZSkpIHtcclxuICAgICAgICB0aGlzLmZvY3VzID0gbnVsbDtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnVwZGF0ZUNvbnRleHQodGhpcy5jb250cm9sLnZhbHVlKTtcclxuICAgICAgaWYgKHJlc3VsdHMgIT09IG51bGwgJiYgKCF0aGlzLmNvbXBvbmVudFJlZiB8fCAhdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2Uuc2hvd24pICYmIGNoYW5nZXMgPiAxKSB7XHJcbiAgICAgICAgdGhpcy5vcGVuRHJvcGRvd24oKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAocmVzdWx0cyA9PT0gbnVsbCkge1xyXG4gICAgICAgIHRoaXMuY2xvc2VEcm9wZG93bigpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5pbnB1dCAmJiB0aGlzLmlucHV0LmlucHV0KSB7XHJcbiAgICAgIHRoaXMuaW5wdXQuaW5wdXQubmF0aXZlRWxlbWVudC5hdXRvY29tcGxldGUgPSAnb2ZmJztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVwZGF0ZUxvYWRpbmcobG9hZGluZzogYm9vbGVhbiwgZXJyb3I6IGFueSkge1xyXG4gICAgdGhpcy5sb2FkaW5nID0gbG9hZGluZztcclxuICAgIHRoaXMuZXJyb3IgPSBlcnJvcjtcclxuICAgIGlmICh0aGlzLmVycm9yKSB7XHJcbiAgICAgIGNvbnN0IGVycm9ycyA9IHRoaXMuY29udHJvbC5lcnJvcnMgfHwge307XHJcbiAgICAgIGVycm9yc1snYXV0b2NvbXBsZXRlJ10gPSB0aGlzLmVycm9yO1xyXG4gICAgICB0aGlzLmNvbnRyb2wuY29udHJvbC5zZXRFcnJvcnMoZXJyb3JzKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmlucHV0ICYmIHRoaXMubG9hZGluZykge1xyXG4gICAgICB0aGlzLmlucHV0LnVwZGF0ZUljb24oJ3JiLWljIHJiLWljLXNwaW4gcmItaWMtcmVmcmVzaCcpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuaW5wdXQgJiYgIXRoaXMubG9hZGluZykge1xyXG4gICAgICB0aGlzLmlucHV0LnVwZGF0ZUljb24odGhpcy5yYkluaXRpYWxPcGVuID8gJ3NlbGVjdC1pY29uIHJiLWljIHJiLWljLWRvd24nIDogbnVsbCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5pbnB1dCAmJiB0aGlzLmVycm9yKSB7XHJcbiAgICAgIHRoaXMuaW5wdXQudXBkYXRlSWNvbigncmItaWMgcmItaWMtYWxlcnQtd2FybmluZyB1LVRleHRDb2xvci0tcmVkJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZWxlY3QodmFsdWU6IHN0cmluZykge1xyXG4gICAgdGhpcy5ub1NlYXJjaEZvciA9IHZhbHVlO1xyXG4gICAgdGhpcy5jb250cm9sLmNvbnRyb2wuc2V0VmFsdWUodmFsdWUpO1xyXG4gICAgdGhpcy5mb2N1cyA9IHZhbHVlO1xyXG4gICAgdGhpcy5jbG9zZURyb3Bkb3duKCk7XHJcbiAgICB0aGlzLnVwZGF0ZUNvbnRleHQodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcigna2V5dXAnLCBbJyRldmVudCddKVxyXG4gIG9uS2V5VXAoZTogS2V5Ym9hcmRFdmVudCkge1xyXG4gICAgaWYgKGUua2V5ID09PSAnQXJyb3dEb3duJyB8fCBlLmtleSA9PT0gJ0Rvd24nKSB7XHJcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgdGhpcy5tb3ZlRm9jdXMoMSk7XHJcbiAgICB9XHJcbiAgICBpZiAoZS5rZXkgPT09ICdBcnJvd1VwJyB8fCBlLmtleSA9PT0gJ1VwJykge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIHRoaXMubW92ZUZvY3VzKC0xKTtcclxuICAgIH1cclxuICAgIGlmIChlLmtleSA9PT0gJ0VudGVyJyAmJiB0aGlzLmNvbXBvbmVudFJlZiAmJiB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5zaG93bikge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIHRoaXMuc2VsZWN0KHRoaXMuZm9jdXMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBtb3ZlRm9jdXMoYnk6IG51bWJlcikge1xyXG4gICAgY29uc3QgbGlzdCA9IHRoaXMubGFzdFJlc3VsdCB8fCBbXTtcclxuICAgIGlmICghbGlzdC5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5mb2N1cyA9IG51bGw7XHJcbiAgICAgIHRoaXMudXBkYXRlQ29udGV4dCh0aGlzLmNvbnRyb2wudmFsdWUpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgZm9jdXNJbmRleCA9IGxpc3QuaW5kZXhPZih0aGlzLmZvY3VzKTtcclxuICAgIGlmIChmb2N1c0luZGV4ID09PSAtMSkge1xyXG4gICAgICBmb2N1c0luZGV4ID0gMDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZvY3VzSW5kZXggKz0gYnk7XHJcbiAgICAgIGlmIChmb2N1c0luZGV4ID09PSAtMSkge1xyXG4gICAgICAgIGZvY3VzSW5kZXggPSBsaXN0Lmxlbmd0aCAtIDE7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGZvY3VzSW5kZXggPT09IGxpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgZm9jdXNJbmRleCA9IDA7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmZvY3VzID0gbGlzdFtmb2N1c0luZGV4XTtcclxuICAgIHRoaXMudXBkYXRlQ29udGV4dCh0aGlzLmNvbnRyb2wudmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVDb250ZXh0KHZhbHVlKSB7XHJcbiAgICB0aGlzLmNvbnRleHQgPSB7XHJcbiAgICAgIGxpc3Q6IHRoaXMubGFzdFJlc3VsdCxcclxuICAgICAgYWN0aXZlOiB2YWx1ZSxcclxuICAgICAgZm9jdXM6IHRoaXMuZm9jdXMsXHJcbiAgICAgIHNlbGVjdDogdGhpcy5zZWxlY3QuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgc3VwZXIubmdPbkRlc3Ryb3koKTtcclxuICAgIHRoaXMuZGVzdHJveS5jb21wbGV0ZSgpO1xyXG4gICAgdGhpcy5pbnB1dCA9IG51bGw7XHJcbiAgfVxyXG59XHJcbiJdfQ==