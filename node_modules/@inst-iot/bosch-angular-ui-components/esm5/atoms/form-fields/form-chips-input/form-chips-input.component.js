import * as tslib_1 from "tslib";
import { Component, forwardRef, Input, Output, EventEmitter, TemplateRef, Renderer2, ElementRef, ContentChildren, QueryList, ViewChild, HostListener } from '@angular/core';
import { FormValidationMessageDirective } from '../form-validation-message.directive';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { emptyFunction } from '../forms-util';
var FormChipsInputComponent = /** @class */ (function () {
    function FormChipsInputComponent(renderer, elementRef) {
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.chips = [];
        this.chipInput = '';
        this.id = 'input.' + Math.random();
        this.disabled = false;
        this.activeIndex = null;
        this.mouseIn = false;
        this.deletingLast = false;
        this.label = null;
        this.placeholder = '';
        this.chipAdded = new EventEmitter();
        this.chipDeleted = new EventEmitter();
        this.onChange = emptyFunction;
        this.onTouched = emptyFunction;
    }
    FormChipsInputComponent_1 = FormChipsInputComponent;
    Object.defineProperty(FormChipsInputComponent.prototype, "setFocus", {
        set: function (val) {
            if (this.input && 'nativeElement' in this.input) {
                this.input.nativeElement.focus();
            }
        },
        enumerable: true,
        configurable: true
    });
    FormChipsInputComponent.prototype.onMouseEnter = function () {
        this.mouseIn = true;
    };
    FormChipsInputComponent.prototype.onMouseLeave = function () {
        this.mouseIn = false;
    };
    FormChipsInputComponent.prototype.onAnyClick = function () {
        if (this.activeIndex !== null && !this.mouseIn) {
            this.activeIndex = null;
        }
    };
    FormChipsInputComponent.prototype.onKeydownHandler = function (event) {
        if (this.activeIndex !== null && !this.deletingLast && event.key === 'Backspace') {
            event.preventDefault();
            this.removeAtIndex(this.activeIndex);
        }
    };
    FormChipsInputComponent.prototype.isLabelTemplate = function () {
        return this.label instanceof TemplateRef;
    };
    FormChipsInputComponent.prototype.writeValue = function (value) {
        this.chips = value || [];
        this.checkState();
        this.renderer.setProperty(this.input.nativeElement, 'value', '');
    };
    FormChipsInputComponent.prototype.registerOnChange = function (fn) {
        this.onChange = fn;
    };
    FormChipsInputComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    FormChipsInputComponent.prototype.setDisabledState = function (isDisabled) {
        this.disabled = isDisabled;
        this.renderer.setProperty(this.input.nativeElement, 'disabled', isDisabled);
    };
    FormChipsInputComponent.prototype.checkState = function () {
        if (this.chips && this.chips.length > 0) {
            this.renderer.addClass(this.elementRef.nativeElement, 'not-empty');
        }
        else {
            this.renderer.removeClass(this.elementRef.nativeElement, 'not-empty');
        }
    };
    FormChipsInputComponent.prototype.submit = function () {
        if (this.chipInput !== '') {
            this.addChip(this.chipInput);
            this.chipInput = '';
        }
    };
    FormChipsInputComponent.prototype.onKeyDown = function (e) {
        if (e.key === 'Backspace' && this.chipInput === '') {
            e.preventDefault();
            if (this.activeIndex !== null) {
                this.removeLast();
                this.checkState();
            }
            else {
                this.deletingLast = true;
                this.activeIndex = this.chips.length - 1;
            }
        }
    };
    FormChipsInputComponent.prototype.onBlur = function () {
        if (this.chipInput !== '') {
            this.addChip(this.chipInput);
            this.chipInput = '';
        }
        this.onTouched();
    };
    FormChipsInputComponent.prototype.addChip = function (chip) {
        this.chips.push(chip.trim());
        this.onChange(this.chips);
        this.checkState();
        this.chipAdded.next(chip);
    };
    FormChipsInputComponent.prototype.removeChip = function (chip) {
        var index = this.chips.indexOf(chip);
        if (index !== -1) {
            this.chips.splice(index, 1);
            this.onChange(this.chips);
            this.checkState();
            this.chipDeleted.next(chip);
        }
    };
    FormChipsInputComponent.prototype.removeLast = function () {
        var lastChip = this.chips[this.chips.length - 1];
        this.chips.splice(-1, 1);
        this.activeIndex = null;
        this.deletingLast = false;
        this.onChange(this.chips);
        this.chipDeleted.next(lastChip);
    };
    FormChipsInputComponent.prototype.removeAtIndex = function (i) {
        var chipAtIndex = this.chips[i];
        this.chips.splice(i, 1);
        this.activeIndex = null;
        this.onChange(this.chips);
        this.chipDeleted.next(chipAtIndex);
    };
    var FormChipsInputComponent_1;
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormChipsInputComponent.prototype, "label", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormChipsInputComponent.prototype, "placeholder", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String),
        tslib_1.__metadata("design:paramtypes", [String])
    ], FormChipsInputComponent.prototype, "setFocus", null);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], FormChipsInputComponent.prototype, "chipAdded", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], FormChipsInputComponent.prototype, "chipDeleted", void 0);
    tslib_1.__decorate([
        ContentChildren(FormValidationMessageDirective),
        tslib_1.__metadata("design:type", QueryList)
    ], FormChipsInputComponent.prototype, "messages", void 0);
    tslib_1.__decorate([
        ViewChild('input', { static: true }),
        tslib_1.__metadata("design:type", ElementRef)
    ], FormChipsInputComponent.prototype, "input", void 0);
    tslib_1.__decorate([
        ViewChild('chipcontainer', { static: false }),
        tslib_1.__metadata("design:type", ElementRef)
    ], FormChipsInputComponent.prototype, "chipcontainer", void 0);
    tslib_1.__decorate([
        HostListener('mouseenter'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", []),
        tslib_1.__metadata("design:returntype", void 0)
    ], FormChipsInputComponent.prototype, "onMouseEnter", null);
    tslib_1.__decorate([
        HostListener('mouseleave'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", []),
        tslib_1.__metadata("design:returntype", void 0)
    ], FormChipsInputComponent.prototype, "onMouseLeave", null);
    tslib_1.__decorate([
        HostListener('window:click'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", []),
        tslib_1.__metadata("design:returntype", void 0)
    ], FormChipsInputComponent.prototype, "onAnyClick", null);
    tslib_1.__decorate([
        HostListener('document:keydown', ['$event']),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [KeyboardEvent]),
        tslib_1.__metadata("design:returntype", void 0)
    ], FormChipsInputComponent.prototype, "onKeydownHandler", null);
    FormChipsInputComponent = FormChipsInputComponent_1 = tslib_1.__decorate([
        Component({
            selector: 'rb-form-chips-input',
            template: "<div class=\"input-wrapper d-flex\" [class.no-label]=\"!label\">\r\n  <div class=\"chips\">\r\n    <ng-container *ngFor=\"let chip of chips; let i = index\">\r\n      <div (click)=\"activeIndex = i\" [ngClass]=\"{'disabled': disabled, 'selected': activeIndex === i}\"\r\n           class=\"rb-chip mr-1\">\r\n        <span>{{chip}}</span>\r\n        <a href=\"javascript:\" (click)=\"removeChip(chip)\" style=\"margin-left: 4px;\"><span\r\n          class=\"rb-ic rb-ic-close\"></span></a>\r\n      </div>\r\n    </ng-container>\r\n  </div>\r\n  <form (ngSubmit)=\"submit()\" class=\"flex-grow-1\">\r\n    <input #input class=\"input chips-input\" [id]=\"id\" (click)=\"activeIndex = null\"\r\n           (keydown)=\"onKeyDown($event)\"\r\n           (blur)=\"onBlur()\"\r\n           [(ngModel)]=\"chipInput\"\r\n           [placeholder]=\"placeholder\"\r\n           [ngStyle]=\"{'margin-left': chips.length == 0 ? 0 : '1rem'}\"\r\n           name=\"chipInput\"\r\n           type=\"text\"\r\n           minlength=\"1\">\r\n    <label class=\"label\" [for]=\"id\">{{!isLabelTemplate() ? label : ''}}</label>\r\n    <span class=\"input-background\"></span>\r\n  </form>\r\n</div>\r\n<rb-form-errors [messages]=\"messages\"></rb-form-errors>\r\n",
            providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(function () { return FormChipsInputComponent_1; }), multi: true }]
        }),
        tslib_1.__metadata("design:paramtypes", [Renderer2, ElementRef])
    ], FormChipsInputComponent);
    return FormChipsInputComponent;
}());
export { FormChipsInputComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1jaGlwcy1pbnB1dC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaW5zdC1pb3QvYm9zY2gtYW5ndWxhci11aS1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiYXRvbXMvZm9ybS1maWVsZHMvZm9ybS1jaGlwcy1pbnB1dC9mb3JtLWNoaXBzLWlucHV0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFDVixVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osV0FBVyxFQUNYLFNBQVMsRUFDVCxVQUFVLEVBQ1YsZUFBZSxFQUNmLFNBQVMsRUFDVCxTQUFTLEVBQ1QsWUFBWSxFQUNaLE1BQU0sZUFBZSxDQUFDO0FBQzlCLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3RGLE9BQU8sRUFBd0IsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBTzlDO0lBb0RFLGlDQUFvQixRQUFtQixFQUFVLFVBQXNCO1FBQW5ELGFBQVEsR0FBUixRQUFRLENBQVc7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBbER2RSxVQUFLLEdBQWEsRUFBRSxDQUFDO1FBQ3JCLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixPQUFFLEdBQUcsUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUM5QixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLGdCQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ1gsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUN4QixpQkFBWSxHQUFHLEtBQUssQ0FBQztRQUVaLFVBQUssR0FBOEIsSUFBSSxDQUFDO1FBRXhDLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBU2hCLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO1FBQ3ZDLGdCQUFXLEdBQUcsSUFB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LEVBQUU7O2dFQUFrQjtJQUcxQjtRQURDLEtBQUssRUFBRTs7OzJEQUtQO0lBRVM7UUFBVCxNQUFNLEVBQUU7OzhEQUF3QztJQUN2QztRQUFULE1BQU0sRUFBRTs7Z0VBQTBDO0lBRUY7UUFBaEQsZUFBZSxDQUFDLDhCQUE4QixDQUFDOzBDQUFXLFNBQVM7NkRBQWlDO0lBQy9EO1FBQXJDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7MENBQVEsVUFBVTswREFBQztJQUNUO1FBQTlDLFNBQVMsQ0FBQyxlQUFlLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7MENBQWdCLFVBQVU7a0VBQUM7SUFLN0M7UUFBM0IsWUFBWSxDQUFDLFlBQVksQ0FBQzs7OzsrREFFMUI7SUFFMkI7UUFBM0IsWUFBWSxDQUFDLFlBQVksQ0FBQzs7OzsrREFFMUI7SUFFNkI7UUFBN0IsWUFBWSxDQUFDLGNBQWMsQ0FBQzs7Ozs2REFJNUI7SUFFNkM7UUFBN0MsWUFBWSxDQUFDLGtCQUFrQixFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7O2lEQUF5QixhQUFhOzttRUFLbEY7SUFsRFUsdUJBQXVCO1FBTG5DLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxxQkFBcUI7WUFDL0IseXVDQUFnRDtZQUNoRCxTQUFTLEVBQUUsQ0FBQyxFQUFDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLGNBQU0sT0FBQSx5QkFBdUIsRUFBdkIsQ0FBdUIsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQztTQUMvRyxDQUFDO2lEQXFEOEIsU0FBUyxFQUFzQixVQUFVO09BcEQ1RCx1QkFBdUIsQ0FtSm5DO0lBQUQsOEJBQUM7Q0FBQSxBQW5KRCxJQW1KQztTQW5KWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsXHJcbiAgICAgICAgZm9yd2FyZFJlZixcclxuICAgICAgICBJbnB1dCxcclxuICAgICAgICBPdXRwdXQsXHJcbiAgICAgICAgRXZlbnRFbWl0dGVyLFxyXG4gICAgICAgIFRlbXBsYXRlUmVmLFxyXG4gICAgICAgIFJlbmRlcmVyMixcclxuICAgICAgICBFbGVtZW50UmVmLFxyXG4gICAgICAgIENvbnRlbnRDaGlsZHJlbixcclxuICAgICAgICBRdWVyeUxpc3QsXHJcbiAgICAgICAgVmlld0NoaWxkLFxyXG4gICAgICAgIEhvc3RMaXN0ZW5lclxyXG4gICAgICAgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRm9ybVZhbGlkYXRpb25NZXNzYWdlRGlyZWN0aXZlIH0gZnJvbSAnLi4vZm9ybS12YWxpZGF0aW9uLW1lc3NhZ2UuZGlyZWN0aXZlJztcclxuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBlbXB0eUZ1bmN0aW9uIH0gZnJvbSAnLi4vZm9ybXMtdXRpbCc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3JiLWZvcm0tY2hpcHMtaW5wdXQnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9mb3JtLWNoaXBzLWlucHV0LmNvbXBvbmVudC5odG1sJyxcclxuICBwcm92aWRlcnM6IFt7cHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IEZvcm1DaGlwc0lucHV0Q29tcG9uZW50KSwgbXVsdGk6IHRydWV9XVxyXG59KVxyXG5leHBvcnQgY2xhc3MgRm9ybUNoaXBzSW5wdXRDb21wb25lbnQgaW1wbGVtZW50cyBDb250cm9sVmFsdWVBY2Nlc3NvciB7XHJcblxyXG4gIGNoaXBzOiBzdHJpbmdbXSA9IFtdO1xyXG4gIGNoaXBJbnB1dCA9ICcnO1xyXG4gIGlkID0gJ2lucHV0LicgKyBNYXRoLnJhbmRvbSgpO1xyXG4gIGRpc2FibGVkID0gZmFsc2U7XHJcbiAgYWN0aXZlSW5kZXggPSBudWxsO1xyXG4gIHByaXZhdGUgbW91c2VJbiA9IGZhbHNlO1xyXG4gIGRlbGV0aW5nTGFzdCA9IGZhbHNlO1xyXG5cclxuICBASW5wdXQoKSBsYWJlbDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9IG51bGw7XHJcblxyXG4gIEBJbnB1dCgpIHBsYWNlaG9sZGVyID0gJyc7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgc2V0IHNldEZvY3VzKHZhbDogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpcy5pbnB1dCAmJiAnbmF0aXZlRWxlbWVudCcgaW4gdGhpcy5pbnB1dCkge1xyXG4gICAgICB0aGlzLmlucHV0Lm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBPdXRwdXQoKSBjaGlwQWRkZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuICBAT3V0cHV0KCkgY2hpcERlbGV0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuXHJcbiAgQENvbnRlbnRDaGlsZHJlbihGb3JtVmFsaWRhdGlvbk1lc3NhZ2VEaXJlY3RpdmUpIG1lc3NhZ2VzOiBRdWVyeUxpc3Q8Rm9ybVZhbGlkYXRpb25NZXNzYWdlRGlyZWN0aXZlPjtcclxuICBAVmlld0NoaWxkKCdpbnB1dCcsIHsgc3RhdGljOiB0cnVlIH0pIGlucHV0OiBFbGVtZW50UmVmO1xyXG4gIEBWaWV3Q2hpbGQoJ2NoaXBjb250YWluZXInLCB7IHN0YXRpYzogZmFsc2UgfSkgY2hpcGNvbnRhaW5lcjogRWxlbWVudFJlZjtcclxuXHJcbiAgb25DaGFuZ2UgPSBlbXB0eUZ1bmN0aW9uO1xyXG4gIG9uVG91Y2hlZCA9IGVtcHR5RnVuY3Rpb247XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ21vdXNlZW50ZXInKSBvbk1vdXNlRW50ZXIoKSB7XHJcbiAgICB0aGlzLm1vdXNlSW4gPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignbW91c2VsZWF2ZScpIG9uTW91c2VMZWF2ZSgpIHtcclxuICAgIHRoaXMubW91c2VJbiA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignd2luZG93OmNsaWNrJykgb25BbnlDbGljaygpIHtcclxuICAgIGlmICh0aGlzLmFjdGl2ZUluZGV4ICE9PSBudWxsICYmICF0aGlzLm1vdXNlSW4pIHtcclxuICAgICAgdGhpcy5hY3RpdmVJbmRleCA9IG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDprZXlkb3duJywgWyckZXZlbnQnXSkgb25LZXlkb3duSGFuZGxlcihldmVudDogS2V5Ym9hcmRFdmVudCkge1xyXG4gICAgICBpZiAodGhpcy5hY3RpdmVJbmRleCAhPT0gbnVsbCAmJiAhdGhpcy5kZWxldGluZ0xhc3QgJiYgZXZlbnQua2V5ID09PSAnQmFja3NwYWNlJykge1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVBdEluZGV4KHRoaXMuYWN0aXZlSW5kZXgpO1xyXG4gICAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsIHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZikgeyB9XHJcblxyXG4gIGlzTGFiZWxUZW1wbGF0ZSgpIHtcclxuICAgIHJldHVybiB0aGlzLmxhYmVsIGluc3RhbmNlb2YgVGVtcGxhdGVSZWY7XHJcbiAgfVxyXG5cclxuICB3cml0ZVZhbHVlKHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hpcHMgPSB2YWx1ZSB8fCBbXTtcclxuICAgIHRoaXMuY2hlY2tTdGF0ZSgpO1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmlucHV0Lm5hdGl2ZUVsZW1lbnQsICd2YWx1ZScsICcnKTtcclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46IChfOiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB0aGlzLm9uVG91Y2hlZCA9IGZuO1xyXG4gIH1cclxuXHJcbiAgc2V0RGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc2FibGVkID0gaXNEaXNhYmxlZDtcclxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5pbnB1dC5uYXRpdmVFbGVtZW50LCAnZGlzYWJsZWQnLCBpc0Rpc2FibGVkKTtcclxuICB9XHJcblxyXG4gIGNoZWNrU3RhdGUoKSB7XHJcbiAgICBpZiAodGhpcy5jaGlwcyAmJiB0aGlzLmNoaXBzLmxlbmd0aCA+IDApIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ25vdC1lbXB0eScpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ25vdC1lbXB0eScpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc3VibWl0KCkge1xyXG4gICAgaWYgKHRoaXMuY2hpcElucHV0ICE9PSAnJykge1xyXG4gICAgICB0aGlzLmFkZENoaXAodGhpcy5jaGlwSW5wdXQpO1xyXG4gICAgICB0aGlzLmNoaXBJbnB1dCA9ICcnO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb25LZXlEb3duKGUpIHtcclxuICAgIGlmIChlLmtleSA9PT0gJ0JhY2tzcGFjZScgJiYgdGhpcy5jaGlwSW5wdXQgPT09ICcnKSB7XHJcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgaWYgKHRoaXMuYWN0aXZlSW5kZXggIT09IG51bGwpIHtcclxuICAgICAgICAgdGhpcy5yZW1vdmVMYXN0KCk7XHJcbiAgICAgICAgIHRoaXMuY2hlY2tTdGF0ZSgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuZGVsZXRpbmdMYXN0ID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLmFjdGl2ZUluZGV4ID0gdGhpcy5jaGlwcy5sZW5ndGggLSAxO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBvbkJsdXIoKSB7XHJcbiAgICBpZiAodGhpcy5jaGlwSW5wdXQgIT09ICcnKSB7XHJcbiAgICAgIHRoaXMuYWRkQ2hpcCh0aGlzLmNoaXBJbnB1dCk7XHJcbiAgICAgIHRoaXMuY2hpcElucHV0ID0gJyc7XHJcbiAgICB9XHJcbiAgICB0aGlzLm9uVG91Y2hlZCgpO1xyXG4gIH1cclxuXHJcbiAgYWRkQ2hpcChjaGlwOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuY2hpcHMucHVzaChjaGlwLnRyaW0oKSk7XHJcbiAgICB0aGlzLm9uQ2hhbmdlKHRoaXMuY2hpcHMpO1xyXG4gICAgdGhpcy5jaGVja1N0YXRlKCk7XHJcbiAgICB0aGlzLmNoaXBBZGRlZC5uZXh0KGNoaXApO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlQ2hpcChjaGlwOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5jaGlwcy5pbmRleE9mKGNoaXApO1xyXG4gICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICB0aGlzLmNoaXBzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgIHRoaXMub25DaGFuZ2UodGhpcy5jaGlwcyk7XHJcbiAgICAgIHRoaXMuY2hlY2tTdGF0ZSgpO1xyXG4gICAgICB0aGlzLmNoaXBEZWxldGVkLm5leHQoY2hpcCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZW1vdmVMYXN0KCkge1xyXG4gICAgY29uc3QgbGFzdENoaXAgPSB0aGlzLmNoaXBzW3RoaXMuY2hpcHMubGVuZ3RoIC0gMV07XHJcbiAgICB0aGlzLmNoaXBzLnNwbGljZSgtMSwgMSk7XHJcbiAgICB0aGlzLmFjdGl2ZUluZGV4ID0gbnVsbDtcclxuICAgIHRoaXMuZGVsZXRpbmdMYXN0ID0gZmFsc2U7XHJcbiAgICB0aGlzLm9uQ2hhbmdlKHRoaXMuY2hpcHMpO1xyXG4gICAgdGhpcy5jaGlwRGVsZXRlZC5uZXh0KGxhc3RDaGlwKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUF0SW5kZXgoaTogbnVtYmVyKSB7XHJcbiAgICBjb25zdCBjaGlwQXRJbmRleCA9IHRoaXMuY2hpcHNbaV07XHJcbiAgICB0aGlzLmNoaXBzLnNwbGljZShpLCAxKTtcclxuICAgIHRoaXMuYWN0aXZlSW5kZXggPSBudWxsO1xyXG4gICAgdGhpcy5vbkNoYW5nZSh0aGlzLmNoaXBzKTtcclxuICAgIHRoaXMuY2hpcERlbGV0ZWQubmV4dChjaGlwQXRJbmRleCk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=