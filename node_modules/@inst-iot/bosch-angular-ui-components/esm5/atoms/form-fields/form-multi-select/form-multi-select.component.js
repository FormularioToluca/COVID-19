import * as tslib_1 from "tslib";
import { Component, ContentChild, ContentChildren, Directive, ElementRef, forwardRef, HostListener, Input, QueryList, Renderer2, TemplateRef } from '@angular/core';
import { FormValidationMessageDirective } from '../form-validation-message.directive';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { emptyFunction } from '../forms-util';
var MultiSelectOptionDirective = /** @class */ (function () {
    function MultiSelectOptionDirective(templateRef) {
        this.templateRef = templateRef;
    }
    MultiSelectOptionDirective = tslib_1.__decorate([
        Directive({
            selector: '[rbFormMultiSelectOption]'
        }),
        tslib_1.__metadata("design:paramtypes", [TemplateRef])
    ], MultiSelectOptionDirective);
    return MultiSelectOptionDirective;
}());
export { MultiSelectOptionDirective };
var MultiSelectTitleDirective = /** @class */ (function () {
    function MultiSelectTitleDirective(templateRef) {
        this.templateRef = templateRef;
    }
    MultiSelectTitleDirective = tslib_1.__decorate([
        Directive({
            selector: '[rbFormMultiSelectTitle]'
        }),
        tslib_1.__metadata("design:paramtypes", [TemplateRef])
    ], MultiSelectTitleDirective);
    return MultiSelectTitleDirective;
}());
export { MultiSelectTitleDirective };
/**
 * Use this component to have multiple selections.
 * The value is a map of id -> state.
 * The items are an array of objects.
 * To identify the id of an object from the items array, provide the idField.
 */
var FormMultiSelectComponent = /** @class */ (function () {
    function FormMultiSelectComponent(renderer, elementRef) {
        var _this = this;
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.label = null;
        this.id = 'multiSelect.' + Math.random();
        this.selectAllLabel = 'Select all';
        this.isMouseOver = false;
        /**
         * Property name of the property that contains the unique value of an item
         * Otherwise the JSON rep is used as value
         */
        this.idField = null;
        /**
         * What states should be offered per item
         * check: just checked(true) and unchecked(false)
         * optCheck: unchecked(null), include(true), exclude(false)
         */
        this.statesMode = 'check';
        this.numStates = 2;
        this._states = {
            'check': [false, true],
            'optCheck': [null, false, true]
        };
        this.maxItemsPreview = 3;
        this.allStates = null;
        this.countNotDefState = 0;
        this.firstNotDefStateItem = null;
        this._value = {};
        this.titleContext = {
            $implicit: null,
            count: 0,
            firstItem: null,
            states: null
        };
        this.onChange = emptyFunction;
        this.onTouched = emptyFunction;
        this.getItemTrackId = function (i, item) {
            return _this.getItemId(item.item);
        };
    }
    FormMultiSelectComponent_1 = FormMultiSelectComponent;
    FormMultiSelectComponent.prototype.ngOnInit = function () {
        var states = this.getStates();
        this.numStates = states.length;
        this.allStates = states[0];
    };
    FormMultiSelectComponent.prototype.isLabelTemplate = function () {
        return this.label instanceof TemplateRef;
    };
    Object.defineProperty(FormMultiSelectComponent.prototype, "items", {
        set: function (items) {
            var _this = this;
            var states = this.getStates();
            this._items = items.map(function (item) {
                var id = _this.getItemId(item);
                var state = states[0];
                if (_this._value && _this._value[id] !== undefined) {
                    state = _this._value[id];
                }
                return {
                    item: item,
                    state: state
                };
            });
            this.doOnChanges();
        },
        enumerable: true,
        configurable: true
    });
    FormMultiSelectComponent.prototype.getItemId = function (item) {
        if (this.idField && item) {
            return item[this.idField];
        }
        else {
            return JSON.stringify(item);
        }
    };
    FormMultiSelectComponent.prototype.getStates = function () {
        return this._states[this.statesMode];
    };
    FormMultiSelectComponent.prototype.allStatesChange = function (state) {
        this.allStates = state;
        if (!this._items) {
            return;
        }
        this._items.forEach(function (item) {
            item.state = state;
        });
        this.notifyChanges();
    };
    FormMultiSelectComponent.prototype.updateStateOfItem = function (item, state) {
        item.state = state;
        if (this._items.some(function (d) { return d.state !== state; })) {
            var states = this.getStates();
            this.allStates = states[0];
        }
        else {
            this.allStates = state;
        }
        this.notifyChanges();
    };
    FormMultiSelectComponent.prototype.getCurrentStatesObject = function () {
        var _this = this;
        var states = {};
        this._items.forEach(function (item) {
            var id = _this.getItemId(item.item);
            states[id] = item.state;
        });
        return states;
    };
    FormMultiSelectComponent.prototype.doOnChanges = function () {
        var _this = this;
        this.firstNotDefStateItem = null;
        this.countNotDefState = 0;
        var states = this.getStates();
        if (!this._items) {
            return;
        }
        this._items.forEach(function (item) {
            if (item.state !== states[0]) {
                _this.countNotDefState++;
                if (_this.firstNotDefStateItem === null) {
                    _this.firstNotDefStateItem = item;
                }
            }
        });
        this.titleContext = {
            $implicit: this._items,
            count: this.countNotDefState,
            firstItem: this.firstNotDefStateItem,
            states: this._value
        };
        if (this.countNotDefState === 0 && this.selectAllLabel === '') {
            this.renderer.removeClass(this.elementRef.nativeElement, 'not-empty');
        }
        else {
            this.renderer.addClass(this.elementRef.nativeElement, 'not-empty');
        }
    };
    FormMultiSelectComponent.prototype.notifyChanges = function () {
        this.doOnChanges();
        this.onChange(this.getCurrentStatesObject());
    };
    FormMultiSelectComponent.prototype.mouseover = function () {
        this.isMouseOver = true;
    };
    FormMultiSelectComponent.prototype.mouseleave = function () {
        this.isMouseOver = false;
    };
    FormMultiSelectComponent.prototype.writeValue = function (items) {
        var _this = this;
        this._value = items;
        if (items) {
            var states_1 = this.getStates();
            this._items.forEach(function (item) {
                var id = _this.getItemId(item.item);
                if (items[id] !== undefined) {
                    item.state = items[id];
                }
                else {
                    item.state = states_1[0];
                }
            });
        }
        this.doOnChanges();
    };
    FormMultiSelectComponent.prototype.registerOnChange = function (fn) {
        this.onChange = fn;
    };
    FormMultiSelectComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    FormMultiSelectComponent.prototype.setDisabledState = function (isDisabled) {
        this.disabled = isDisabled;
    };
    var FormMultiSelectComponent_1;
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], FormMultiSelectComponent.prototype, "name", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormMultiSelectComponent.prototype, "label", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormMultiSelectComponent.prototype, "selectAllLabel", void 0);
    tslib_1.__decorate([
        ContentChildren(FormValidationMessageDirective),
        tslib_1.__metadata("design:type", QueryList)
    ], FormMultiSelectComponent.prototype, "messages", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], FormMultiSelectComponent.prototype, "idField", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], FormMultiSelectComponent.prototype, "statesMode", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], FormMultiSelectComponent.prototype, "maxItemsPreview", void 0);
    tslib_1.__decorate([
        ContentChild(MultiSelectOptionDirective, { static: false }),
        tslib_1.__metadata("design:type", MultiSelectOptionDirective)
    ], FormMultiSelectComponent.prototype, "option", void 0);
    tslib_1.__decorate([
        ContentChild(MultiSelectTitleDirective, { static: false }),
        tslib_1.__metadata("design:type", MultiSelectTitleDirective)
    ], FormMultiSelectComponent.prototype, "title", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Array),
        tslib_1.__metadata("design:paramtypes", [Array])
    ], FormMultiSelectComponent.prototype, "items", null);
    tslib_1.__decorate([
        HostListener('mouseenter'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", []),
        tslib_1.__metadata("design:returntype", void 0)
    ], FormMultiSelectComponent.prototype, "mouseover", null);
    tslib_1.__decorate([
        HostListener('mouseleave'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", []),
        tslib_1.__metadata("design:returntype", void 0)
    ], FormMultiSelectComponent.prototype, "mouseleave", null);
    FormMultiSelectComponent = FormMultiSelectComponent_1 = tslib_1.__decorate([
        Component({
            selector: 'rb-form-multi-select',
            template: "<div class=\"input-wrapper\" [class.no-label]=\"!label\">\r\n\r\n  <button [rbDropdown]=\"dropdownContent\"\r\n          [id]=\"id\"\r\n          [autoClose]=\"false\"\r\n          [disabled]=\"disabled !== undefined\"\r\n          (blur)=\"onTouched()\"\r\n          class=\"rb-select-btn input\">\r\n\r\n    <ng-container *ngIf=\"title\">\r\n      <ng-container *ngTemplateOutlet=\"title.templateRef; context: titleContext\"></ng-container>\r\n    </ng-container>\r\n    <ng-container *ngIf=\"!title\">\r\n      <ng-container *ngIf=\"titleContext.count === 1\">\r\n        <ng-container *ngIf=\"option\">\r\n          <ng-container\r\n            *ngTemplateOutlet=\"option.templateRef; context: {$implicit: titleContext.firstItem.item}\"></ng-container>\r\n        </ng-container>\r\n        <ng-container *ngIf=\"!option\">\r\n          {{titleContext.firstItem.item | json}}\r\n        </ng-container>\r\n      </ng-container>\r\n      <ng-container *ngIf=\"titleContext.count > 1\">{{titleContext.count}} items selected</ng-container>\r\n    </ng-container>\r\n\r\n  </button>\r\n\r\n  <label [for]=\"id\" class=\"label rb-select-label\">\r\n    {{!isLabelTemplate()?label:''}}\r\n    <ng-container *ngIf=\"isLabelTemplate()\">\r\n      <ng-container *ngTemplateOutlet=\"label\"></ng-container>\r\n    </ng-container>\r\n  </label>\r\n  <span class=\"select-icon rb-ic rb-ic-down\"></span>\r\n  <span class=\"input-background\"></span>\r\n</div>\r\n<rb-form-errors [messages]=\"messages\"></rb-form-errors>\r\n\r\n\r\n<ng-template #dropdownContent>\r\n  <ng-container *ngIf=\"selectAllLabel\">\r\n    <rb-form-multi-checkbox [numStates]=\"numStates\"\r\n                            class=\"list-item-input\"\r\n                            [ngModel]=\"allStates\"\r\n                            (ngModelChange)=\"allStatesChange($event)\">\r\n      {{selectAllLabel}}\r\n    </rb-form-multi-checkbox>\r\n    <hr class=\"no-margin\">\r\n  </ng-container>\r\n\r\n  <div class=\"dropdown-limited\">\r\n    <ng-container *ngFor=\"let item of _items; trackBy: getItemTrackId\">\r\n      <rb-form-multi-checkbox [numStates]=\"numStates\"\r\n                              class=\"list-item-input\"\r\n                              [ngModel]=\"item.state\"\r\n                              (ngModelChange)=\"updateStateOfItem(item, $event)\">\r\n        <ng-container *ngIf=\"option\">\r\n          <ng-container *ngTemplateOutlet=\"option.templateRef; context: {$implicit: item.item}\"></ng-container>\r\n        </ng-container>\r\n        <ng-container *ngIf=\"!option\">\r\n          {{item.item | json}}\r\n        </ng-container>\r\n      </rb-form-multi-checkbox>\r\n    </ng-container>\r\n  </div>\r\n\r\n</ng-template>\r\n",
            providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(function () { return FormMultiSelectComponent_1; }), multi: true }]
        }),
        tslib_1.__metadata("design:paramtypes", [Renderer2, ElementRef])
    ], FormMultiSelectComponent);
    return FormMultiSelectComponent;
}());
export { FormMultiSelectComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1tdWx0aS1zZWxlY3QuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGluc3QtaW90L2Jvc2NoLWFuZ3VsYXItdWktY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImF0b21zL2Zvcm0tZmllbGRzL2Zvcm0tbXVsdGktc2VsZWN0L2Zvcm0tbXVsdGktc2VsZWN0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osZUFBZSxFQUNmLFNBQVMsRUFDVCxVQUFVLEVBQ1YsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBRUwsU0FBUyxFQUNULFNBQVMsRUFDVCxXQUFXLEVBQ1osTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdEYsT0FBTyxFQUF3QixpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFNOUM7SUFFRSxvQ0FBbUIsV0FBNkI7UUFBN0IsZ0JBQVcsR0FBWCxXQUFXLENBQWtCO0lBQ2hELENBQUM7SUFIVSwwQkFBMEI7UUFIdEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDJCQUEyQjtTQUN0QyxDQUFDO2lEQUdnQyxXQUFXO09BRmhDLDBCQUEwQixDQUt0QztJQUFELGlDQUFDO0NBQUEsQUFMRCxJQUtDO1NBTFksMEJBQTBCO0FBVXZDO0lBRUUsbUNBQW1CLFdBQTZCO1FBQTdCLGdCQUFXLEdBQVgsV0FBVyxDQUFrQjtJQUNoRCxDQUFDO0lBSFUseUJBQXlCO1FBSHJDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSwwQkFBMEI7U0FDckMsQ0FBQztpREFHZ0MsV0FBVztPQUZoQyx5QkFBeUIsQ0FLckM7SUFBRCxnQ0FBQztDQUFBLEFBTEQsSUFLQztTQUxZLHlCQUF5QjtBQXVCdEM7Ozs7O0dBS0c7QUFNSDtJQTJE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TnBDO0lBQUQsK0JBQUM7Q0FBQSxBQWxORCxJQWtOQztTQWxOWSx3QkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbXBvbmVudCxcclxuICBDb250ZW50Q2hpbGQsXHJcbiAgQ29udGVudENoaWxkcmVuLFxyXG4gIERpcmVjdGl2ZSxcclxuICBFbGVtZW50UmVmLFxyXG4gIGZvcndhcmRSZWYsXHJcbiAgSG9zdExpc3RlbmVyLFxyXG4gIElucHV0LFxyXG4gIE9uSW5pdCxcclxuICBRdWVyeUxpc3QsXHJcbiAgUmVuZGVyZXIyLFxyXG4gIFRlbXBsYXRlUmVmXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZvcm1WYWxpZGF0aW9uTWVzc2FnZURpcmVjdGl2ZSB9IGZyb20gJy4uL2Zvcm0tdmFsaWRhdGlvbi1tZXNzYWdlLmRpcmVjdGl2ZSc7XHJcbmltcG9ydCB7IENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgZW1wdHlGdW5jdGlvbiB9IGZyb20gJy4uL2Zvcm1zLXV0aWwnO1xyXG5pbXBvcnQgeyBUYWJQYW5lbFRpdGxlRGlyZWN0aXZlIH0gZnJvbSAnLi4vLi4vLi4vbW9sZWN1bGVzL3RhYi1wYW5lbC90YWItcGFuZWwtdGl0bGUuZGlyZWN0aXZlJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW3JiRm9ybU11bHRpU2VsZWN0T3B0aW9uXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIE11bHRpU2VsZWN0T3B0aW9uRGlyZWN0aXZlIHtcclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+KSB7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbcmJGb3JtTXVsdGlTZWxlY3RUaXRsZV0nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBNdWx0aVNlbGVjdFRpdGxlRGlyZWN0aXZlIHtcclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+KSB7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJdGVtV2l0aFN0YXRlIHtcclxuICBpdGVtOiBhbnk7XHJcbiAgc3RhdGU6IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTdGF0ZVZhbHVlcyB7XHJcbiAgW2tleTogc3RyaW5nXTogYW55O1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFRpdGxlQ29udGV4dCB7XHJcbiAgJGltcGxpY2l0OiBJdGVtV2l0aFN0YXRlW107XHJcbiAgY291bnQ6IG51bWJlcjtcclxuICBmaXJzdEl0ZW06IEl0ZW1XaXRoU3RhdGU7XHJcbiAgc3RhdGVzOiBhbnk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBVc2UgdGhpcyBjb21wb25lbnQgdG8gaGF2ZSBtdWx0aXBsZSBzZWxlY3Rpb25zLlxyXG4gKiBUaGUgdmFsdWUgaXMgYSBtYXAgb2YgaWQgLT4gc3RhdGUuXHJcbiAqIFRoZSBpdGVtcyBhcmUgYW4gYXJyYXkgb2Ygb2JqZWN0cy5cclxuICogVG8gaWRlbnRpZnkgdGhlIGlkIG9mIGFuIG9iamVjdCBmcm9tIHRoZSBpdGVtcyBhcnJheSwgcHJvdmlkZSB0aGUgaWRGaWVsZC5cclxuICovXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncmItZm9ybS1tdWx0aS1zZWxlY3QnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9mb3JtLW11bHRpLXNlbGVjdC5jb21wb25lbnQuaHRtbCcsXHJcbiAgcHJvdmlkZXJzOiBbe3Byb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLCB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBGb3JtTXVsdGlTZWxlY3RDb21wb25lbnQpLCBtdWx0aTogdHJ1ZX1dXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGb3JtTXVsdGlTZWxlY3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIENvbnRyb2xWYWx1ZUFjY2Vzc29yIHtcclxuXHJcbiAgQElucHV0KCkgbmFtZTogc3RyaW5nO1xyXG4gIEBJbnB1dCgpIGxhYmVsOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+ID0gbnVsbDtcclxuICBpZCA9ICdtdWx0aVNlbGVjdC4nICsgTWF0aC5yYW5kb20oKTtcclxuICBkaXNhYmxlZDogYm9vbGVhbjtcclxuICBASW5wdXQoKSBzZWxlY3RBbGxMYWJlbCA9ICdTZWxlY3QgYWxsJztcclxuXHJcbiAgQENvbnRlbnRDaGlsZHJlbihGb3JtVmFsaWRhdGlvbk1lc3NhZ2VEaXJlY3RpdmUpIG1lc3NhZ2VzOiBRdWVyeUxpc3Q8Rm9ybVZhbGlkYXRpb25NZXNzYWdlRGlyZWN0aXZlPjtcclxuXHJcbiAgX2l0ZW1zOiBJdGVtV2l0aFN0YXRlW107XHJcblxyXG4gIHByaXZhdGUgaXNNb3VzZU92ZXIgPSBmYWxzZTtcclxuXHJcbiAgLyoqXHJcbiAgICogUHJvcGVydHkgbmFtZSBvZiB0aGUgcHJvcGVydHkgdGhhdCBjb250YWlucyB0aGUgdW5pcXVlIHZhbHVlIG9mIGFuIGl0ZW1cclxuICAgKiBPdGhlcndpc2UgdGhlIEpTT04gcmVwIGlzIHVzZWQgYXMgdmFsdWVcclxuICAgKi9cclxuICBASW5wdXQoKSBpZEZpZWxkOiBzdHJpbmcgPSBudWxsO1xyXG5cclxuICAvKipcclxuICAgKiBXaGF0IHN0YXRlcyBzaG91bGQgYmUgb2ZmZXJlZCBwZXIgaXRlbVxyXG4gICAqIGNoZWNrOiBqdXN0IGNoZWNrZWQodHJ1ZSkgYW5kIHVuY2hlY2tlZChmYWxzZSlcclxuICAgKiBvcHRDaGVjazogdW5jaGVja2VkKG51bGwpLCBpbmNsdWRlKHRydWUpLCBleGNsdWRlKGZhbHNlKVxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHN0YXRlc01vZGU6ICdjaGVjaycgfCAnb3B0Q2hlY2snID0gJ2NoZWNrJztcclxuXHJcbiAgbnVtU3RhdGVzID0gMjtcclxuXHJcbiAgcHJpdmF0ZSBfc3RhdGVzID0ge1xyXG4gICAgJ2NoZWNrJzogW2ZhbHNlLCB0cnVlXSxcclxuICAgICdvcHRDaGVjayc6IFtudWxsLCBmYWxzZSwgdHJ1ZV1cclxuICB9O1xyXG5cclxuICBASW5wdXQoKSBtYXhJdGVtc1ByZXZpZXcgPSAzO1xyXG5cclxuICBAQ29udGVudENoaWxkKE11bHRpU2VsZWN0T3B0aW9uRGlyZWN0aXZlLCB7c3RhdGljOiBmYWxzZX0pIG9wdGlvbjogTXVsdGlTZWxlY3RPcHRpb25EaXJlY3RpdmU7XHJcbiAgQENvbnRlbnRDaGlsZChNdWx0aVNlbGVjdFRpdGxlRGlyZWN0aXZlLCB7c3RhdGljOiBmYWxzZX0pIHRpdGxlOiBNdWx0aVNlbGVjdFRpdGxlRGlyZWN0aXZlO1xyXG5cclxuICBhbGxTdGF0ZXMgPSBudWxsO1xyXG5cclxuICBwcml2YXRlIGNvdW50Tm90RGVmU3RhdGUgPSAwO1xyXG5cclxuICBwcml2YXRlIGZpcnN0Tm90RGVmU3RhdGVJdGVtOiBJdGVtV2l0aFN0YXRlID0gbnVsbDtcclxuXHJcbiAgcHJpdmF0ZSBfdmFsdWU6IFN0YXRlVmFsdWVzID0ge307XHJcblxyXG4gIHRpdGxlQ29udGV4dDogVGl0bGVDb250ZXh0ID0ge1xyXG4gICAgJGltcGxpY2l0OiBudWxsLFxyXG4gICAgY291bnQ6IDAsXHJcbiAgICBmaXJzdEl0ZW06IG51bGwsXHJcbiAgICBzdGF0ZXM6IG51bGxcclxuICB9O1xyXG5cclxuICBnZXRJdGVtVHJhY2tJZDtcclxuXHJcbiAgb25DaGFuZ2UgPSBlbXB0eUZ1bmN0aW9uO1xyXG4gIG9uVG91Y2hlZCA9IGVtcHR5RnVuY3Rpb247XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7XHJcblxyXG4gICAgdGhpcy5nZXRJdGVtVHJhY2tJZCA9IChpLCBpdGVtKSA9PiB7XHJcbiAgICAgIHJldHVybiB0aGlzLmdldEl0ZW1JZChpdGVtLml0ZW0pO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgY29uc3Qgc3RhdGVzID0gdGhpcy5nZXRTdGF0ZXMoKTtcclxuICAgIHRoaXMubnVtU3RhdGVzID0gc3RhdGVzLmxlbmd0aDtcclxuICAgIHRoaXMuYWxsU3RhdGVzID0gc3RhdGVzWzBdO1xyXG4gIH1cclxuXHJcbiAgaXNMYWJlbFRlbXBsYXRlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubGFiZWwgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZjtcclxuICB9XHJcblxyXG5cclxuICBASW5wdXQoKVxyXG4gIHNldCBpdGVtcyhpdGVtczogb2JqZWN0W10pIHtcclxuICAgIGNvbnN0IHN0YXRlcyA9IHRoaXMuZ2V0U3RhdGVzKCk7XHJcbiAgICB0aGlzLl9pdGVtcyA9IGl0ZW1zLm1hcChpdGVtID0+IHtcclxuICAgICAgY29uc3QgaWQgPSB0aGlzLmdldEl0ZW1JZChpdGVtKTtcclxuICAgICAgbGV0IHN0YXRlID0gc3RhdGVzWzBdO1xyXG4gICAgICBpZiAodGhpcy5fdmFsdWUgJiYgdGhpcy5fdmFsdWVbaWRdICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBzdGF0ZSA9IHRoaXMuX3ZhbHVlW2lkXTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGl0ZW06IGl0ZW0sXHJcbiAgICAgICAgc3RhdGU6IHN0YXRlXHJcbiAgICAgIH07XHJcbiAgICB9KTtcclxuICAgIHRoaXMuZG9PbkNoYW5nZXMoKTtcclxuICB9XHJcblxyXG4gIGdldEl0ZW1JZChpdGVtOiBhbnkpIHtcclxuICAgIGlmICh0aGlzLmlkRmllbGQgJiYgaXRlbSkge1xyXG4gICAgICByZXR1cm4gaXRlbVt0aGlzLmlkRmllbGRdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGl0ZW0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0U3RhdGVzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX3N0YXRlc1t0aGlzLnN0YXRlc01vZGVdO1xyXG4gIH1cclxuXHJcblxyXG4gIGFsbFN0YXRlc0NoYW5nZShzdGF0ZSkge1xyXG4gICAgdGhpcy5hbGxTdGF0ZXMgPSBzdGF0ZTtcclxuICAgIGlmICghdGhpcy5faXRlbXMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5faXRlbXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgaXRlbS5zdGF0ZSA9IHN0YXRlO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLm5vdGlmeUNoYW5nZXMoKTtcclxuICB9XHJcblxyXG4gIHVwZGF0ZVN0YXRlT2ZJdGVtKGl0ZW06IEl0ZW1XaXRoU3RhdGUsIHN0YXRlKSB7XHJcbiAgICBpdGVtLnN0YXRlID0gc3RhdGU7XHJcbiAgICBpZiAodGhpcy5faXRlbXMuc29tZShkID0+IGQuc3RhdGUgIT09IHN0YXRlKSkge1xyXG4gICAgICBjb25zdCBzdGF0ZXMgPSB0aGlzLmdldFN0YXRlcygpO1xyXG4gICAgICB0aGlzLmFsbFN0YXRlcyA9IHN0YXRlc1swXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuYWxsU3RhdGVzID0gc3RhdGU7XHJcbiAgICB9XHJcbiAgICB0aGlzLm5vdGlmeUNoYW5nZXMoKTtcclxuICB9XHJcblxyXG4gIGdldEN1cnJlbnRTdGF0ZXNPYmplY3QoKSB7XHJcbiAgICBjb25zdCBzdGF0ZXMgPSB7fTtcclxuICAgIHRoaXMuX2l0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRJdGVtSWQoaXRlbS5pdGVtKTtcclxuICAgICAgc3RhdGVzW2lkXSA9IGl0ZW0uc3RhdGU7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBzdGF0ZXM7XHJcbiAgfVxyXG5cclxuICBkb09uQ2hhbmdlcygpIHtcclxuICAgIHRoaXMuZmlyc3ROb3REZWZTdGF0ZUl0ZW0gPSBudWxsO1xyXG4gICAgdGhpcy5jb3VudE5vdERlZlN0YXRlID0gMDtcclxuICAgIGNvbnN0IHN0YXRlcyA9IHRoaXMuZ2V0U3RhdGVzKCk7XHJcbiAgICBpZiAoIXRoaXMuX2l0ZW1zKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuX2l0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgIGlmIChpdGVtLnN0YXRlICE9PSBzdGF0ZXNbMF0pIHtcclxuICAgICAgICB0aGlzLmNvdW50Tm90RGVmU3RhdGUrKztcclxuICAgICAgICBpZiAodGhpcy5maXJzdE5vdERlZlN0YXRlSXRlbSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgdGhpcy5maXJzdE5vdERlZlN0YXRlSXRlbSA9IGl0ZW07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLnRpdGxlQ29udGV4dCA9IHtcclxuICAgICAgJGltcGxpY2l0OiB0aGlzLl9pdGVtcyxcclxuICAgICAgY291bnQ6IHRoaXMuY291bnROb3REZWZTdGF0ZSxcclxuICAgICAgZmlyc3RJdGVtOiB0aGlzLmZpcnN0Tm90RGVmU3RhdGVJdGVtLFxyXG4gICAgICBzdGF0ZXM6IHRoaXMuX3ZhbHVlXHJcbiAgICB9O1xyXG5cclxuICAgIGlmICh0aGlzLmNvdW50Tm90RGVmU3RhdGUgPT09IDAgJiYgdGhpcy5zZWxlY3RBbGxMYWJlbCA9PT0gJycpIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ25vdC1lbXB0eScpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ25vdC1lbXB0eScpO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIG5vdGlmeUNoYW5nZXMoKSB7XHJcbiAgICB0aGlzLmRvT25DaGFuZ2VzKCk7XHJcbiAgICB0aGlzLm9uQ2hhbmdlKHRoaXMuZ2V0Q3VycmVudFN0YXRlc09iamVjdCgpKTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ21vdXNlZW50ZXInKSBtb3VzZW92ZXIoKSB7XHJcbiAgICB0aGlzLmlzTW91c2VPdmVyID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ21vdXNlbGVhdmUnKSBtb3VzZWxlYXZlKCkge1xyXG4gICAgdGhpcy5pc01vdXNlT3ZlciA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgd3JpdGVWYWx1ZShpdGVtczogYW55KTogdm9pZCB7XHJcbiAgICB0aGlzLl92YWx1ZSA9IGl0ZW1zO1xyXG4gICAgaWYgKGl0ZW1zKSB7XHJcbiAgICAgIGNvbnN0IHN0YXRlcyA9IHRoaXMuZ2V0U3RhdGVzKCk7XHJcbiAgICAgIHRoaXMuX2l0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgY29uc3QgaWQgPSB0aGlzLmdldEl0ZW1JZChpdGVtLml0ZW0pO1xyXG4gICAgICAgIGlmIChpdGVtc1tpZF0gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgaXRlbS5zdGF0ZSA9IGl0ZW1zW2lkXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaXRlbS5zdGF0ZSA9IHN0YXRlc1swXTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgdGhpcy5kb09uQ2hhbmdlcygpO1xyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJPbkNoYW5nZShmbjogKF86IGFueSkgPT4ge30pOiB2b2lkIHtcclxuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiB7fSk6IHZvaWQge1xyXG4gICAgdGhpcy5vblRvdWNoZWQgPSBmbjtcclxuICB9XHJcblxyXG4gIHNldERpc2FibGVkU3RhdGUoaXNEaXNhYmxlZDogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNhYmxlZCA9IGlzRGlzYWJsZWQ7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=