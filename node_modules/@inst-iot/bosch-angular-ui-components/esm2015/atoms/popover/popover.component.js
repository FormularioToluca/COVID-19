import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, HostListener, Input, Output, TemplateRef, ViewChild } from '@angular/core';
import { getAbsolutePosition } from '../../utils/positionUtils';
let PopoverComponent = class PopoverComponent {
    constructor() {
        this.primaryPos = 'bottom';
        this.close = new EventEmitter();
        this.mouseIn = false;
        this.initialized = false;
        this.context = {
            close: this.doClose.bind(this)
        };
    }
    onMouseEnter() {
        this.mouseIn = true;
    }
    onMouseLeave() {
        this.mouseIn = false;
    }
    onAnyClick() {
        if (!this.mouseIn && this.initialized) {
            this.close.next('click');
        }
    }
    onResize() {
        this.positionToAnchor();
    }
    ngOnInit() {
        setTimeout(() => {
            this.initialized = true;
            this.positionToAnchor();
        });
        this.positionToAnchor();
    }
    ngAfterViewInit() {
        this.positionToAnchor();
    }
    doClose() {
        this.close.next();
    }
    positionToAnchor() {
        if (!this.anchor || !this.popoverElementRef) {
            return;
        }
        const a = this.anchor instanceof HTMLElement ? this.anchor : this.anchor.nativeElement;
        const pop = this.popoverElementRef.nativeElement;
        const arrow = this.arrowElementRef.nativeElement;
        const anchorPos = getAbsolutePosition(a);
        if (this.primaryPos === 'top' || this.primaryPos === 'bottom') {
            anchorPos.x += a.offsetWidth / 2;
            let isBottom = this.primaryPos === 'bottom';
            const pos = {
                x: anchorPos.x - pop.offsetWidth / 2,
                y: 0
            };
            if (!isBottom) {
                pos.y = anchorPos.y - pop.offsetHeight - arrow.offsetHeight / 2;
                if (pos.y < 0) {
                    isBottom = true;
                }
            }
            if (isBottom) {
                pos.y = anchorPos.y + a.offsetHeight + arrow.offsetHeight / 2;
                arrow.classList.remove('bottom');
            }
            else {
                arrow.classList.add('bottom');
            }
            if (pos.x + pop.offsetWidth > window.innerWidth) {
                pos.x = window.innerWidth - pop.offsetWidth;
            }
            if (pos.x < 0) {
                pos.x = 0;
            }
            const popParentPos = getAbsolutePosition(pop.offsetParent);
            pos.y -= popParentPos.y;
            pos.x -= popParentPos.x;
            pop.style.top = pos.y + 'px';
            pop.style.left = pos.x + 'px';
            const arrowX = anchorPos.x - (pos.x + popParentPos.x) - arrow.offsetWidth / 2;
            arrow.style.left = arrowX + 'px';
        }
        if (this.primaryPos === 'left' || this.primaryPos === 'right') {
            anchorPos.y += a.offsetHeight / 2;
            let isRight = this.primaryPos === 'right';
            const pos = {
                x: 0,
                y: anchorPos.y - pop.offsetHeight / 2,
            };
            if (!isRight) {
                pos.x = anchorPos.x - pop.offsetWidth - arrow.offsetWidth / 2;
                if (pos.x < 0) {
                    isRight = true;
                }
            }
            if (isRight) {
                pos.x = anchorPos.x + a.offsetWidth + arrow.offsetWidth / 2;
                arrow.classList.remove('right');
                arrow.classList.add('left');
            }
            else {
                arrow.classList.add('right');
                arrow.classList.remove('left');
            }
            if (pos.y < 0) {
                pos.y = 0;
            }
            const popParentPos = getAbsolutePosition(pop.offsetParent);
            pos.y -= popParentPos.y;
            pos.x -= popParentPos.x;
            pop.style.top = pos.y + 'px';
            pop.style.left = pos.x + 'px';
            const arrowY = anchorPos.y - (pos.y + popParentPos.y) - arrow.offsetHeight / 2;
            arrow.style.top = arrowY + 'px';
        }
    }
    isTemplate() {
        return this.content instanceof TemplateRef;
    }
};
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], PopoverComponent.prototype, "anchor", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], PopoverComponent.prototype, "content", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], PopoverComponent.prototype, "primaryPos", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PopoverComponent.prototype, "close", void 0);
tslib_1.__decorate([
    ViewChild('popover', { static: true }),
    tslib_1.__metadata("design:type", ElementRef)
], PopoverComponent.prototype, "popoverElementRef", void 0);
tslib_1.__decorate([
    ViewChild('arrow', { static: true }),
    tslib_1.__metadata("design:type", ElementRef)
], PopoverComponent.prototype, "arrowElementRef", void 0);
tslib_1.__decorate([
    HostListener('mouseenter'),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", []),
    tslib_1.__metadata("design:returntype", void 0)
], PopoverComponent.prototype, "onMouseEnter", null);
tslib_1.__decorate([
    HostListener('mouseleave'),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", []),
    tslib_1.__metadata("design:returntype", void 0)
], PopoverComponent.prototype, "onMouseLeave", null);
tslib_1.__decorate([
    HostListener('window:click'),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", []),
    tslib_1.__metadata("design:returntype", void 0)
], PopoverComponent.prototype, "onAnyClick", null);
tslib_1.__decorate([
    HostListener('window:resize'),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", []),
    tslib_1.__metadata("design:returntype", void 0)
], PopoverComponent.prototype, "onResize", null);
PopoverComponent = tslib_1.__decorate([
    Component({
        selector: 'rb-popover',
        template: "<div class=\"rb-popover\" #popover>\r\n  <div class=\"rb-popover-arrow\" #arrow></div>\r\n  <div class=\"rb-popover-content\" *ngIf=\"isTemplate()\">\r\n    <ng-container *ngTemplateOutlet=\"content; context: context\"></ng-container>\r\n  </div>\r\n  <div class=\"rb-popover-content-text\" *ngIf=\"!isTemplate()\">\r\n    {{content}}\r\n  </div>\r\n</div>\r\n"
    }),
    tslib_1.__metadata("design:paramtypes", [])
], PopoverComponent);
export { PopoverComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wb3Zlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaW5zdC1pb3QvYm9zY2gtYW5ndWxhci11aS1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiYXRvbXMvcG9wb3Zlci9wb3BvdmVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNVLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLFdBQVcsRUFDcEcsU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBTWhFLElBQWEsZ0JBQWdCLEdBQTdCLE1BQWEsZ0JBQWdCO0lBbUMzQjtRQS9CUyxlQUFVLEdBQXdDLFFBQVEsQ0FBQztRQUUxRCxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUVyQyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ2hCLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBMkIxQixJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ2IsS0FBSyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztTQUMvQixDQUFDO0lBQ0osQ0FBQztJQXZCMkIsWUFBWTtRQUN0QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztJQUN0QixDQUFDO0lBRTJCLFlBQVk7UUFDdEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFDdkIsQ0FBQztJQUU2QixVQUFVO1FBQ3RDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDckMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDMUI7SUFDSCxDQUFDO0lBRThCLFFBQVE7UUFDckMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJ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REFBNEQ7QUFFMUQ7SUFBVCxNQUFNLEVBQUU7OytDQUFvQztBQU9QO0lBQXJDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFDLENBQUM7c0NBQW9CLFVBQVU7MkRBQUM7QUFDaEM7SUFBbkMsU0FBUyxDQUFDLE9BQU8sRUFBRSxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUMsQ0FBQztzQ0FBa0IsVUFBVTt5REFBQztBQUVwQztJQUEzQixZQUFZLENBQUMsWUFBWSxDQUFDOzs7O29EQUUxQjtBQUUyQjtJQUEzQixZQUFZLENBQUMsWUFBWSxDQUFDOzs7O29EQUUxQjtBQUU2QjtJQUE3QixZQUFZLENBQUMsY0FBYyxDQUFDOzs7O2tEQUk1QjtBQUU4QjtJQUE5QixZQUFZLENBQUMsZUFBZSxDQUFDOzs7O2dEQUU3QjtBQWhDVSxnQkFBZ0I7SUFKNUIsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLFlBQVk7UUFDdEIsb1hBQXVDO0tBQ3hDLENBQUM7O0dBQ1csZ0JBQWdCLENBNEo1QjtTQTVKWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIEFmdGVyVmlld0luaXQsIENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBIb3N0TGlzdGVuZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgVGVtcGxhdGVSZWYsXHJcbiAgVmlld0NoaWxkXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGdldEFic29sdXRlUG9zaXRpb24gfSBmcm9tICcuLi8uLi91dGlscy9wb3NpdGlvblV0aWxzJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncmItcG9wb3ZlcicsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3BvcG92ZXIuY29tcG9uZW50Lmh0bWwnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb3BvdmVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgQElucHV0KCkgYW5jaG9yOiBFbGVtZW50UmVmIHwgSFRNTEVsZW1lbnQ7XHJcbiAgQElucHV0KCkgY29udGVudDogVGVtcGxhdGVSZWY8YW55PiB8IHN0cmluZztcclxuICBASW5wdXQoKSBwcmltYXJ5UG9zOiAndG9wJyB8ICdib3R0b20nIHwgJ2xlZnQnIHwgJ3JpZ2h0JyA9ICdib3R0b20nO1xyXG5cclxuICBAT3V0cHV0KCkgY2xvc2UgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuXHJcbiAgcHJpdmF0ZSBtb3VzZUluID0gZmFsc2U7XHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICBjb250ZXh0OiBhbnk7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ3BvcG92ZXInLCB7c3RhdGljOiB0cnVlfSkgcG9wb3ZlckVsZW1lbnRSZWY6IEVsZW1lbnRSZWY7XHJcbiAgQFZpZXdDaGlsZCgnYXJyb3cnLCB7c3RhdGljOiB0cnVlfSkgYXJyb3dFbGVtZW50UmVmOiBFbGVtZW50UmVmO1xyXG5cclxuICBASG9zdExpc3RlbmVyKCdtb3VzZWVudGVyJykgb25Nb3VzZUVudGVyKCkge1xyXG4gICAgdGhpcy5tb3VzZUluID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ21vdXNlbGVhdmUnKSBvbk1vdXNlTGVhdmUoKSB7XHJcbiAgICB0aGlzLm1vdXNlSW4gPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpjbGljaycpIG9uQW55Q2xpY2soKSB7XHJcbiAgICBpZiAoIXRoaXMubW91c2VJbiAmJiB0aGlzLmluaXRpYWxpemVkKSB7XHJcbiAgICAgIHRoaXMuY2xvc2UubmV4dCgnY2xpY2snKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpyZXNpemUnKSBvblJlc2l6ZSgpIHtcclxuICAgIHRoaXMucG9zaXRpb25Ub0FuY2hvcigpO1xyXG4gIH1cclxuXHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5jb250ZXh0ID0ge1xyXG4gICAgICBjbG9zZTogdGhpcy5kb0Nsb3NlLmJpbmQodGhpcylcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgdGhpcy5wb3NpdGlvblRvQW5jaG9yKCk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMucG9zaXRpb25Ub0FuY2hvcigpO1xyXG4gIH1cclxuXHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgIHRoaXMucG9zaXRpb25Ub0FuY2hvcigpO1xyXG4gIH1cclxuXHJcbiAgZG9DbG9zZSgpIHtcclxuICAgIHRoaXMuY2xvc2UubmV4dCgpO1xyXG4gIH1cclxuXHJcbiAgcG9zaXRpb25Ub0FuY2hvcigpIHtcclxuICAgIGlmICghdGhpcy5hbmNob3IgfHwgIXRoaXMucG9wb3ZlckVsZW1lbnRSZWYpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGEgPSB0aGlzLmFuY2hvciBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gdGhpcy5hbmNob3IgOiB0aGlzLmFuY2hvci5uYXRpdmVFbGVtZW50O1xyXG4gICAgY29uc3QgcG9wID0gdGhpcy5wb3BvdmVyRWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xyXG4gICAgY29uc3QgYXJyb3cgPSB0aGlzLmFycm93RWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xyXG5cclxuICAgIGNvbnN0IGFuY2hvclBvcyA9IGdldEFic29sdXRlUG9zaXRpb24oYSk7XHJcblxyXG4gICAgaWYgKHRoaXMucHJpbWFyeVBvcyA9PT0gJ3RvcCcgfHwgdGhpcy5wcmltYXJ5UG9zID09PSAnYm90dG9tJykge1xyXG4gICAgICBhbmNob3JQb3MueCArPSBhLm9mZnNldFdpZHRoIC8gMjtcclxuICAgICAgbGV0IGlzQm90dG9tID0gdGhpcy5wcmltYXJ5UG9zID09PSAnYm90dG9tJztcclxuXHJcblxyXG4gICAgICBjb25zdCBwb3MgPSB7XHJcbiAgICAgICAgeDogYW5jaG9yUG9zLnggLSBwb3Aub2Zmc2V0V2lkdGggLyAyLFxyXG4gICAgICAgIHk6IDBcclxuICAgICAgfTtcclxuICAgICAgaWYgKCFpc0JvdHRvbSkge1xyXG4gICAgICAgIHBvcy55ID0gYW5jaG9yUG9zLnkgLSBwb3Aub2Zmc2V0SGVpZ2h0IC0gYXJyb3cub2Zmc2V0SGVpZ2h0IC8gMjtcclxuICAgICAgICBpZiAocG9zLnkgPCAwKSB7XHJcbiAgICAgICAgICBpc0JvdHRvbSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChpc0JvdHRvbSkge1xyXG4gICAgICAgIHBvcy55ID0gYW5jaG9yUG9zLnkgKyBhLm9mZnNldEhlaWdodCArIGFycm93Lm9mZnNldEhlaWdodCAvIDI7XHJcbiAgICAgICAgYXJyb3cuY2xhc3NMaXN0LnJlbW92ZSgnYm90dG9tJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXJyb3cuY2xhc3NMaXN0LmFkZCgnYm90dG9tJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChwb3MueCArIHBvcC5vZmZzZXRXaWR0aCA+IHdpbmRvdy5pbm5lcldpZHRoKSB7XHJcbiAgICAgICAgcG9zLnggPSB3aW5kb3cuaW5uZXJXaWR0aCAtIHBvcC5vZmZzZXRXaWR0aDtcclxuICAgICAgfVxyXG4gICAgICBpZiAocG9zLnggPCAwKSB7XHJcbiAgICAgICAgcG9zLnggPSAwO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBwb3BQYXJlbnRQb3MgPSBnZXRBYnNvbHV0ZVBvc2l0aW9uKHBvcC5vZmZzZXRQYXJlbnQpO1xyXG4gICAgICBwb3MueSAtPSBwb3BQYXJlbnRQb3MueTtcclxuICAgICAgcG9zLnggLT0gcG9wUGFyZW50UG9zLng7XHJcblxyXG4gICAgICBwb3Auc3R5bGUudG9wID0gcG9zLnkgKyAncHgnO1xyXG4gICAgICBwb3Auc3R5bGUubGVmdCA9IHBvcy54ICsgJ3B4JztcclxuXHJcbiAgICAgIGNvbnN0IGFycm93WCA9IGFuY2hvclBvcy54IC0gKHBvcy54ICsgcG9wUGFyZW50UG9zLngpIC0gYXJyb3cub2Zmc2V0V2lkdGggLyAyO1xyXG5cclxuICAgICAgYXJyb3cuc3R5bGUubGVmdCA9IGFycm93WCArICdweCc7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMucHJpbWFyeVBvcyA9PT0gJ2xlZnQnIHx8IHRoaXMucHJpbWFyeVBvcyA9PT0gJ3JpZ2h0Jykge1xyXG4gICAgICBhbmNob3JQb3MueSArPSBhLm9mZnNldEhlaWdodCAvIDI7XHJcbiAgICAgIGxldCBpc1JpZ2h0ID0gdGhpcy5wcmltYXJ5UG9zID09PSAncmlnaHQnO1xyXG5cclxuICAgICAgY29uc3QgcG9zID0ge1xyXG4gICAgICAgIHg6IDAsXHJcbiAgICAgICAgeTogYW5jaG9yUG9zLnkgLSBwb3Aub2Zmc2V0SGVpZ2h0IC8gMixcclxuICAgICAgfTtcclxuICAgICAgaWYgKCFpc1JpZ2h0KSB7XHJcbiAgICAgICAgcG9zLnggPSBhbmNob3JQb3MueCAtIHBvcC5vZmZzZXRXaWR0aCAtIGFycm93Lm9mZnNldFdpZHRoIC8gMjtcclxuICAgICAgICBpZiAocG9zLnggPCAwKSB7XHJcbiAgICAgICAgICBpc1JpZ2h0ID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGlzUmlnaHQpIHtcclxuICAgICAgICBwb3MueCA9IGFuY2hvclBvcy54ICsgYS5vZmZzZXRXaWR0aCArIGFycm93Lm9mZnNldFdpZHRoIC8gMjtcclxuICAgICAgICBhcnJvdy5jbGFzc0xpc3QucmVtb3ZlKCdyaWdodCcpO1xyXG4gICAgICAgIGFycm93LmNsYXNzTGlzdC5hZGQoJ2xlZnQnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBhcnJvdy5jbGFzc0xpc3QuYWRkKCdyaWdodCcpO1xyXG4gICAgICAgIGFycm93LmNsYXNzTGlzdC5yZW1vdmUoJ2xlZnQnKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHBvcy55IDwgMCkge1xyXG4gICAgICAgIHBvcy55ID0gMDtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgcG9wUGFyZW50UG9zID0gZ2V0QWJzb2x1dGVQb3NpdGlvbihwb3Aub2Zmc2V0UGFyZW50KTtcclxuICAgICAgcG9zLnkgLT0gcG9wUGFyZW50UG9zLnk7XHJcbiAgICAgIHBvcy54IC09IHBvcFBhcmVudFBvcy54O1xyXG5cclxuICAgICAgcG9wLnN0eWxlLnRvcCA9IHBvcy55ICsgJ3B4JztcclxuICAgICAgcG9wLnN0eWxlLmxlZnQgPSBwb3MueCArICdweCc7XHJcblxyXG4gICAgICBjb25zdCBhcnJvd1kgPSBhbmNob3JQb3MueSAtIChwb3MueSArIHBvcFBhcmVudFBvcy55KSAtIGFycm93Lm9mZnNldEhlaWdodCAvIDI7XHJcblxyXG4gICAgICBhcnJvdy5zdHlsZS50b3AgPSBhcnJvd1kgKyAncHgnO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgfVxyXG5cclxuICBpc1RlbXBsYXRlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuY29udGVudCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmO1xyXG4gIH1cclxuXHJcbn1cclxuIl19