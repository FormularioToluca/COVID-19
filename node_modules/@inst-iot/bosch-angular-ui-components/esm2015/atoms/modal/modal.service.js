import * as tslib_1 from "tslib";
import { ApplicationRef, ComponentFactoryResolver, ComponentRef, Injectable, Injector, TemplateRef } from '@angular/core';
import { ModalComponent } from './modal.component';
let ModalService = class ModalService {
    constructor(factoryResolver, injector, appRef) {
        this.factoryResolver = factoryResolver;
        this.injector = injector;
        this.appRef = appRef;
        this.openComponents = [];
        const el = document.querySelector('.rb-modal-backdrop');
        if (el) {
            this.backdrop = el;
        }
        else {
            this.backdrop = document.body.appendChild(document.createElement('div'));
            this.backdrop.className = 'rb-modal-backdrop';
            let isDown = false;
            this.backdrop.addEventListener('mousedown', e => {
                if (e.target === this.backdrop) {
                    isDown = true;
                }
            });
            this.backdrop.addEventListener('mouseup', e => {
                if (isDown && e.target === this.backdrop) {
                    this.nonButtonClose();
                }
                isDown = false;
            });
        }
        this.componentFactory = this.factoryResolver.resolveComponentFactory(ModalComponent);
    }
    get appRoot() {
        return this.appRef.components[0].location.nativeElement;
    }
    /**
     * Opens a component in a modal. Creates the component instance.
     * Provide an injector in case the ModalService is not instantiated with the Injector that knows the Component.
     */
    openComponent(component, options, injector) {
        const factoryResolver = (injector || this.injector).get(ComponentFactoryResolver);
        const factory = factoryResolver.resolveComponentFactory(component);
        const componentRef = factory.create(injector || this.injector);
        const result = this.open(componentRef, options);
        return {
            result: result,
            instance: componentRef.instance
        };
    }
    open(content, options) {
        return new Promise(resolve => {
            if (this.openComponents.length && options && options.stacked) {
                this.lastOpenModalElement().classList.add('hidden');
            }
            else {
                this.close();
            }
            if (!this.openComponents.length) {
                document.body.classList.add('rb-modal-open');
                if (this.appRef.components.length) {
                    this.appRoot.classList.add('rb-modal-frost');
                }
                this.ensureListeners();
            }
            this.backdrop.classList.remove('large-fix');
            const componentRef = this.componentFactory.create(this.injector);
            if (content instanceof TemplateRef) {
                componentRef.instance.contentTpl = content;
            }
            else if (typeof (content) === 'string') {
                componentRef.instance.contentText = content;
            }
            else if (content instanceof ComponentRef) {
                componentRef.instance.contentComponentRef = content;
            }
            else if (typeof (content) === 'function') {
                componentRef.instance.contentComponent = content;
            }
            componentRef.instance.close = this.close.bind(this);
            if (options) {
                Object.assign(componentRef.instance.options, options);
            }
            this.appRef.attachView(componentRef.hostView);
            this.backdrop.appendChild(componentRef.location.nativeElement);
            componentRef.location.nativeElement.focus();
            // Fix for IE
            setTimeout(() => {
                if (componentRef.location.nativeElement.offsetTop < 0) {
                    this.backdrop.classList.add('large-fix');
                }
            }, 10);
            this.openComponents.push({
                componentRef: componentRef,
                onClose: resolve
            });
        });
    }
    close(reason) {
        const openModal = this.openComponents.pop();
        if (!openModal) {
            return;
        }
        this.appRef.detachView(openModal.componentRef.hostView);
        openModal.componentRef.destroy();
        if (!this.openComponents.length) {
            document.body.classList.remove('rb-modal-open');
            if (this.appRef.components.length) {
                this.appRoot.classList.remove('rb-modal-frost');
            }
            this.removeListeners();
        }
        else {
            this.lastOpenModalElement().classList.remove('hidden');
        }
        if (openModal.onClose) {
            openModal.onClose(reason);
        }
    }
    nonButtonClose() {
        const instance = this.lastOpenModalInstance();
        if (instance && instance.options.backdropClose || !instance) {
            this.close();
        }
    }
    ensureListeners() {
        if (!this.keyListener) {
            this.keyListener = e => {
                // ESC pressed
                if (e.key === 'Escape') {
                    this.nonButtonClose();
                }
            };
        }
        document.addEventListener('keyup', this.keyListener, true);
        if (!this.focusListener) {
            this.focusListener = e => {
                // Focus changes
                if (this.appRoot.contains(document.activeElement)) {
                    const firstFocusable = this.backdrop.querySelector('a,button');
                    firstFocusable.focus();
                }
            };
        }
        document.addEventListener('focus', this.focusListener, true);
    }
    removeListeners() {
        if (this.keyListener) {
            document.removeEventListener('keyup', this.keyListener, true);
        }
        if (this.focusListener) {
            document.removeEventListener('focus', this.focusListener, true);
        }
    }
    lastOpenModal() {
        return this.openComponents[this.openComponents.length - 1];
    }
    lastOpenModalElement() {
        const modal = this.lastOpenModal();
        if (modal) {
            return modal.componentRef.location.nativeElement;
        }
    }
    lastOpenModalInstance() {
        const modal = this.lastOpenModal();
        if (modal) {
            return modal.componentRef.instance;
        }
    }
};
ModalService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__metadata("design:paramtypes", [ComponentFactoryResolver,
        Injector,
        ApplicationRef])
], ModalService);
export { ModalService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BpbnN0LWlvdC9ib3NjaC1hbmd1bGFyLXVpLWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJhdG9tcy9tb2RhbC9tb2RhbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsY0FBYyxFQUVkLHdCQUF3QixFQUN4QixZQUFZLEVBQ1osVUFBVSxFQUNWLFFBQVEsRUFDUixXQUFXLEVBRVosTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGNBQWMsRUFBZ0IsTUFBTSxtQkFBbUIsQ0FBQztBQWFqRSxJQUFhLFlBQVksR0FBekIsTUFBYSxZQUFZO0lBWXZCLFlBQW9CLGVBQXlDLEVBQ3pDLFFBQWtCLEVBQ2xCLE1BQXNCO1FBRnRCLG9CQUFlLEdBQWYsZUFBZSxDQUEwQjtRQUN6QyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBUGxDLG1CQUFjLEdBQWdCLEVBQUUsQ0FBQztRQVF2QyxNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDeEQsSUFBSSxFQUFFLEVBQUU7WUFDTixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztTQUNwQjthQUFNO1lBQ0wsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDekUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsbUJBQW1CLENBQUM7WUFDOUMsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDO1lBQ25CLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxFQUFFO2dCQUM5QyxJQUFJLENBQUMsQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLFFBQVEsRUFBRTtv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WSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUM7U0FDbEQ7SUFDSCxDQUFDO0lBRU8scUJBQXFCO1FBQzNCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNuQyxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sS0FBSyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7U0FDcEM7SUFDSCxDQUFDO0NBR0YsQ0FBQTtBQWhNWSxZQUFZO0lBRHhCLFVBQVUsRUFBRTs2Q0FhMEIsd0JBQXdCO1FBQy9CLFFBQVE7UUFDVixjQUFjO0dBZC9CLFlBQVksQ0FnTXhCO1NBaE1ZLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIEFwcGxpY2F0aW9uUmVmLFxyXG4gIENvbXBvbmVudEZhY3RvcnksXHJcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gIENvbXBvbmVudFJlZixcclxuICBJbmplY3RhYmxlLFxyXG4gIEluamVjdG9yLFxyXG4gIFRlbXBsYXRlUmVmLFxyXG4gIFR5cGVcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTW9kYWxDb21wb25lbnQsIE1vZGFsT3B0aW9ucyB9IGZyb20gJy4vbW9kYWwuY29tcG9uZW50JztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgT3Blbk1vZGFsIHtcclxuICBjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxNb2RhbENvbXBvbmVudD47XHJcbiAgb25DbG9zZTogKHJlYXNvbj86IGFueSkgPT4gdm9pZDtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDb21wb25lbnRNb2RhbDxUPiB7XHJcbiAgaW5zdGFuY2U6IFQ7XHJcbiAgcmVzdWx0OiBQcm9taXNlPGFueT47XHJcbn1cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE1vZGFsU2VydmljZSB7XHJcblxyXG4gIGJhY2tkcm9wOiBFbGVtZW50O1xyXG4gIGNvbnRhaW5lcjogRWxlbWVudDtcclxuXHJcbiAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5OiBDb21wb25lbnRGYWN0b3J5PE1vZGFsQ29tcG9uZW50PjtcclxuXHJcbiAgcHJpdmF0ZSBvcGVuQ29tcG9uZW50czogT3Blbk1vZGFsW10gPSBbXTtcclxuXHJcbiAgcHJpdmF0ZSBrZXlMaXN0ZW5lcjtcclxuICBwcml2YXRlIGZvY3VzTGlzdGVuZXI7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBhcHBSZWY6IEFwcGxpY2F0aW9uUmVmKSB7XHJcbiAgICBjb25zdCBlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5yYi1tb2RhbC1iYWNrZHJvcCcpO1xyXG4gICAgaWYgKGVsKSB7XHJcbiAgICAgIHRoaXMuYmFja2Ryb3AgPSBlbDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuYmFja2Ryb3AgPSBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTtcclxuICAgICAgdGhpcy5iYWNrZHJvcC5jbGFzc05hbWUgPSAncmItbW9kYWwtYmFja2Ryb3AnO1xyXG4gICAgICBsZXQgaXNEb3duID0gZmFsc2U7XHJcbiAgICAgIHRoaXMuYmFja2Ryb3AuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZSA9PiB7XHJcbiAgICAgICAgaWYgKGUudGFyZ2V0ID09PSB0aGlzLmJhY2tkcm9wKSB7XHJcbiAgICAgICAgICBpc0Rvd24gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMuYmFja2Ryb3AuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGUgPT4ge1xyXG4gICAgICAgIGlmIChpc0Rvd24gJiYgZS50YXJnZXQgPT09IHRoaXMuYmFja2Ryb3ApIHtcclxuICAgICAgICAgIHRoaXMubm9uQnV0dG9uQ2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaXNEb3duID0gZmFsc2U7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jb21wb25lbnRGYWN0b3J5ID0gdGhpcy5mYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoTW9kYWxDb21wb25lbnQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXQgYXBwUm9vdCgpOiBFbGVtZW50IHtcclxuICAgIHJldHVybiB0aGlzLmFwcFJlZi5jb21wb25lbnRzWzBdLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBPcGVucyBhIGNvbXBvbmVudCBpbiBhIG1vZGFsLiBDcmVhdGVzIHRoZSBjb21wb25lbnQgaW5zdGFuY2UuXHJcbiAgICogUHJvdmlkZSBhbiBpbmplY3RvciBpbiBjYXNlIHRoZSBNb2RhbFNlcnZpY2UgaXMgbm90IGluc3RhbnRpYXRlZCB3aXRoIHRoZSBJbmplY3RvciB0aGF0IGtub3dzIHRoZSBDb21wb25lbnQuXHJcbiAgICovXHJcbiAgb3BlbkNvbXBvbmVudDxUPihjb21wb25lbnQ6IFR5cGU8VD4sIG9wdGlvbnM/OiBNb2RhbE9wdGlvbnMsIGluamVjdG9yPzogSW5qZWN0b3IpOiBDb21wb25lbnRNb2RhbDxUPiB7XHJcbiAgICBjb25zdCBmYWN0b3J5UmVzb2x2ZXIgPSAoaW5qZWN0b3IgfHwgdGhpcy5pbmplY3RvcikuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcik7XHJcbiAgICBjb25zdCBmYWN0b3J5ID0gZmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudCk7XHJcbiAgICBjb25zdCBjb21wb25lbnRSZWYgPSBmYWN0b3J5LmNyZWF0ZShpbmplY3RvciB8fCB0aGlzLmluamVjdG9yKTtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMub3Blbihjb21wb25lbnRSZWYsIG9wdGlvbnMpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgcmVzdWx0OiByZXN1bHQsXHJcbiAgICAgIGluc3RhbmNlOiBjb21wb25lbnRSZWYuaW5zdGFuY2VcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBvcGVuKGNvbnRlbnQ6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gfCBUeXBlPGFueT4gfCBDb21wb25lbnRSZWY8YW55Piwgb3B0aW9ucz86IE1vZGFsT3B0aW9ucyk6IFByb21pc2U8YW55PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PihyZXNvbHZlID0+IHtcclxuICAgICAgaWYgKHRoaXMub3BlbkNvbXBvbmVudHMubGVuZ3RoICYmIG9wdGlvbnMgJiYgb3B0aW9ucy5zdGFja2VkKSB7XHJcbiAgICAgICAgdGhpcy5sYXN0T3Blbk1vZGFsRWxlbWVudCgpLmNsYXNzTGlzdC5hZGQoJ2hpZGRlbicpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCF0aGlzLm9wZW5Db21wb25lbnRzLmxlbmd0aCkge1xyXG4gICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgncmItbW9kYWwtb3BlbicpO1xyXG4gICAgICAgIGlmICh0aGlzLmFwcFJlZi5jb21wb25lbnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgdGhpcy5hcHBSb290LmNsYXNzTGlzdC5hZGQoJ3JiLW1vZGFsLWZyb3N0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZW5zdXJlTGlzdGVuZXJzKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuYmFja2Ryb3AuY2xhc3NMaXN0LnJlbW92ZSgnbGFyZ2UtZml4Jyk7XHJcblxyXG4gICAgICBjb25zdCBjb21wb25lbnRSZWYgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWN0b3IpO1xyXG4gICAgICBpZiAoY29udGVudCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKSB7XHJcbiAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLmNvbnRlbnRUcGwgPSBjb250ZW50O1xyXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiAoY29udGVudCkgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLmNvbnRlbnRUZXh0ID0gY29udGVudDtcclxuICAgICAgfSBlbHNlIGlmIChjb250ZW50IGluc3RhbmNlb2YgQ29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLmNvbnRlbnRDb21wb25lbnRSZWYgPSBjb250ZW50O1xyXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiAoY29udGVudCkgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICBjb21wb25lbnRSZWYuaW5zdGFuY2UuY29udGVudENvbXBvbmVudCA9IGNvbnRlbnQ7XHJcbiAgICAgIH1cclxuICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLmNsb3NlID0gdGhpcy5jbG9zZS5iaW5kKHRoaXMpO1xyXG4gICAgICBpZiAob3B0aW9ucykge1xyXG4gICAgICAgIE9iamVjdC5hc3NpZ24oY29tcG9uZW50UmVmLmluc3RhbmNlLm9wdGlvbnMsIG9wdGlvbnMpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KGNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XHJcblxyXG4gICAgICB0aGlzLmJhY2tkcm9wLmFwcGVuZENoaWxkKGNvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuXHJcbiAgICAgIGNvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XHJcblxyXG4gICAgICAvLyBGaXggZm9yIElFXHJcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIGlmIChjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5vZmZzZXRUb3AgPCAwKSB7XHJcbiAgICAgICAgICB0aGlzLmJhY2tkcm9wLmNsYXNzTGlzdC5hZGQoJ2xhcmdlLWZpeCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSwgMTApO1xyXG5cclxuXHJcbiAgICAgIHRoaXMub3BlbkNvbXBvbmVudHMucHVzaCh7XHJcbiAgICAgICAgY29tcG9uZW50UmVmOiBjb21wb25lbnRSZWYsXHJcbiAgICAgICAgb25DbG9zZTogcmVzb2x2ZVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgY2xvc2UocmVhc29uPzogYW55KSB7XHJcbiAgICBjb25zdCBvcGVuTW9kYWwgPSB0aGlzLm9wZW5Db21wb25lbnRzLnBvcCgpO1xyXG4gICAgaWYgKCFvcGVuTW9kYWwpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYXBwUmVmLmRldGFjaFZpZXcob3Blbk1vZGFsLmNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XHJcbiAgICBvcGVuTW9kYWwuY29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgIGlmICghdGhpcy5vcGVuQ29tcG9uZW50cy5sZW5ndGgpIHtcclxuICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdyYi1tb2RhbC1vcGVuJyk7XHJcbiAgICAgIGlmICh0aGlzLmFwcFJlZi5jb21wb25lbnRzLmxlbmd0aCkge1xyXG4gICAgICAgIHRoaXMuYXBwUm9vdC5jbGFzc0xpc3QucmVtb3ZlKCdyYi1tb2RhbC1mcm9zdCcpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmxhc3RPcGVuTW9kYWxFbGVtZW50KCkuY2xhc3NMaXN0LnJlbW92ZSgnaGlkZGVuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG9wZW5Nb2RhbC5vbkNsb3NlKSB7XHJcbiAgICAgIG9wZW5Nb2RhbC5vbkNsb3NlKHJlYXNvbik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG5vbkJ1dHRvbkNsb3NlKCkge1xyXG4gICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLmxhc3RPcGVuTW9kYWxJbnN0YW5jZSgpO1xyXG4gICAgaWYgKGluc3RhbmNlICYmIGluc3RhbmNlLm9wdGlvbnMuYmFja2Ryb3BDbG9zZSB8fCAhaW5zdGFuY2UpIHtcclxuICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBlbnN1cmVMaXN0ZW5lcnMoKSB7XHJcbiAgICBpZiAoIXRoaXMua2V5TGlzdGVuZXIpIHtcclxuICAgICAgdGhpcy5rZXlMaXN0ZW5lciA9IGUgPT4ge1xyXG4gICAgICAgIC8vIEVTQyBwcmVzc2VkXHJcbiAgICAgICAgaWYgKGUua2V5ID09PSAnRXNjYXBlJykge1xyXG4gICAgICAgICAgdGhpcy5ub25CdXR0b25DbG9zZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgdGhpcy5rZXlMaXN0ZW5lciwgdHJ1ZSk7XHJcblxyXG4gICAgaWYgKCF0aGlzLmZvY3VzTGlzdGVuZXIpIHtcclxuICAgICAgdGhpcy5mb2N1c0xpc3RlbmVyID0gZSA9PiB7XHJcbiAgICAgICAgLy8gRm9jdXMgY2hhbmdlc1xyXG4gICAgICAgIGlmICh0aGlzLmFwcFJvb3QuY29udGFpbnMoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkpIHtcclxuICAgICAgICAgIGNvbnN0IGZpcnN0Rm9jdXNhYmxlID0gdGhpcy5iYWNrZHJvcC5xdWVyeVNlbGVjdG9yKCdhLGJ1dHRvbicpO1xyXG4gICAgICAgICAgKGZpcnN0Rm9jdXNhYmxlIGFzIEhUTUxFbGVtZW50KS5mb2N1cygpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgdGhpcy5mb2N1c0xpc3RlbmVyLCB0cnVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlTGlzdGVuZXJzKCkge1xyXG4gICAgaWYgKHRoaXMua2V5TGlzdGVuZXIpIHtcclxuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB0aGlzLmtleUxpc3RlbmVyLCB0cnVlKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmZvY3VzTGlzdGVuZXIpIHtcclxuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignZm9jdXMnLCB0aGlzLmZvY3VzTGlzdGVuZXIsIHRydWUpO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIHByaXZhdGUgbGFzdE9wZW5Nb2RhbCgpOiBPcGVuTW9kYWwge1xyXG4gICAgcmV0dXJuIHRoaXMub3BlbkNvbXBvbmVudHNbdGhpcy5vcGVuQ29tcG9uZW50cy5sZW5ndGggLSAxXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbGFzdE9wZW5Nb2RhbEVsZW1lbnQoKTogRWxlbWVudCB7XHJcbiAgICBjb25zdCBtb2RhbCA9IHRoaXMubGFzdE9wZW5Nb2RhbCgpO1xyXG4gICAgaWYgKG1vZGFsKSB7XHJcbiAgICAgIHJldHVybiBtb2RhbC5jb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgbGFzdE9wZW5Nb2RhbEluc3RhbmNlKCk6IE1vZGFsQ29tcG9uZW50IHtcclxuICAgIGNvbnN0IG1vZGFsID0gdGhpcy5sYXN0T3Blbk1vZGFsKCk7XHJcbiAgICBpZiAobW9kYWwpIHtcclxuICAgICAgcmV0dXJuIG1vZGFsLmNvbXBvbmVudFJlZi5pbnN0YW5jZTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxufVxyXG4iXX0=