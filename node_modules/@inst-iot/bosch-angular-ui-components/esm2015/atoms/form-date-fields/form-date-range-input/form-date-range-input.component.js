import * as tslib_1 from "tslib";
var FormDateRangeInputComponent_1;
import { Component, ContentChildren, ElementRef, forwardRef, Inject, Input, Optional, QueryList, Renderer2, TemplateRef, ViewChild } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import * as flatpickrImport from 'flatpickr';
import { FormValidationMessageDirective } from '../../form-fields/form-validation-message.directive';
import { emptyFunction } from '../../form-fields/forms-util';
import { FLATPICKR_DEFAULT_OPTIONS } from '../form-date-input/form-date-input.component';
import { defaultTimeInputOptions, getRelativeInfo, isAbsolute, isRelative } from '../date-range-picker/date-range-picker.model';
import { TIME_INPUT_OPTIONS } from '../form-relative-time-input/relative-time-input.component';
const flatpickrFunc = flatpickrImport; // workaround for rollup and tests
const overridableOptions = {
    time_24hr: true
};
let FormDateRangeInputComponent = FormDateRangeInputComponent_1 = class FormDateRangeInputComponent {
    constructor(renderer, elementRef, defaultOptions, timeInputOptions) {
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.defaultOptions = defaultOptions;
        this.timeInputOptions = timeInputOptions;
        this.label = null;
        this.id = 'input.' + Math.random();
        this.allowRelative = false;
        this.presets = [];
        this.startLabel = 'Start';
        this.endLabel = 'End';
        this.absoluteLabel = 'Absolute';
        this.relativeLabel = 'Relative';
        this.presetsLabel = 'Presets';
        this.displayValue = '';
        /**
         * Options for Flatpickr
         * @see https://flatpickr.js.org/options/
         */
        this.options = {};
        this.onChange = emptyFunction;
        this.onTouched = emptyFunction;
        this.viewInit = false;
        if (!timeInputOptions) {
            this.timeInputOptions = defaultTimeInputOptions;
        }
    }
    ngAfterViewInit() {
        this.viewInit = true;
        if (isAbsolute(this.value)) {
            this.initPicker();
        }
    }
    ngOnChanges(changes) {
        if (changes.options && this.picker && changes.options.currentValue) {
            Object.keys(changes.options.currentValue).forEach(opt => {
                this.picker.set(opt, changes.options.currentValue[opt]);
            });
        }
    }
    ngOnDestroy() {
        if (this.picker) {
            this.picker.destroy();
        }
    }
    initPicker() {
        if (this.defaultOptions) {
            this.options = Object.assign({}, overridableOptions, this.defaultOptions, this.options, { mode: 'range', clickOpens: false });
        }
        else {
            this.options = Object.assign({}, overridableOptions, this.options, { mode: 'range', clickOpens: false });
        }
        this.picker = flatpickrFunc(this.input.nativeElement, this.options);
        if (this.value) {
            this.picker.setDate(this.value);
        }
    }
    isReadonly() {
        return this.readonly !== undefined;
    }
    updateValue(value) {
        this.value = value;
        this.updateTimeDisplay(value);
        this.checkValue(value);
        this.onChange(value);
    }
    checkValue(value) {
        if (value && value.length) {
            this.renderer.addClass(this.elementRef.nativeElement, 'not-empty');
        }
        else {
            this.renderer.removeClass(this.elementRef.nativeElement, 'not-empty');
        }
    }
    isLabelTemplate() {
        return this.label instanceof TemplateRef;
    }
    writeValue(value) {
        this.value = value;
        this.updateTimeDisplay(value);
    }
    updateTimeDisplay(value) {
        if (isAbsolute(value)) {
            this.renderer.setProperty(this.input.nativeElement, 'value', '');
            if (this.viewInit && !this.picker) {
                this.initPicker();
            }
            else if (this.picker) {
                this.picker.setDate(value);
            }
        }
        if (isRelative(value)) {
            const info1 = getRelativeInfo(value[0], this.timeInputOptions.units);
            const info2 = getRelativeInfo(value[1], this.timeInputOptions.units);
            this.displayValue = info1.displayText + (info2.count ? ' - ' + info2.displayText : '');
            this.renderer.setProperty(this.input.nativeElement, 'value', this.displayValue);
        }
    }
    registerOnChange(fn) {
        this.onChange = fn;
    }
    registerOnTouched(fn) {
        this.onTouched = fn;
    }
    setDisabledState(isDisabled) {
        this.renderer.setProperty(this.input.nativeElement, 'disabled', isDisabled);
    }
};
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "label", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], FormDateRangeInputComponent.prototype, "name", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "readonly", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "allowRelative", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Array)
], FormDateRangeInputComponent.prototype, "presets", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "startLabel", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "endLabel", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "absoluteLabel", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "relativeLabel", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "presetsLabel", void 0);
tslib_1.__decorate([
    ContentChildren(FormValidationMessageDirective),
    tslib_1.__metadata("design:type", QueryList)
], FormDateRangeInputComponent.prototype, "messages", void 0);
tslib_1.__decorate([
    ViewChild('input', { static: true }),
    tslib_1.__metadata("design:type", ElementRef)
], FormDateRangeInputComponent.prototype, "input", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormDateRangeInputComponent.prototype, "options", void 0);
FormDateRangeInputComponent = FormDateRangeInputComponent_1 = tslib_1.__decorate([
    Component({
        selector: 'rb-form-date-range-input',
        template: "<div class=\"input-wrapper\" [class.no-label]=\"!label\">\r\n\r\n  <input [id]=\"id + 'input'\"\r\n         class=\"input with-icon\"\r\n         (blur)=\"onTouched()\"\r\n         [rbDropdown]=\"dropdown\"\r\n         [autoClose]=\"false\"\r\n         [hugContent]=\"true\"\r\n         [readonly]=\"isReadonly()\"\r\n         [value]=\"displayValue\"\r\n         #input>\r\n  <span class=\"input-icon rb-ic rb-ic-calendar\"></span>\r\n  <label class=\"label\" [for]=\"id + 'input'\">\r\n    {{!isLabelTemplate()?label:''}}\r\n    <ng-container *ngIf=\"isLabelTemplate()\">\r\n      <ng-container *ngTemplateOutlet=\"label\"></ng-container>\r\n    </ng-container>\r\n  </label>\r\n  <span class=\"input-background\"></span>\r\n</div>\r\n<rb-form-errors [messages]=\"messages\"></rb-form-errors>\r\n\r\n<ng-template #dropdown>\r\n  <rb-date-range-picker [options]=\"options\"\r\n                        [name]=\"name\"\r\n                        [ngModel]=\"value\"\r\n                        (ngModelChange)=\"updateValue($event)\"\r\n                        [allowRelative]=\"allowRelative\"\r\n                        [startLabel]=\"startLabel\"\r\n                        [endLabel]=\"endLabel\"\r\n                        [absoluteLabel]=\"absoluteLabel\"\r\n                        [relativeLabel]=\"relativeLabel\"\r\n                        [presetsLabel]=\"presetsLabel\"\r\n                        [presets]=\"presets\"\r\n  ></rb-date-range-picker>\r\n</ng-template>\r\n",
        providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(() => FormDateRangeInputComponent_1), multi: true }]
    }),
    tslib_1.__param(2, Optional()), tslib_1.__param(2, Inject(FLATPICKR_DEFAULT_OPTIONS)),
    tslib_1.__param(3, Optional()), tslib_1.__param(3, Inject(TIME_INPUT_OPTIONS)),
    tslib_1.__metadata("design:paramtypes", [Renderer2,
        ElementRef, Object, Object])
], FormDateRangeInputComponent);
export { FormDateRangeInputComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1kYXRlLXJhbmdlLWlucHV0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BpbnN0LWlvdC9ib3NjaC1hbmd1bGFyLXVpLWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJhdG9tcy9mb3JtLWRhdGUtZmllbGRzL2Zvcm0tZGF0ZS1yYW5nZS1pbnB1dC9mb3JtLWRhdGUtcmFuZ2UtaW5wdXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUVMLFNBQVMsRUFDVCxlQUFlLEVBQ2YsVUFBVSxFQUNWLFVBQVUsRUFDVixNQUFNLEVBQ04sS0FBSyxFQUdMLFFBQVEsRUFDUixTQUFTLEVBQ1QsU0FBUyxFQUVULFdBQVcsRUFDWCxTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUF3QixpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQWtCLEtBQUssZUFBZSxNQUFNLFdBQVcsQ0FBQztBQUN4RCxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxxREFBcUQsQ0FBQztBQUNyRyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDN0QsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sOENBQThDLENBQUM7QUFDekYsT0FBTyxFQUVMLHVCQUF1QixFQUFFLGVBQWUsRUFDeEMsVUFBVSxFQUNWLFVBQVUsRUFHWCxNQUFNLDhDQUE4QyxDQUFDO0FBQ3RELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDJEQUEyRCxDQUFDO0FBRS9GLE1BQU0sYUFBYSxHQUFHLGVBQWtDLENBQUMsQ0FBQyxrQ0FBa0M7QUFHNUYsTUFBTSxrQkFBa0IsR0FBRztJQUN6QixTQUFTLEVBQUUsSUFBSTtDQUNoQixDQUFDO0FBT0YsSUFBYSwyQkFBMkIsbUNBQXhDLE1BQWEsMkJBQTJCO0lBb0N0QyxZQUFvQixRQUFtQixFQUNuQixVQUFzQixFQUN5QixjQUFtQixFQUMxQixnQkFB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NkRBQTZDO0FBQzVDO0lBQVIsS0FBSyxFQUFFOztrRUFBdUQ7QUFDdEQ7SUFBUixLQUFLLEVBQUU7O2tFQUF1RDtBQUN0RDtJQUFSLEtBQUssRUFBRTs7aUVBQXFEO0FBRVo7SUFBaEQsZUFBZSxDQUFDLDhCQUE4QixDQUFDO3NDQUFXLFNBQVM7NkRBQWlDO0FBQ2pFO0lBQW5DLFNBQVMsQ0FBQyxPQUFPLEVBQUUsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFDLENBQUM7c0NBQVEsVUFBVTswREFBQztBQVk3QztJQUFSLEtBQUssRUFBRTs7NERBQW1CO0FBN0JoQiwyQkFBMkI7SUFMdkMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLDBCQUEwQjtRQUNwQyxvOUNBQXFEO1FBQ3JELFNBQVMsRUFBRSxDQUFDLEVBQUMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsNkJBQTJCLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFDLENBQUM7S0FDbkgsQ0FBQztJQXVDYSxtQkFBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLG1CQUFBLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO0lBQzdDLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUE7NkNBSHJCLFNBQVM7UUFDUCxVQUFVO0dBckMvQiwyQkFBMkIsQ0FzSnZDO1NBdEpZLDJCQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQWZ0ZXJWaWV3SW5pdCwgQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgQ29tcG9uZW50LFxyXG4gIENvbnRlbnRDaGlsZHJlbixcclxuICBFbGVtZW50UmVmLFxyXG4gIGZvcndhcmRSZWYsXHJcbiAgSW5qZWN0LFxyXG4gIElucHV0LFxyXG4gIE9uQ2hhbmdlcyxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT3B0aW9uYWwsXHJcbiAgUXVlcnlMaXN0LFxyXG4gIFJlbmRlcmVyMixcclxuICBTaW1wbGVDaGFuZ2VzLFxyXG4gIFRlbXBsYXRlUmVmLFxyXG4gIFZpZXdDaGlsZFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb250cm9sVmFsdWVBY2Nlc3NvciwgTkdfVkFMVUVfQUNDRVNTT1IgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCBmbGF0cGlja3IsICogYXMgZmxhdHBpY2tySW1wb3J0IGZyb20gJ2ZsYXRwaWNrcic7XHJcbmltcG9ydCB7IEZvcm1WYWxpZGF0aW9uTWVzc2FnZURpcmVjdGl2ZSB9IGZyb20gJy4uLy4uL2Zvcm0tZmllbGRzL2Zvcm0tdmFsaWRhdGlvbi1tZXNzYWdlLmRpcmVjdGl2ZSc7XHJcbmltcG9ydCB7IGVtcHR5RnVuY3Rpb24gfSBmcm9tICcuLi8uLi9mb3JtLWZpZWxkcy9mb3Jtcy11dGlsJztcclxuaW1wb3J0IHsgRkxBVFBJQ0tSX0RFRkFVTFRfT1BUSU9OUyB9IGZyb20gJy4uL2Zvcm0tZGF0ZS1pbnB1dC9mb3JtLWRhdGUtaW5wdXQuY29tcG9uZW50JztcclxuaW1wb3J0IHtcclxuICBEYXRlUmFuZ2VQaWNrZXJQcmVzZXQsXHJcbiAgZGVmYXVsdFRpbWVJbnB1dE9wdGlvbnMsIGdldFJlbGF0aXZlSW5mbyxcclxuICBpc0Fic29sdXRlLFxyXG4gIGlzUmVsYXRpdmUsXHJcbiAgUGlja2VyVmFsdWUsXHJcbiAgVGltZUlucHV0T3B0aW9uc1xyXG59IGZyb20gJy4uL2RhdGUtcmFuZ2UtcGlja2VyL2RhdGUtcmFuZ2UtcGlja2VyLm1vZGVsJztcclxuaW1wb3J0IHsgVElNRV9JTlBVVF9PUFRJT05TIH0gZnJvbSAnLi4vZm9ybS1yZWxhdGl2ZS10aW1lLWlucHV0L3JlbGF0aXZlLXRpbWUtaW5wdXQuY29tcG9uZW50JztcclxuXHJcbmNvbnN0IGZsYXRwaWNrckZ1bmMgPSBmbGF0cGlja3JJbXBvcnQgYXMgYW55IGFzIEZ1bmN0aW9uOyAvLyB3b3JrYXJvdW5kIGZvciByb2xsdXAgYW5kIHRlc3RzXHJcblxyXG5cclxuY29uc3Qgb3ZlcnJpZGFibGVPcHRpb25zID0ge1xyXG4gIHRpbWVfMjRocjogdHJ1ZVxyXG59O1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdyYi1mb3JtLWRhdGUtcmFuZ2UtaW5wdXQnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9mb3JtLWRhdGUtcmFuZ2UtaW5wdXQuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHByb3ZpZGVyczogW3twcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUiwgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gRm9ybURhdGVSYW5nZUlucHV0Q29tcG9uZW50KSwgbXVsdGk6IHRydWV9XSxcclxufSlcclxuZXhwb3J0IGNsYXNzIEZvcm1EYXRlUmFuZ2VJbnB1dENvbXBvbmVudCBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcyB7XHJcblxyXG4gIEBJbnB1dCgpIGxhYmVsOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+ID0gbnVsbDtcclxuICBASW5wdXQoKSBuYW1lOiBzdHJpbmc7XHJcbiAgaWQgPSAnaW5wdXQuJyArIE1hdGgucmFuZG9tKCk7XHJcbiAgQElucHV0KCkgcmVhZG9ubHk7XHJcblxyXG4gIEBJbnB1dCgpIGFsbG93UmVsYXRpdmUgPSBmYWxzZTtcclxuICBASW5wdXQoKSBwcmVzZXRzOiBEYXRlUmFuZ2VQaWNrZXJQcmVzZXRbXSA9IFtdO1xyXG5cclxuICBASW5wdXQoKSBzdGFydExhYmVsOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+ID0gJ1N0YXJ0JztcclxuICBASW5wdXQoKSBlbmRMYWJlbDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9ICdFbmQnO1xyXG4gIEBJbnB1dCgpIGFic29sdXRlTGFiZWw6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gPSAnQWJzb2x1dGUnO1xyXG4gIEBJbnB1dCgpIHJlbGF0aXZlTGFiZWw6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gPSAnUmVsYXRpdmUnO1xyXG4gIEBJbnB1dCgpIHByZXNldHNMYWJlbDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9ICdQcmVzZXRzJztcclxuXHJcbiAgQENvbnRlbnRDaGlsZHJlbihGb3JtVmFsaWRhdGlvbk1lc3NhZ2VEaXJlY3RpdmUpIG1lc3NhZ2VzOiBRdWVyeUxpc3Q8Rm9ybVZhbGlkYXRpb25NZXNzYWdlRGlyZWN0aXZlPjtcclxuICBAVmlld0NoaWxkKCdpbnB1dCcsIHtzdGF0aWM6IHRydWV9KSBpbnB1dDogRWxlbWVudFJlZjtcclxuXHJcbiAgcHJpdmF0ZSBwaWNrZXI6IGZsYXRwaWNrci5JbnN0YW5jZTtcclxuXHJcbiAgdmFsdWU6IFBpY2tlclZhbHVlO1xyXG5cclxuICBkaXNwbGF5VmFsdWUgPSAnJztcclxuXHJcbiAgLyoqXHJcbiAgICogT3B0aW9ucyBmb3IgRmxhdHBpY2tyXHJcbiAgICogQHNlZSBodHRwczovL2ZsYXRwaWNrci5qcy5vcmcvb3B0aW9ucy9cclxuICAgKi9cclxuICBASW5wdXQoKSBvcHRpb25zOiBhbnkgPSB7fTtcclxuXHJcbiAgb25DaGFuZ2UgPSBlbXB0eUZ1bmN0aW9uO1xyXG4gIG9uVG91Y2hlZCA9IGVtcHR5RnVuY3Rpb247XHJcblxyXG4gIHByaXZhdGUgdmlld0luaXQgPSBmYWxzZTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZixcclxuICAgICAgICAgICAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEZMQVRQSUNLUl9ERUZBVUxUX09QVElPTlMpIHByaXZhdGUgZGVmYXVsdE9wdGlvbnM6IGFueSxcclxuICAgICAgICAgICAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFRJTUVfSU5QVVRfT1BUSU9OUykgcHJpdmF0ZSB0aW1lSW5wdXRPcHRpb25zOiBUaW1lSW5wdXRPcHRpb25zKSB7XHJcbiAgICBpZiAoIXRpbWVJbnB1dE9wdGlvbnMpIHtcclxuICAgICAgdGhpcy50aW1lSW5wdXRPcHRpb25zID0gZGVmYXVsdFRpbWVJbnB1dE9wdGlvbnM7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnZpZXdJbml0ID0gdHJ1ZTtcclxuICAgIGlmIChpc0Fic29sdXRlKHRoaXMudmFsdWUpKSB7XHJcbiAgICAgIHRoaXMuaW5pdFBpY2tlcigpO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuICAgIGlmIChjaGFuZ2VzLm9wdGlvbnMgJiYgdGhpcy5waWNrZXIgJiYgY2hhbmdlcy5vcHRpb25zLmN1cnJlbnRWYWx1ZSkge1xyXG4gICAgICBPYmplY3Qua2V5cyhjaGFuZ2VzLm9wdGlvbnMuY3VycmVudFZhbHVlKS5mb3JFYWNoKG9wdCA9PiB7XHJcbiAgICAgICAgdGhpcy5waWNrZXIuc2V0KG9wdCBhcyBhbnksIGNoYW5nZXMub3B0aW9ucy5jdXJyZW50VmFsdWVbb3B0XSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5waWNrZXIpIHtcclxuICAgICAgdGhpcy5waWNrZXIuZGVzdHJveSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaW5pdFBpY2tlcigpIHtcclxuICAgIGlmICh0aGlzLmRlZmF1bHRPcHRpb25zKSB7XHJcbiAgICAgIHRoaXMub3B0aW9ucyA9IHtcclxuICAgICAgICAuLi5vdmVycmlkYWJsZU9wdGlvbnMsXHJcbiAgICAgICAgLi4udGhpcy5kZWZhdWx0T3B0aW9ucyxcclxuICAgICAgICAuLi50aGlzLm9wdGlvbnMsXHJcbiAgICAgICAgbW9kZTogJ3JhbmdlJyxcclxuICAgICAgICBjbGlja09wZW5zOiBmYWxzZVxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5vcHRpb25zID0ge1xyXG4gICAgICAgIC4uLm92ZXJyaWRhYmxlT3B0aW9ucyxcclxuICAgICAgICAuLi50aGlzLm9wdGlvbnMsXHJcbiAgICAgICAgbW9kZTogJ3JhbmdlJyxcclxuICAgICAgICBjbGlja09wZW5zOiBmYWxzZVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucGlja2VyID0gZmxhdHBpY2tyRnVuYyh0aGlzLmlucHV0Lm5hdGl2ZUVsZW1lbnQsIHRoaXMub3B0aW9ucykgYXMgZmxhdHBpY2tyLkluc3RhbmNlO1xyXG4gICAgaWYgKHRoaXMudmFsdWUpIHtcclxuICAgICAgdGhpcy5waWNrZXIuc2V0RGF0ZSh0aGlzLnZhbHVlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGlzUmVhZG9ubHkoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZWFkb25seSAhPT0gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlVmFsdWUodmFsdWUpIHtcclxuICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcclxuICAgIHRoaXMudXBkYXRlVGltZURpc3BsYXkodmFsdWUpO1xyXG5cclxuICAgIHRoaXMuY2hlY2tWYWx1ZSh2YWx1ZSk7XHJcbiAgICB0aGlzLm9uQ2hhbmdlKHZhbHVlKTtcclxuICB9XHJcblxyXG4gIGNoZWNrVmFsdWUodmFsdWUpIHtcclxuICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ25vdC1lbXB0eScpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ25vdC1lbXB0eScpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXNMYWJlbFRlbXBsYXRlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubGFiZWwgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZjtcclxuICB9XHJcblxyXG5cclxuICB3cml0ZVZhbHVlKHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcclxuICAgIHRoaXMudXBkYXRlVGltZURpc3BsYXkodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlVGltZURpc3BsYXkodmFsdWU6IGFueSkge1xyXG4gICAgaWYgKGlzQWJzb2x1dGUodmFsdWUpKSB7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5pbnB1dC5uYXRpdmVFbGVtZW50LCAndmFsdWUnLCAnJyk7XHJcbiAgICAgIGlmICh0aGlzLnZpZXdJbml0ICYmICF0aGlzLnBpY2tlcikge1xyXG4gICAgICAgIHRoaXMuaW5pdFBpY2tlcigpO1xyXG4gICAgICB9IGVsc2UgaWYgKHRoaXMucGlja2VyKSB7XHJcbiAgICAgICAgdGhpcy5waWNrZXIuc2V0RGF0ZSh2YWx1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChpc1JlbGF0aXZlKHZhbHVlKSkge1xyXG4gICAgICBjb25zdCBpbmZvMSA9IGdldFJlbGF0aXZlSW5mbyh2YWx1ZVswXSwgdGhpcy50aW1lSW5wdXRPcHRpb25zLnVuaXRzKTtcclxuICAgICAgY29uc3QgaW5mbzIgPSBnZXRSZWxhdGl2ZUluZm8odmFsdWVbMV0sIHRoaXMudGltZUlucHV0T3B0aW9ucy51bml0cyk7XHJcbiAgICAgIHRoaXMuZGlzcGxheVZhbHVlID0gaW5mbzEuZGlzcGxheVRleHQgKyAoaW5mbzIuY291bnQgPyAnIC0gJyArIGluZm8yLmRpc3BsYXlUZXh0IDogJycpO1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuaW5wdXQubmF0aXZlRWxlbWVudCwgJ3ZhbHVlJywgdGhpcy5kaXNwbGF5VmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJPbkNoYW5nZShmbjogKF86IGFueSkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdGhpcy5vbkNoYW5nZSA9IGZuO1xyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46ICgpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIHRoaXMub25Ub3VjaGVkID0gZm47XHJcbiAgfVxyXG5cclxuICBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5pbnB1dC5uYXRpdmVFbGVtZW50LCAnZGlzYWJsZWQnLCBpc0Rpc2FibGVkKTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==