import * as tslib_1 from "tslib";
import { ComponentFactoryResolver, Directive, HostListener, Inject, Injector, Input, Optional, Self, TemplateRef, ViewContainerRef } from '@angular/core';
import { NEVER, of, Subject } from 'rxjs';
import { DropdownDirective } from '../../dropdown/dropdown.directive';
import { NG_VALUE_ACCESSOR, NgControl } from '@angular/forms';
import { catchError, debounceTime, skip, switchMap, takeUntil, tap } from 'rxjs/operators';
import { FormInputAutocompleteListComponent } from './form-input-autocomplete-list/form-input-autocomplete-list.component';
let FormInputAutocompleteDirective = class FormInputAutocompleteDirective extends DropdownDirective {
    constructor(_factoryResolver, injector, viewContainerRef, control, inputs) {
        super(_factoryResolver, viewContainerRef);
        this._factoryResolver = _factoryResolver;
        this.injector = injector;
        this.control = control;
        /**
         * Should the dropdown open on initial click without any value change
         */
        this.rbInitialOpen = false;
        this.rbDebounceTime = 500;
        this.destroy = new Subject();
        this.loading = false;
        this.error = null;
        this.lastResult = null;
        this.focus = null;
        this.input = null;
        this.noSearchFor = null;
        if (inputs) {
            this.input = inputs[0];
        }
        this.openOnClick = false;
    }
    ngOnInit() {
        super.ngOnInit();
        if (this.rbInitialOpen) {
            this.openOnClick = true;
        }
        if (!this.rbAutocompleteList) {
            const factory = this._factoryResolver.resolveComponentFactory(FormInputAutocompleteListComponent);
            const component = factory.create(this.injector);
            this.instance = component.instance;
            this.rbAutocompleteList = component.instance.template;
        }
        this.template = this.rbAutocompleteList;
        this.updateLoading(false, null);
        let changes = 0;
        let resolvedValue = null;
        this.control.valueChanges.pipe(debounceTime(this.rbDebounceTime), switchMap(value => {
            changes++;
            if (changes === 1 && !this.rbInitialOpen || resolvedValue === value || this.noSearchFor === value) {
                return NEVER;
            }
            resolvedValue = value;
            this.updateLoading(true, null);
            const result = this.rbFormInputAutocomplete(value);
            if (result) {
                return result.pipe(tap(() => this.updateLoading(false, null), err => this.updateLoading(false, err), () => this.updateLoading(false, null)), catchError(err => of(null)), takeUntil(this.control.valueChanges.pipe(skip(1))));
            }
            else {
                this.updateLoading(false, null);
                return of(null);
            }
        }), takeUntil(this.destroy)).subscribe(results => {
            this.openOnClick = true;
            this.lastResult = results;
            if (results !== null && !results.includes(resolvedValue)) {
                this.focus = null;
            }
            this.updateContext(this.control.value);
            if (results !== null && (!this.componentRef || !this.componentRef.instance.shown) && changes > 1) {
                this.openDropdown();
            }
            if (results === null) {
                this.closeDropdown();
            }
        });
    }
    ngAfterViewInit() {
        if (this.input && this.input.input) {
            this.input.input.nativeElement.autocomplete = 'off';
        }
    }
    updateLoading(loading, error) {
        this.loading = loading;
        this.error = error;
        if (this.error) {
            const errors = this.control.errors || {};
            errors['autocomplete'] = this.error;
            this.control.control.setErrors(errors);
        }
        if (this.input && this.loading) {
            this.input.updateIcon('rb-ic rb-ic-spin rb-ic-refresh');
        }
        if (this.input && !this.loading) {
            this.input.updateIcon(this.rbInitialOpen ? 'select-icon rb-ic rb-ic-down' : null);
        }
        if (this.input && this.error) {
            this.input.updateIcon('rb-ic rb-ic-alert-warning u-TextColor--red');
        }
    }
    select(value) {
        this.noSearchFor = value;
        this.control.control.setValue(value);
        this.focus = value;
        this.closeDropdown();
        this.updateContext(value);
    }
    onKeyUp(e) {
        if (e.key === 'ArrowDown' || e.key === 'Down') {
            e.preventDefault();
            this.moveFocus(1);
        }
        if (e.key === 'ArrowUp' || e.key === 'Up') {
            e.preventDefault();
            this.moveFocus(-1);
        }
        if (e.key === 'Enter' && this.componentRef && this.componentRef.instance.shown) {
            e.preventDefault();
            this.select(this.focus);
        }
    }
    moveFocus(by) {
        const list = this.lastResult || [];
        if (!list.length) {
            this.focus = null;
            this.updateContext(this.control.value);
            return;
        }
        let focusIndex = list.indexOf(this.focus);
        if (focusIndex === -1) {
            focusIndex = 0;
        }
        else {
            focusIndex += by;
            if (focusIndex === -1) {
                focusIndex = list.length - 1;
            }
            if (focusIndex === list.length) {
                focusIndex = 0;
            }
        }
        this.focus = list[focusIndex];
        this.updateContext(this.control.value);
    }
    updateContext(value) {
        this.context = {
            list: this.lastResult,
            active: value,
            focus: this.focus,
            select: this.select.bind(this)
        };
    }
    ngOnDestroy() {
        super.ngOnDestroy();
        this.destroy.complete();
        this.input = null;
    }
};
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Function)
], FormInputAutocompleteDirective.prototype, "rbFormInputAutocomplete", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", TemplateRef)
], FormInputAutocompleteDirective.prototype, "rbAutocompleteList", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormInputAutocompleteDirective.prototype, "rbInitialOpen", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], FormInputAutocompleteDirective.prototype, "rbDebounceTime", void 0);
tslib_1.__decorate([
    HostListener('keyup', ['$event']),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [KeyboardEvent]),
    tslib_1.__metadata("design:returntype", void 0)
], FormInputAutocompleteDirective.prototype, "onKeyUp", null);
FormInputAutocompleteDirective = tslib_1.__decorate([
    Directive({
        selector: '[rbFormInputAutocomplete]',
    }),
    tslib_1.__param(3, Self()),
    tslib_1.__param(4, Self()), tslib_1.__param(4, Optional()), tslib_1.__param(4, Inject(NG_VALUE_ACCESSOR)),
    tslib_1.__metadata("design:paramtypes", [ComponentFactoryResolver,
        Injector,
        ViewContainerRef,
        NgControl, Array])
], FormInputAutocompleteDirective);
export { FormInputAutocompleteDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1pbnB1dC1hdXRvY29tcGxldGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGluc3QtaW90L2Jvc2NoLWFuZ3VsYXItdWktY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImF0b21zL2Zvcm0tZmllbGRzL2Zvcm0taW5wdXQvZm9ybS1pbnB1dC1hdXRvY29tcGxldGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBRUwsd0JBQXdCLEVBQ3hCLFNBQVMsRUFDVCxZQUFZLEVBQ1osTUFBTSxFQUNOLFFBQVEsRUFDUixLQUFLLEVBR0wsUUFBUSxFQUNSLElBQUksRUFDSixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0YsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0sdUVBQXVFLENBQUM7QUFNM0gsSUFBYSw4QkFBOEIsR0FBM0MsTUFBYSw4QkFBK0IsU0FBUSxpQkFBaUI7SUF3Q25FLFlBQW9CLGdCQUEwQyxFQUMxQyxRQUFrQixFQUMxQixnQkFBa0MsRUFDbEIsT0FBa0IsRUFDYSxNQUE0QjtRQUVyRixLQUFLLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQU54QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQTBCO1FBQzFDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFFVixZQUFPLEdBQVAsT0FBTyxDQUFX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QUFRLEVBQUUsQ0FBQSxFQUFFLG1CQUFBLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBOzZDQUpwQix3QkFBd0I7UUFDaEMsUUFBUTtRQUNSLGdCQUFnQjtRQUNULFNBQVM7R0EzQ25DLDhCQUE4QixDQTJNMUM7U0EzTVksOEJBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBBZnRlclZpZXdJbml0LFxyXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICBEaXJlY3RpdmUsXHJcbiAgSG9zdExpc3RlbmVyLFxyXG4gIEluamVjdCxcclxuICBJbmplY3RvcixcclxuICBJbnB1dCxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT25Jbml0LFxyXG4gIE9wdGlvbmFsLFxyXG4gIFNlbGYsXHJcbiAgVGVtcGxhdGVSZWYsXHJcbiAgVmlld0NvbnRhaW5lclJlZlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBORVZFUiwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgRHJvcGRvd25EaXJlY3RpdmUgfSBmcm9tICcuLi8uLi9kcm9wZG93bi9kcm9wZG93bi5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBOR19WQUxVRV9BQ0NFU1NPUiwgTmdDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBjYXRjaEVycm9yLCBkZWJvdW5jZVRpbWUsIHNraXAsIHN3aXRjaE1hcCwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZvcm1JbnB1dEF1dG9jb21wbGV0ZUxpc3RDb21wb25lbnQgfSBmcm9tICcuL2Zvcm0taW5wdXQtYXV0b2NvbXBsZXRlLWxpc3QvZm9ybS1pbnB1dC1hdXRvY29tcGxldGUtbGlzdC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBGb3JtSW5wdXRDb21wb25lbnQgfSBmcm9tICcuL2Zvcm0taW5wdXQuY29tcG9uZW50JztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW3JiRm9ybUlucHV0QXV0b2NvbXBsZXRlXScsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGb3JtSW5wdXRBdXRvY29tcGxldGVEaXJlY3RpdmUgZXh0ZW5kcyBEcm9wZG93bkRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgLyoqXHJcbiAgICogRnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgZWFjaCB0aW1lIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZC5cclxuICAgKiBJdCByZXR1cm5zIGFuIG9ic2VydmFibGUsIHdoaWNoIHJlc3VsdCBpcyBwcm92aWRlZCB0byB0aGUgZHJvcGRvd24gbGlzdCB0ZW1wbGF0ZVxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHJiRm9ybUlucHV0QXV0b2NvbXBsZXRlOiAodmFsdWU6IHN0cmluZykgPT4gT2JzZXJ2YWJsZTxzdHJpbmdbXT4gfCBudWxsO1xyXG5cclxuICAvKipcclxuICAgKiBBIHRlbXBsYXRlIHdoaWNoIHJlY2VpdmVzIGEgY29udGV4dCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczpcclxuICAgKiAtIGxpc3Q6IExpc3Qgb2YgcmVzdWx0c1xyXG4gICAqIC0gYWN0aXZlOiBUaGUgY3VycmVudGx5IGFjdGl2ZSB2YWx1ZVxyXG4gICAqIC0gZm9jdXM6IFRoZSBjdXJyZW50bHkgZm9jdXNlZCB2YWx1ZVxyXG4gICAqIC0gc2VsZWN0OiBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aXRoIHRoZSBzZWxlY3RlZCB2YWx1ZVxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHJiQXV0b2NvbXBsZXRlTGlzdDogVGVtcGxhdGVSZWY8YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICogU2hvdWxkIHRoZSBkcm9wZG93biBvcGVuIG9uIGluaXRpYWwgY2xpY2sgd2l0aG91dCBhbnkgdmFsdWUgY2hhbmdlXHJcbiAgICovXHJcbiAgQElucHV0KCkgcmJJbml0aWFsT3BlbiA9IGZhbHNlO1xyXG5cclxuICBASW5wdXQoKSByYkRlYm91bmNlVGltZSA9IDUwMDtcclxuXHJcbiAgcHJpdmF0ZSBkZXN0cm95ID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgbG9hZGluZyA9IGZhbHNlO1xyXG5cclxuICBlcnJvciA9IG51bGw7XHJcblxyXG4gIHByaXZhdGUgaW5zdGFuY2U6IEZvcm1JbnB1dEF1dG9jb21wbGV0ZUxpc3RDb21wb25lbnQ7XHJcblxyXG4gIHByaXZhdGUgbGFzdFJlc3VsdCA9IG51bGw7XHJcblxyXG4gIHByaXZhdGUgZm9jdXMgPSBudWxsO1xyXG5cclxuICBwcml2YXRlIGlucHV0OiBGb3JtSW5wdXRDb21wb25lbnQgPSBudWxsO1xyXG5cclxuICBwcml2YXRlIG5vU2VhcmNoRm9yID0gbnVsbDtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgICAgICAgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZixcclxuICAgICAgICAgICAgICBAU2VsZigpIHByaXZhdGUgY29udHJvbDogTmdDb250cm9sLFxyXG4gICAgICAgICAgICAgIEBTZWxmKCkgQE9wdGlvbmFsKCkgQEluamVjdChOR19WQUxVRV9BQ0NFU1NPUikgaW5wdXRzOiBGb3JtSW5wdXRDb21wb25lbnRbXVxyXG4gICkge1xyXG4gICAgc3VwZXIoX2ZhY3RvcnlSZXNvbHZlciwgdmlld0NvbnRhaW5lclJlZik7XHJcbiAgICBpZiAoaW5wdXRzKSB7XHJcbiAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dHNbMF07XHJcbiAgICB9XHJcbiAgICB0aGlzLm9wZW5PbkNsaWNrID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG5cclxuICAgIGlmICh0aGlzLnJiSW5pdGlhbE9wZW4pIHtcclxuICAgICAgdGhpcy5vcGVuT25DbGljayA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0aGlzLnJiQXV0b2NvbXBsZXRlTGlzdCkge1xyXG4gICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5fZmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KEZvcm1JbnB1dEF1dG9jb21wbGV0ZUxpc3RDb21wb25lbnQpO1xyXG4gICAgICBjb25zdCBjb21wb25lbnQgPSBmYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgICAgdGhpcy5pbnN0YW5jZSA9IGNvbXBvbmVudC5pbnN0YW5jZTtcclxuICAgICAgdGhpcy5yYkF1dG9jb21wbGV0ZUxpc3QgPSBjb21wb25lbnQuaW5zdGFuY2UudGVtcGxhdGU7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy50ZW1wbGF0ZSA9IHRoaXMucmJBdXRvY29tcGxldGVMaXN0O1xyXG5cclxuICAgIHRoaXMudXBkYXRlTG9hZGluZyhmYWxzZSwgbnVsbCk7XHJcblxyXG4gICAgbGV0IGNoYW5nZXMgPSAwO1xyXG4gICAgbGV0IHJlc29sdmVkVmFsdWUgPSBudWxsO1xyXG4gICAgdGhpcy5jb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKFxyXG4gICAgICBkZWJvdW5jZVRpbWUodGhpcy5yYkRlYm91bmNlVGltZSksXHJcbiAgICAgIHN3aXRjaE1hcCh2YWx1ZSA9PiB7XHJcbiAgICAgICAgY2hhbmdlcysrO1xyXG4gICAgICAgIGlmIChjaGFuZ2VzID09PSAxICYmICF0aGlzLnJiSW5pdGlhbE9wZW4gfHwgcmVzb2x2ZWRWYWx1ZSA9PT0gdmFsdWUgfHwgdGhpcy5ub1NlYXJjaEZvciA9PT0gdmFsdWUpIHtcclxuICAgICAgICAgIHJldHVybiBORVZFUjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVzb2x2ZWRWYWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgIHRoaXMudXBkYXRlTG9hZGluZyh0cnVlLCBudWxsKTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJiRm9ybUlucHV0QXV0b2NvbXBsZXRlKHZhbHVlKTtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVzdWx0LnBpcGUoXHJcbiAgICAgICAgICAgIHRhcChcclxuICAgICAgICAgICAgICAoKSA9PiB0aGlzLnVwZGF0ZUxvYWRpbmcoZmFsc2UsIG51bGwpLFxyXG4gICAgICAgICAgICAgIGVyciA9PiB0aGlzLnVwZGF0ZUxvYWRpbmcoZmFsc2UsIGVyciksXHJcbiAgICAgICAgICAgICAgKCkgPT4gdGhpcy51cGRhdGVMb2FkaW5nKGZhbHNlLCBudWxsKSksXHJcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IG9mKG51bGwpKSxcclxuICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMuY29udHJvbC52YWx1ZUNoYW5nZXMucGlwZShza2lwKDEpKSlcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMudXBkYXRlTG9hZGluZyhmYWxzZSwgbnVsbCk7XHJcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSlcclxuICAgICkuc3Vic2NyaWJlKHJlc3VsdHMgPT4ge1xyXG4gICAgICB0aGlzLm9wZW5PbkNsaWNrID0gdHJ1ZTtcclxuICAgICAgdGhpcy5sYXN0UmVzdWx0ID0gcmVzdWx0cztcclxuICAgICAgaWYgKHJlc3VsdHMgIT09IG51bGwgJiYgIXJlc3VsdHMuaW5jbHVkZXMocmVzb2x2ZWRWYWx1ZSkpIHtcclxuICAgICAgICB0aGlzLmZvY3VzID0gbnVsbDtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnVwZGF0ZUNvbnRleHQodGhpcy5jb250cm9sLnZhbHVlKTtcclxuICAgICAgaWYgKHJlc3VsdHMgIT09IG51bGwgJiYgKCF0aGlzLmNvbXBvbmVudFJlZiB8fCAhdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2Uuc2hvd24pICYmIGNoYW5nZXMgPiAxKSB7XHJcbiAgICAgICAgdGhpcy5vcGVuRHJvcGRvd24oKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAocmVzdWx0cyA9PT0gbnVsbCkge1xyXG4gICAgICAgIHRoaXMuY2xvc2VEcm9wZG93bigpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5pbnB1dCAmJiB0aGlzLmlucHV0LmlucHV0KSB7XHJcbiAgICAgIHRoaXMuaW5wdXQuaW5wdXQubmF0aXZlRWxlbWVudC5hdXRvY29tcGxldGUgPSAnb2ZmJztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVwZGF0ZUxvYWRpbmcobG9hZGluZzogYm9vbGVhbiwgZXJyb3I6IGFueSkge1xyXG4gICAgdGhpcy5sb2FkaW5nID0gbG9hZGluZztcclxuICAgIHRoaXMuZXJyb3IgPSBlcnJvcjtcclxuICAgIGlmICh0aGlzLmVycm9yKSB7XHJcbiAgICAgIGNvbnN0IGVycm9ycyA9IHRoaXMuY29udHJvbC5lcnJvcnMgfHwge307XHJcbiAgICAgIGVycm9yc1snYXV0b2NvbXBsZXRlJ10gPSB0aGlzLmVycm9yO1xyXG4gICAgICB0aGlzLmNvbnRyb2wuY29udHJvbC5zZXRFcnJvcnMoZXJyb3JzKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmlucHV0ICYmIHRoaXMubG9hZGluZykge1xyXG4gICAgICB0aGlzLmlucHV0LnVwZGF0ZUljb24oJ3JiLWljIHJiLWljLXNwaW4gcmItaWMtcmVmcmVzaCcpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuaW5wdXQgJiYgIXRoaXMubG9hZGluZykge1xyXG4gICAgICB0aGlzLmlucHV0LnVwZGF0ZUljb24odGhpcy5yYkluaXRpYWxPcGVuID8gJ3NlbGVjdC1pY29uIHJiLWljIHJiLWljLWRvd24nIDogbnVsbCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5pbnB1dCAmJiB0aGlzLmVycm9yKSB7XHJcbiAgICAgIHRoaXMuaW5wdXQudXBkYXRlSWNvbigncmItaWMgcmItaWMtYWxlcnQtd2FybmluZyB1LVRleHRDb2xvci0tcmVkJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZWxlY3QodmFsdWU6IHN0cmluZykge1xyXG4gICAgdGhpcy5ub1NlYXJjaEZvciA9IHZhbHVlO1xyXG4gICAgdGhpcy5jb250cm9sLmNvbnRyb2wuc2V0VmFsdWUodmFsdWUpO1xyXG4gICAgdGhpcy5mb2N1cyA9IHZhbHVlO1xyXG4gICAgdGhpcy5jbG9zZURyb3Bkb3duKCk7XHJcbiAgICB0aGlzLnVwZGF0ZUNvbnRleHQodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcigna2V5dXAnLCBbJyRldmVudCddKVxyXG4gIG9uS2V5VXAoZTogS2V5Ym9hcmRFdmVudCkge1xyXG4gICAgaWYgKGUua2V5ID09PSAnQXJyb3dEb3duJyB8fCBlLmtleSA9PT0gJ0Rvd24nKSB7XHJcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgdGhpcy5tb3ZlRm9jdXMoMSk7XHJcbiAgICB9XHJcbiAgICBpZiAoZS5rZXkgPT09ICdBcnJvd1VwJyB8fCBlLmtleSA9PT0gJ1VwJykge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIHRoaXMubW92ZUZvY3VzKC0xKTtcclxuICAgIH1cclxuICAgIGlmIChlLmtleSA9PT0gJ0VudGVyJyAmJiB0aGlzLmNvbXBvbmVudFJlZiAmJiB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5zaG93bikge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIHRoaXMuc2VsZWN0KHRoaXMuZm9jdXMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBtb3ZlRm9jdXMoYnk6IG51bWJlcikge1xyXG4gICAgY29uc3QgbGlzdCA9IHRoaXMubGFzdFJlc3VsdCB8fCBbXTtcclxuICAgIGlmICghbGlzdC5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5mb2N1cyA9IG51bGw7XHJcbiAgICAgIHRoaXMudXBkYXRlQ29udGV4dCh0aGlzLmNvbnRyb2wudmFsdWUpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgZm9jdXNJbmRleCA9IGxpc3QuaW5kZXhPZih0aGlzLmZvY3VzKTtcclxuICAgIGlmIChmb2N1c0luZGV4ID09PSAtMSkge1xyXG4gICAgICBmb2N1c0luZGV4ID0gMDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZvY3VzSW5kZXggKz0gYnk7XHJcbiAgICAgIGlmIChmb2N1c0luZGV4ID09PSAtMSkge1xyXG4gICAgICAgIGZvY3VzSW5kZXggPSBsaXN0Lmxlbmd0aCAtIDE7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGZvY3VzSW5kZXggPT09IGxpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgZm9jdXNJbmRleCA9IDA7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmZvY3VzID0gbGlzdFtmb2N1c0luZGV4XTtcclxuICAgIHRoaXMudXBkYXRlQ29udGV4dCh0aGlzLmNvbnRyb2wudmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVDb250ZXh0KHZhbHVlKSB7XHJcbiAgICB0aGlzLmNvbnRleHQgPSB7XHJcbiAgICAgIGxpc3Q6IHRoaXMubGFzdFJlc3VsdCxcclxuICAgICAgYWN0aXZlOiB2YWx1ZSxcclxuICAgICAgZm9jdXM6IHRoaXMuZm9jdXMsXHJcbiAgICAgIHNlbGVjdDogdGhpcy5zZWxlY3QuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgc3VwZXIubmdPbkRlc3Ryb3koKTtcclxuICAgIHRoaXMuZGVzdHJveS5jb21wbGV0ZSgpO1xyXG4gICAgdGhpcy5pbnB1dCA9IG51bGw7XHJcbiAgfVxyXG59XHJcbiJdfQ==